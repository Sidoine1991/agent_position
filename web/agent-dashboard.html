<!doctype html>
<html lang="fr">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="manifest" href="/manifest.webmanifest" />
    <meta name="theme-color" content="#0ea5e9" />
    <title>Mon Tableau de Bord - Presence CCRB</title>
    <script src="/auth.js?v=2" defer></script>
    <!-- Import du SDK Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- Configuration Supabase -->
    <script src="/js/supabase-config.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link rel="stylesheet" href="/styles.css?v=2" />
    <link rel="stylesheet" href="/contrast-fixes.css" />
    <style>
      .dashboard-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 30px 0;
        margin-bottom: 30px;
        border-radius: 0 0 20px 20px;
      }
      
      .agent-avatar {
        width: 80px;
        height: 80px;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.2);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 32px;
        font-weight: bold;
        margin: 0 auto 15px;
      }
      
      .dashboard-section {
        background: white;
        border-radius: 15px;
        padding: 25px;
        margin-bottom: 25px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
      }
      
      .section-title {
        color: #333;
        font-weight: 600;
        margin-bottom: 20px;
        display: flex;
        align-items: center;
        gap: 10px;
      }
      
      .goal-card {
        background: #f8f9fa;
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 15px;
        border-left: 4px solid #007bff;
      }
      
      .goal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
      }
      
      .goal-status {
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 600;
        text-transform: uppercase;
      }
      
      .goal-status.active {
        background: #e3f2fd;
        color: #1976d2;
      }
      
      .goal-status.completed {
        background: #e8f5e8;
        color: #2e7d32;
      }
      
      .goal-progress {
        margin-bottom: 15px;
      }
      
      .goal-numbers {
        display: flex;
        justify-content: space-between;
        margin-top: 8px;
        font-size: 14px;
        color: #666;
      }
      
      .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
      }
      
      .stat-card {
        text-align: center;
        padding: 25px;
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        border-radius: 15px;
        border: 2px solid transparent;
        transition: all 0.3s ease;
      }
      
      .stat-card:hover {
        transform: translateY(-5px);
        border-color: #007bff;
        box-shadow: 0 8px 25px rgba(0, 123, 255, 0.15);
      }
      
      .stat-icon {
        font-size: 32px;
        margin-bottom: 15px;
      }
      
      .stat-value {
        font-size: 28px;
        font-weight: 700;
        color: #333;
        margin-bottom: 8px;
      }
      
      .stat-label {
        color: #666;
        font-size: 14px;
        font-weight: 500;
      }
      
      .badges-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
        gap: 15px;
      }
      
      .badge-card {
        text-align: center;
        padding: 20px;
        border-radius: 12px;
        border: 2px solid #dee2e6;
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
      }
      
      .badge-card.earned {
        background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
        border-color: #ffc107;
        transform: scale(1.05);
      }
      
      .badge-card.locked {
        background: #f8f9fa;
        opacity: 0.6;
        filter: grayscale(100%);
      }
      
      .badge-card.earned::before {
        content: '';
        position: absolute;
        top: -50%;
        left: -50%;
        width: 200%;
        height: 200%;
        background: linear-gradient(45deg, transparent, rgba(255, 255, 255, 0.3), transparent);
        animation: shine 2s infinite;
      }
      
      @keyframes shine {
        0% { transform: translateX(-100%) translateY(-100%) rotate(45deg); }
        100% { transform: translateX(100%) translateY(100%) rotate(45deg); }
      }
      
      .badge-icon {
        font-size: 40px;
        margin-bottom: 10px;
      }
      
      .badge-name {
        font-weight: 600;
        margin-bottom: 8px;
        color: #333;
      }
      
      .badge-description {
        font-size: 12px;
        color: #666;
        margin-bottom: 8px;
      }
      
      .badge-date {
        font-size: 10px;
        color: #28a745;
        font-weight: 600;
      }
      
      .achievement-item {
        display: flex;
        align-items: center;
        gap: 15px;
        padding: 15px;
        background: #f8f9fa;
        border-radius: 10px;
        margin-bottom: 10px;
        border-left: 4px solid #28a745;
      }
      
      .achievement-icon {
        font-size: 24px;
        width: 40px;
        text-align: center;
      }
      
      .achievement-content {
        flex: 1;
      }
      
      .achievement-title {
        font-weight: 600;
        color: #333;
        margin-bottom: 4px;
      }
      
      .achievement-description {
        font-size: 14px;
        color: #666;
        margin-bottom: 4px;
      }
      
      .achievement-date {
        font-size: 12px;
        color: #999;
      }
      
      .leaderboard-item {
        display: flex;
        align-items: center;
        gap: 15px;
        padding: 15px;
        background: #f8f9fa;
        border-radius: 10px;
        margin-bottom: 10px;
        transition: all 0.3s ease;
      }
      
      .leaderboard-item:hover {
        background: #e9ecef;
        transform: translateX(5px);
      }
      
      .leaderboard-item.current-agent {
        background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
        border: 2px solid #2196f3;
        font-weight: 600;
      }
      
      .rank {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: #007bff;
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 700;
        font-size: 16px;
      }
      
      .leaderboard-item.current-agent .rank {
        background: #ffc107;
        color: #333;
      }
      
      .agent-name {
        flex: 1;
        font-weight: 600;
        color: #333;
      }
      
      .agent-score {
        font-weight: 700;
        color: #007bff;
        font-size: 18px;
      }
      
      .agent-details {
        font-size: 12px;
        color: #666;
      }
      
      .performance-chart {
        height: 200px;
        background: #f8f9fa;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #666;
        font-style: italic;
      }
      
      .motivation-quote {
        background: rgba(255, 255, 255, 0.1);
        padding: 20px;
        border-radius: 10px;
        margin-top: 20px;
        max-width: 350px;
        margin-left: auto;
        min-height: 150px;
        display: flex;
        flex-direction: column;
        justify-content: center;
      }
      
      .quote-text {
        font-style: italic;
        margin-bottom: 10px;
        font-size: 0.95rem;
        line-height: 1.4;
      }
      
      .quote-author {
        font-size: 0.85rem;
        opacity: 0.9;
        font-weight: 500;
      }
      
      @media (max-width: 768px) {
        .motivation-quote {
          max-width: 100%;
          margin: 20px 0 0 0;
        }
      }
    </style>
  </head>
  <body>
    <!-- Barre de navigation circulaire -->
    <script src="/js/circular-nav-component.js"></script>
    <circular-nav></circular-nav>

    <!-- Main Content -->
    <main class="main-content">
      <!-- En-t√™te du tableau de bord -->
      <div class="dashboard-header">
        <div class="container">
          <div class="row align-items-center">
            <div class="col-md-8">
              <div class="agent-avatar" id="agent-avatar">
                A
              </div>
              <h2 id="agent-name">Agent</h2>
              <p id="agent-role" class="mb-0">R√¥le</p>
            </div>
            <div class="col-md-4 text-end">
              <div class="motivation-quote">
                <div class="quote-text" id="motivation-quote">
                  "L'excellence n'est jamais un accident. C'est toujours le r√©sultat d'une intention √©lev√©e, d'un effort sinc√®re et d'une ex√©cution intelligente."
                </div>
                <div class="quote-author">- Aristote</div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="container">
        <!-- Section des objectifs -->
        <div class="dashboard-section">
          <h3 class="section-title">
            <i class="bi bi-bullseye"></i>
            Mes Objectifs
          </h3>
          <div id="goals-container">
            <!-- Les objectifs seront charg√©s ici -->
          </div>
        </div>

        <!-- Section de pr√©sence journali√®re -->
        <div class="dashboard-section">
          <h3 class="section-title">
            <i class="bi bi-calendar-check"></i>
            Ma Pr√©sence
          </h3>
          <div class="mb-3">
            <label for="date-select" class="form-label">S√©lectionner une date :</label>
            <input type="date" id="date-select" class="form-control" style="max-width: 250px;">
          </div>
          <div id="presence-details">
            <div class="text-center py-4">
              <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Chargement...</span>
              </div>
              <p class="mt-2">Chargement de vos informations de pr√©sence...</p>
            </div>
          </div>
        </div>

        <!-- Section des statistiques -->
        <div class="dashboard-section">
          <h3 class="section-title">
            <i class="bi bi-graph-up"></i>
            √âvolution de ma pr√©sence
          </h3>
          <div class="mb-3">
            <label for="period-select" class="form-label">P√©riode :</label>
            <select id="period-select" class="form-select" style="max-width: 200px;">
              <option value="7">7 derniers jours</option>
              <option value="14">14 derniers jours</option>
              <option value="30" selected>30 derniers jours</option>
            </select>
          </div>
          <div class="chart-container" style="position: relative; height:300px;">
            <canvas id="presenceChart"></canvas>
          </div>
          
          <div class="mt-4" id="stats-container">
            <!-- Les autres statistiques seront charg√©es ici -->
          </div>
        </div>

        <div class="row">
          <!-- Section des badges -->
          <div class="col-md-6">
            <div class="dashboard-section">
              <h3 class="section-title">
                <i class="bi bi-award"></i>
                Mes Badges
              </h3>
              <div id="badges-container" class="badges-grid">
                <!-- Les badges seront charg√©s ici -->
              </div>
            </div>
          </div>

          <!-- Section des r√©alisations -->
          <div class="col-md-6">
            <div class="dashboard-section">
              <h3 class="section-title">
                <i class="bi bi-trophy"></i>
                Mes R√©alisations
              </h3>
              <div id="achievements-container">
                <!-- Les r√©alisations seront charg√©es ici -->
              </div>
            </div>
          </div>
        </div>

        <!-- Section du classement -->
        <div class="dashboard-section">
          <h3 class="section-title">
            <i class="bi bi-trophy-fill"></i>
            Classement de l'√âquipe
          </h3>
          <div id="leaderboard-container">
            <!-- Le classement sera charg√© ici -->
          </div>
        </div>

        <!-- Section des performances -->
        <div class="dashboard-section">
          <h3 class="section-title">
            <i class="bi bi-speedometer2"></i>
            Mes Performances
          </h3>
          <div id="performance-container">
            <!-- Les m√©triques de performance seront charg√©es ici -->
          </div>
        </div>
      </div>
    </main>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
    <!-- Int√©gration de Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="/js/supabase-config.js"></script>
    <script src="/app.js"></script>
    <script>
      // Citations de motivation
      const motivationQuotes = [
        {
          text: "L'excellence n'est jamais un accident. C'est toujours le r√©sultat d'une intention √©lev√©e, d'un effort sinc√®re et d'une ex√©cution intelligente.",
          author: "Aristote"
        },
        {
          text: "Le succ√®s n'est pas final, l'√©chec n'est pas fatal : c'est le courage de continuer qui compte.",
          author: "Winston Churchill"
        },
        {
          text: "La seule fa√ßon de faire du bon travail est d'aimer ce que vous faites.",
          author: "Steve Jobs"
        },
        {
          text: "L'avenir appartient √† ceux qui croient en la beaut√© de leurs r√™ves.",
          author: "Eleanor Roosevelt"
        },
        {
          text: "Le succ√®s est la somme de petits efforts r√©p√©t√©s jour apr√®s jour.",
          author: "Robert Collier"
        }
      ];

      // R√©cup√©rer les informations de l'utilisateur depuis Supabase
      async function getUserProfile() {
        try {
          // R√©cup√©rer l'utilisateur connect√©
          const { data: { user }, error: authError } = await supabase.auth.getUser();
          
          if (authError || !user) {
            console.error('Erreur d\'authentification:', authError);
            window.location.href = '/login.html';
            return null;
          }

          // R√©cup√©rer les informations suppl√©mentaires de l'utilisateur
          const { data: userData, error: userError } = await supabase
            .from('user')  // Utilisation de la table 'user' au lieu de 'users'
            .select('*')
            .eq('id', user.id)
            .single();

          if (userError) {
            console.error('Erreur lors de la r√©cup√©ration des donn√©es utilisateur:', userError);
            // Retourner au moins les informations de base de l'authentification
            return { 
              ...user, 
              first_name: user.user_metadata?.first_name || '',
              last_name: user.user_metadata?.last_name || '',
              role: user.user_metadata?.role || 'agent'
            };
          }

          // Fusionner les donn√©es d'authentification et les donn√©es utilisateur
          return { 
            ...user, 
            ...userData,
            // S'assurer que les champs essentiels ont des valeurs par d√©faut
            first_name: userData.first_name || user.user_metadata?.first_name || '',
            last_name: userData.last_name || user.user_metadata?.last_name || '',
            role: userData.role || user.user_metadata?.role || 'agent'
          };
        } catch (error) {
          console.error('Erreur inattendue dans getUserProfile:', error);
          return null;
        }
      }

      // Initialiser la page du tableau de bord
      document.addEventListener('DOMContentLoaded', () => {
        initializeDashboardPage();
      });

      function initializeDashboardPage() {
        // Attendre que le tableau de bord agent soit initialis√©
        if (!window.agentDashboard) {
          setTimeout(initializeDashboardPage, 100);
          return;
        }

        loadAgentInfo();
        renderDashboard();
        setupEventListeners();
        startMotivationRotation();
      }

      async function loadAgentInfo() {
        try {
          console.log('Chargement des informations de l\'utilisateur...');
          const user = await getUserProfile();
          
          if (!user) {
            console.error('Aucun utilisateur connect√©');
            return;
          }

          console.log('Donn√©es utilisateur r√©cup√©r√©es:', user);

          // Mettre √† jour l'avatar
          const avatar = document.getElementById('agent-avatar');
          if (avatar) {
            const firstName = user.first_name || '';
            const lastName = user.last_name || '';
            const initials = (firstName.charAt(0) + lastName.charAt(0)).toUpperCase();
            avatar.textContent = initials || user.email?.charAt(0).toUpperCase() || 'A';
          }

          // Mettre √† jour le nom
          const nameElement = document.getElementById('agent-name');
          if (nameElement) {
            const fullName = [user.first_name, user.last_name]
              .filter(Boolean)
              .join(' ')
              .trim();
            
            if (fullName) {
              nameElement.textContent = fullName;
            } else if (user.email) {
              nameElement.textContent = user.email.split('@')[0];
            } else {
              nameElement.textContent = 'Utilisateur';
            }
          }

          // Mettre √† jour le r√¥le
          const roleElement = document.getElementById('agent-role');
          if (roleElement) {
            const roleNames = {
              'agent': 'Agent de Terrain',
              'superviseur': 'Superviseur',
              'admin': 'Administrateur',
              'superadmin': 'Super Administrateur'
            };
            
            const userRole = user.role || 'agent';
            roleElement.textContent = roleNames[userRole] || 'Utilisateur';
          }
        } catch (error) {
          console.error('Erreur lors du chargement des informations utilisateur:', error);
          
          // Afficher un message d'erreur √† l'utilisateur
          const nameElement = document.getElementById('agent-name');
          if (nameElement) {
            nameElement.textContent = 'Erreur de chargement';
          }
          
          const roleElement = document.getElementById('agent-role');
          if (roleElement) {
            roleElement.textContent = 'Veuillez rafra√Æchir la page';
          }
        }
      }

      function renderDashboard() {
        window.agentDashboard.renderDashboard();
      }

      function setupEventListeners() {
        // √âcouter les mises √† jour des statistiques
        document.addEventListener('agentStatsUpdated', () => {
          renderDashboard();
        });

        // √âcouter les nouveaux badges
        document.addEventListener('badgeEarned', (event) => {
          const badge = event.detail.badge;
          showBadgeCelebration(badge);
          renderDashboard();
        });

        // √âcouter les nouvelles r√©alisations
        document.addEventListener('achievementAdded', (event) => {
          const achievement = event.detail.achievement;
          showAchievementNotification(achievement);
          renderDashboard();
        });
      }

      function showBadgeCelebration(badge) {
        // Cr√©er une animation de c√©l√©bration pour le badge
        const celebration = document.createElement('div');
        celebration.className = 'badge-celebration';
        celebration.innerHTML = `
          <div class="celebration-content">
            <div class="celebration-icon">${badge.icon}</div>
            <div class="celebration-text">
              <h4>üèÜ Nouveau Badge!</h4>
              <p>${badge.name}</p>
            </div>
          </div>
        `;

        // Styles CSS pour l'animation
        celebration.style.cssText = `
          position: fixed;
          top: 50%;
          left: 50%;
          transform: translate(-50%, -50%);
          background: linear-gradient(135deg, #ffc107, #ff9800);
          color: white;
          padding: 30px;
          border-radius: 20px;
          box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
          z-index: 10000;
          animation: badgeCelebration 3s ease-in-out;
        `;

        const style = document.createElement('style');
        style.textContent = `
          @keyframes badgeCelebration {
            0% { transform: translate(-50%, -50%) scale(0); opacity: 0; }
            50% { transform: translate(-50%, -50%) scale(1.1); opacity: 1; }
            100% { transform: translate(-50%, -50%) scale(1); opacity: 0; }
          }
          .celebration-content {
            text-align: center;
          }
          .celebration-icon {
            font-size: 48px;
            margin-bottom: 15px;
          }
          .celebration-text h4 {
            margin: 0 0 10px 0;
            font-size: 24px;
          }
          .celebration-text p {
            margin: 0;
            font-size: 18px;
            font-weight: 600;
          }
        `;
        document.head.appendChild(style);

        document.body.appendChild(celebration);

        // Supprimer apr√®s 3 secondes
        setTimeout(() => {
          if (document.body.contains(celebration)) {
            document.body.removeChild(celebration);
          }
        }, 3000);
      }

      function showAchievementNotification(achievement) {
        // Afficher une notification pour la nouvelle r√©alisation
        if (window.notificationManager) {
          window.notificationManager.sendNotification('üéâ Nouvelle R√©alisation!', {
            body: achievement.title,
            tag: 'achievement',
            requireInteraction: true
          });
        }
      }

      function startMotivationRotation() {
        const quoteElement = document.getElementById('motivation-quote');
        const authorElement = document.querySelector('.quote-author');
        let currentQuoteIndex = 0;
        
        function showNextQuote() {
          quoteElement.innerHTML = `
            <div class="quote-text">"${quote.text}"</div>
            <div class="quote-author">- ${quote.author}</div>
          `;
          currentQuoteIndex = (currentQuoteIndex + 1) % motivationQuotes.length;
        }

        // Mettre √† jour la citation toutes les 30 secondes
        setInterval(updateQuote, 30000);
        
        // Mettre √† jour imm√©diatement
        updateQuote();
      }

      // Fonction pour rafra√Æchir le tableau de bord
      function refreshDashboard() {
        window.agentDashboard.loadAgentData().then(() => {
          renderDashboard();
        });
      }

      // Exposer la fonction globalement
      window.refreshDashboard = refreshDashboard;
    </script>
    <!-- Script pour g√©rer les pr√©sences -->
    <script>
      // Fonction pour formater une date au format JJ/MM/AAAA
      function formatDate(date) {
        const d = new Date(date);
        const day = String(d.getDate()).padStart(2, '0');
        const month = String(d.getMonth() + 1).padStart(2, '0');
        const year = d.getFullYear();
        return `${day}/${month}/${year}`;
      }

      // Fonction pour formater une heure au format HH:MM
      function formatTime(date) {
        if (!date) return '--:--';
        const d = new Date(date);
        return d.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });
      }

      // Fonction pour calculer la dur√©e entre deux dates
      function calculateDuration(start, end) {
        if (!start || !end) return '--:--';
        
        const startDate = new Date(start);
        const endDate = new Date(end);
        const diffMs = endDate - startDate;
        
        // Convertir en heures et minutes
        const diffMins = Math.floor((diffMs / 1000) / 60);
        const hours = Math.floor(diffMins / 60);
        const minutes = diffMins % 60;
        
        return `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}`;
      }

      // Fonction pour r√©cup√©rer les pr√©sences de l'agent
      async function fetchAgentPresence(selectedDate) {
        try {
          // R√©cup√©rer l'utilisateur connect√©
          const { data: { user }, error: userError } = await supabase.auth.getUser();
          
          if (userError || !user) {
            console.error('Erreur d\'authentification:', userError);
            return [];
          }

          // Convertir la date s√©lectionn√©e en format YYYY-MM-DD
          const dateStr = selectedDate.toISOString().split('T')[0];
          
          // Calculer le d√©but et la fin de la journ√©e s√©lectionn√©e
          const startDate = new Date(selectedDate);
          startDate.setHours(0, 0, 0, 0);
          
          const endDate = new Date(selectedDate);
          endDate.setHours(23, 59, 59, 999);
          
          // R√©cup√©rer les pr√©sences de l'agent pour la journ√©e s√©lectionn√©e
          const { data: presences, error } = await supabase
            .from('presences')
            .select('*')
            .eq('user_id', user.id)
            .gte('date_entree', startDate.toISOString())
            .lte('date_entree', endDate.toISOString())
            .order('date_entree', { ascending: true });
          
          if (error) throw error;
          
          return presences || [];
          
        } catch (error) {
          console.error('Erreur lors de la r√©cup√©ration des pr√©sences:', error);
          showError('Erreur lors du chargement des donn√©es de pr√©sence');
          return [];
        }
      }

      // Fonction pour afficher les d√©tails de pr√©sence
      async function displayPresenceDetails(date) {
        const container = document.getElementById('presence-details');
        if (!container) return;
        
        // Afficher le chargement
        container.innerHTML = `
          <div class="text-center py-4">
            <div class="spinner-border text-primary" role="status">
              <span class="visually-hidden">Chargement...</span>
            </div>
            <p class="mt-2">Chargement de vos informations de pr√©sence...</p>
          </div>
        `;
        
        try {
          const presences = await fetchAgentPresence(date);
          
          if (presences.length === 0) {
            container.innerHTML = `
              <div class="alert alert-info">
                <i class="bi bi-info-circle me-2"></i>
                Aucune pr√©sence enregistr√©e pour le ${formatDate(date)}.
              </div>
            `;
            return;
          }
          
          // Calculer le temps total de pr√©sence
          let totalMinutes = 0;
          const presenceItems = presences.map(presence => {
            const entryTime = new Date(presence.date_entree);
            const exitTime = presence.date_sortie ? new Date(presence.date_sortie) : null;
            const duration = exitTime ? Math.floor((exitTime - entryTime) / (1000 * 60)) : 0; // en minutes
            totalMinutes += duration;
            
            return `
              <div class="card mb-3">
                <div class="card-body">
                  <div class="row">
                    <div class="col-md-4">
                      <div class="d-flex align-items-center mb-2">
                        <i class="bi bi-box-arrow-in-right me-2 text-success"></i>
                        <div>
                          <div class="text-muted small">Entr√©e</div>
                          <div>${formatTime(entryTime)}</div>
                        </div>
                      </div>
                    </div>
                    <div class="col-md-4">
                      <div class="d-flex align-items-center mb-2">
                        <i class="bi bi-box-arrow-right me-2 text-danger"></i>
                        <div>
                          <div class="text-muted small">Sortie</div>
                          <div>${formatTime(exitTime)}</div>
                        </div>
                      </div>
                    </div>
                    <div class="col-md-4">
                      <div class="d-flex align-items-center">
                        <i class="bi bi-clock-history me-2 text-primary"></i>
                        <div>
                          <div class="text-muted small">Dur√©e</div>
                          <div>${Math.floor(duration / 60)}h${String(duration % 60).padStart(2, '0')}</div>
                        </div>
                      </div>
                    </div>
                  </div>
                  ${presence.notes ? `
                    <div class="mt-2">
                      <div class="text-muted small">Notes :</div>
                      <div>${presence.notes}</div>
                    </div>
                  ` : ''}
                </div>
              </div>
            `;
          }).join('');
          
          const totalHours = Math.floor(totalMinutes / 60);
          const remainingMinutes = totalMinutes % 60;
          
          container.innerHTML = `
            <div class="mb-4">
              <div class="d-flex justify-content-between align-items-center">
                <h5 class="mb-0">R√©sum√© du ${formatDate(date)}</h5>
                <div class="badge bg-primary">
                  <i class="bi bi-clock me-1"></i>
                  Total : ${totalHours}h${String(remainingMinutes).padStart(2, '0')}
                </div>
              </div>
              <hr class="mt-2">
            </div>
            ${presenceItems}
          `;
          
        } catch (error) {
          console.error('Erreur lors de l\'affichage des pr√©sences:', error);
          container.innerHTML = `
            <div class="alert alert-danger">
              <i class="bi bi-exclamation-triangle me-2"></i>
              Une erreur est survenue lors du chargement des donn√©es de pr√©sence.
            </div>
          `;
        }
      }

      // Fonction pour afficher un message d'erreur
      function showError(message) {
        const container = document.getElementById('presence-details');
        if (container) {
          container.innerHTML = `
            <div class="alert alert-danger">
              <i class="bi bi-exclamation-triangle me-2"></i>
              ${message}
            </div>
          `;
        }
      }

      // Variables globales pour le graphique
      let presenceChart = null;

      // Fonction pour formater une date au format JJ/MM
      function formatShortDate(date) {
        const d = new Date(date);
        const day = String(d.getDate()).padStart(2, '0');
        const month = String(d.getMonth() + 1).padStart(2, '0');
        return `${day}/${month}`;
      }

      // Fonction pour calculer la dur√©e en heures entre deux dates
      function calculateHours(start, end) {
        if (!start || !end) return 0;
        const diffMs = new Date(end) - new Date(start);
        return (diffMs / (1000 * 60 * 60)).toFixed(2);
      }

      // Fonction pour r√©cup√©rer les donn√©es de pr√©sence sur une p√©riode
      async function fetchPresenceData(days) {
        try {
          // R√©cup√©rer l'utilisateur connect√©
          const { data: { user }, error: userError } = await supabase.auth.getUser();
          
          if (userError || !user) {
            throw new Error('Utilisateur non connect√©');
          }

          // Calculer la date de d√©but (il y a X jours)
          const endDate = new Date();
          const startDate = new Date();
          startDate.setDate(endDate.getDate() - days);
          
          // Formater les dates pour la requ√™te
          const startDateStr = startDate.toISOString().split('T')[0];
          const endDateStr = endDate.toISOString().split('T')[0];
          
          // R√©cup√©rer les pr√©sences de l'agent pour la p√©riode
          const { data: presences, error } = await supabase
            .from('presences')
            .select('*')
            .eq('user_id', user.id)
            .gte('date_entree', `${startDateStr}T00:00:00.000Z`)
            .lte('date_entree', `${endDateStr}T23:59:59.999Z`)
            .order('date_entree', { ascending: true });
          
          if (error) throw error;
          
          // Grouper les pr√©sences par jour et calculer la dur√©e totale par jour
          const dailyData = {};
          
          // Initialiser les jours avec 0 heure
          for (let d = new Date(startDate); d <= endDate; d.setDate(d.getDate() + 1)) {
            const dateKey = formatShortDate(d);
            dailyData[dateKey] = 0;
          }
          
          // Calculer les heures par jour
          presences.forEach(presence => {
            const date = new Date(presence.date_entree);
            const dateKey = formatShortDate(date);
            const hours = calculateHours(presence.date_entree, presence.date_sortie || new Date());
            dailyData[dateKey] = (parseFloat(dailyData[dateKey] || 0) + parseFloat(hours)).toFixed(2);
          });
          
          // Convertir en tableaux pour le graphique
          const labels = Object.keys(dailyData);
          const data = Object.values(dailyData);
          
          return { labels, data };
          
        } catch (error) {
          console.error('Erreur lors de la r√©cup√©ration des donn√©es de pr√©sence:', error);
          return { labels: [], data: [] };
        }
      }

      // Fonction pour initialiser le graphique
      async function initPresenceChart() {
        const periodSelect = document.getElementById('period-select');
        const days = parseInt(periodSelect.value, 10);
        
        // Afficher un indicateur de chargement
        const chartContainer = document.querySelector('.chart-container');
        chartContainer.innerHTML = '<div class="text-center py-4"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Chargement...</span></div><p class="mt-2">Chargement des donn√©es de pr√©sence...</p></div>';
        
        // R√©cup√©rer les donn√©es
        const { labels, data } = await fetchPresenceData(days);
        
        // Cr√©er le canvas pour le graphique
        chartContainer.innerHTML = '<canvas id="presenceChart"></canvas>';
        const ctx = document.getElementById('presenceChart').getContext('2d');
        
        // D√©truire l'instance pr√©c√©dente du graphique si elle existe
        if (presenceChart) {
          presenceChart.destroy();
        }
        
        // Cr√©er le graphique
        presenceChart = new Chart(ctx, {
          type: 'line',
          data: {
            labels: labels,
            datasets: [{
              label: 'Heures de pr√©sence',
              data: data,
              backgroundColor: 'rgba(102, 126, 234, 0.2)',
              borderColor: 'rgba(102, 126, 234, 1)',
              borderWidth: 2,
              tension: 0.3,
              fill: true,
              pointBackgroundColor: 'rgba(255, 255, 255, 1)',
              pointBorderColor: 'rgba(102, 126, 234, 1)',
              pointBorderWidth: 2,
              pointRadius: 4,
              pointHoverRadius: 6
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                display: true,
                position: 'top',
              },
              tooltip: {
                callbacks: {
                  label: function(context) {
                    return `${context.parsed.y} heures`;
                  }
                }
              }
            },
            scales: {
              y: {
                beginAtZero: true,
                title: {
                  display: true,
                  text: 'Heures de pr√©sence',
                  font: {
                    weight: 'bold'
                  }
                },
                ticks: {
                  stepSize: 1,
                  callback: function(value) {
                    return value + 'h';
                  }
                }
              },
              x: {
                title: {
                  display: true,
                  text: 'Date',
                  font: {
                    weight: 'bold'
                  }
                }
              }
            }
          }
        });
      }

      // Initialiser la page
      document.addEventListener('DOMContentLoaded', async () => {
        // D√©finir la date d'aujourd'hui par d√©faut
        const dateInput = document.getElementById('date-select');
        const today = new Date();
        dateInput.valueAsDate = today;
        
        // Charger les donn√©es de pr√©sence pour aujourd'hui
        displayPresenceDetails(today);
        
        // Mettre √† jour les donn√©es lorsque la date change
        dateInput.addEventListener('change', (e) => {
          const selectedDate = new Date(e.target.value);
          displayPresenceDetails(selectedDate);
        });
        
        // Initialiser le graphique
        await initPresenceChart();
        
        // Mettre √† jour le graphique lorsque la p√©riode change
        document.getElementById('period-select').addEventListener('change', initPresenceChart);
      });
    </script>
    
    </body>
</html>
