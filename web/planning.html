<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title data-translate="planning.title">Planification - Presence CCR-B</title>
  <script src="/auth.js?v=2" defer></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
  <!-- DEPENDANCE GANTT -->
  <link rel="stylesheet" href="https://cdn.dhtmlx.com/gantt/8.3.0/dhtmlxgantt.css">
  <link rel="stylesheet" href="/styles.css">
  <link rel="stylesheet" href="/contrast-fixes.css">
  <style>
    /* Styles g√©n√©raux */
    .user-info-badge {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 0.5rem 1rem;
      border-radius: 20px;
      font-size: 0.9rem;
      font-weight: 500;
      margin-top: 0.5rem;
      box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
    }

    .form-label {
      font-weight: 600;
      color: #333;
    }

    .gantt_task_progress {
      background-color: rgba(255, 255, 255, 0.6) !important;
    }

    .animated-title {
      background: linear-gradient(45deg, #667eea, #764ba2, #f093fb, #f5576c, #4facfe, #00f2fe);
      background-size: 400% 400%;
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      animation: gradientShift 3s ease-in-out infinite;
      font-weight: 700;
    }

    @keyframes gradientShift {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }
    .gantt_task_line.gantt_task_status_completed .gantt_task_content { background-color: #198754; }
    .gantt_task_line.gantt_task_status_in_progress .gantt_task_content { background-color: #ffc107; }
    .gantt_task_line.gantt_task_status_cancelled .gantt_task_content { background-color: #dc3545; }
    .gantt_task_line.gantt_task_status_planned .gantt_task_content { background-color: #0d6efd; }
  </style>
</head>
<body>
  <div id="navbar-placeholder"></div>

  <div class="container py-4">
    <div class="row mb-4">
      <div class="col-md-8">
        <h1 class="h4 mb-3 animated-title" data-translate="planning.title">Planification hebdomadaire et mensuelle</h1>
        <div class="user-info-badge">
          <i class="bi bi-person"></i>
          <span id="user-display-name">Chargement...</span>
        </div>
      </div>
    </div>

    <!-- FILTRES -->
    <div class="row g-3 align-items-end mb-4">
      <div class="col-auto">
        <label for="week-start" class="form-label mb-1" data-translate="planning.week.from">Semaine du</label>
        <input type="date" id="week-start" class="form-control" />
      </div>
      <div class="col-auto">
        <button id="load-week" class="btn btn-secondary" data-translate="planning.load.week">Charger la semaine</button>
      </div>
      <div class="col-auto">
        <label for="month" class="form-label mb-1" data-translate="planning.month">Mois</label>
        <input type="month" id="month" class="form-control" />
      </div>
      <div class="col-auto">
        <button id="load-month" class="btn btn-secondary" data-translate="planning.load.month">Charger le mois</button>
      </div>
      <div class="col-auto">
        <label for="agent-select" class="form-label mb-1" data-translate="planning.agent">Agent</label>
        <select id="agent-select" class="form-select">
          <option value="" data-translate="planning.agent.all">Tous les agents</option>
        </select>
      </div>
      <div class="col-auto">
        <label for="project-filter-select" class="form-label mb-1" data-translate="planning.project">Projet</label>
        <select id="project-filter-select" class="form-select">
          <option value="" data-translate="planning.project.all">Tous les projets</option>
        </select>
      </div>
      <div class="col-auto">
        <button id="apply-filters-btn" class="btn btn-primary">Appliquer les filtres</button>
      </div>
      <div class="col-auto">
        <button id="reset-filters-btn" class="btn btn-outline-secondary">R√©initialiser filtres</button>
      </div>
    </div>

    <!-- Formulaire d'ajout/modification de planning -->
    <div class="card mb-4">
      <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
        <h5 class="mb-0" id="planningFormTitle">Ajouter une nouvelle activit√©</h5>
        <button id="newActivityBtn" class="btn btn-sm btn-light">
          <i class="bi bi-plus-circle me-1"></i> Nouvelle activit√©
        </button>
      </div>
      <div class="card-body">
        <form id="planningForm" class="needs-validation" novalidate>
          <input type="hidden" id="planningId">
          <div class="row">
            <div class="col-md-6 mb-3">
              <label for="planningTitle" class="form-label">Titre / Sujet de l'activit√© <span class="text-danger">*</span></label>
              <input type="text" class="form-control" id="planningTitle" required placeholder="Ex: R√©union projet X, T√¢che de d√©veloppement">
              <div class="invalid-feedback">Veuillez renseigner un titre.</div>
            </div>
            <div class="col-md-3 mb-3">
              <label for="planningDate" class="form-label">Date pr√©vue <span class="text-danger">*</span></label>
              <input type="date" class="form-control" id="planningDate" required>
              <div class="invalid-feedback">Veuillez choisir une date.</div>
            </div>
            <div class="col-md-3 mb-3">
              <label for="planningStatus" class="form-label">Statut <span class="text-danger">*</span></label>
              <select class="form-select" id="planningStatus" required>
                <option value="planned">Planifi√©</option>
                <option value="in_progress">En cours</option>
                <option value="completed">Termin√©</option>
                <option value="cancelled">Annul√©</option>
              </select>
              <div class="invalid-feedback">Veuillez s√©lectionner un statut.</div>
            </div>
          </div>
          <div class="row">
            <div class="col-md-3 mb-3">
              <label for="startTime" class="form-label">Heure de d√©but</label>
              <input type="time" class="form-control" id="startTime">
            </div>
            <div class="col-md-3 mb-3">
              <label for="endTime" class="form-label">Heure de fin</label>
              <input type="time" class="form-control" id="endTime">
            </div>
            <div class="col-md-6 mb-3">
              <label for="projectSelect" class="form-label">Associer √† un projet</label>
              <select class="form-select" id="projectSelect">
                <option value="">S√©lectionner un projet</option>
              </select>
            </div>
          </div>
          <div class="mb-3">
            <label for="description" class="form-label">Description d√©taill√©e (non obligatoire)</label>
            <textarea class="form-control" id="description" rows="2" placeholder="D√©tails suppl√©mentaires de la t√¢che..."></textarea>
          </div>
          <div class="d-flex justify-content-end gap-2">
            <button type="button" class="btn btn-outline-danger d-none" id="deleteBtn">
              <i class="bi bi-trash me-1"></i> Supprimer
            </button>
            <button type="button" class="btn btn-outline-secondary" id="cancelEditBtn">
              <i class="bi bi-x-circle me-1"></i> Annuler / R√©initialiser
            </button>
            <button type="submit" class="btn btn-primary" id="saveBtn">
              <i class="bi bi-save me-1"></i> Enregistrer l'activit√©
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- VUES GANTT (avec onglets) -->
    <ul class="nav nav-tabs" id="ganttViewTab" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="week-view-tab" data-bs-toggle="tab" data-bs-target="#week-view-pane" type="button" role="tab" aria-controls="week-view-pane" aria-selected="true">Vue Hebdomadaire</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="month-view-tab" data-bs-toggle="tab" data-bs-target="#month-view-pane" type="button" role="tab" aria-controls="month-view-pane" aria-selected="false">Vue Mensuelle</button>
        </li>
    </ul>
    <div class="tab-content" id="ganttViewTabContent">
        <div class="tab-pane fade show active" id="week-view-pane" role="tabpanel" aria-labelledby="week-view-tab" tabindex="0">
            <div class="card mb-4 border-top-0 rounded-top-0">
                <div class="card-header d-flex justify-content-between align-items-center bg-primary text-white">
                    <h5 class="mb-0">Tableau de Gantt hebdomadaire</h5>
                    <div class="d-flex gap-2">
                        <button id="prev-week" class="btn btn-sm btn-light">‚Üê Pr√©c.</button>
                        <button id="next-week" class="btn btn-sm btn-light">Suiv. ‚Üí</button>
                    </div>
                </div>
                <div class="card-body p-0">
                    <div class="mb-2 small text-muted p-3" data-translate="planning.drag.info">Double-cliquez sur une t√¢che dans le Gantt pour l'√©diter ci-dessus.</div>
                    <div id="week-gantt" class="gantt" style="height: 400px; width: 100%;"></div>
                    <small id="week-summary" class="text-muted p-3 d-block"></small>
                </div>
            </div>
        </div>
        <div class="tab-pane fade" id="month-view-pane" role="tabpanel" aria-labelledby="month-view-tab" tabindex="0">
            <div class="card mb-4 border-top-0 rounded-top-0">
                <div class="card-header d-flex justify-content-between align-items-center bg-info text-white">
                    <h5 class="mb-0" data-translate="planning.month.view">Vue mensuelle d√©taill√©e (Gantt)</h5>
                     <div class="d-flex gap-2">
                        <button id="prev-month" class="btn btn-sm btn-light">‚Üê Pr√©c.</button>
                        <button id="next-month" class="btn btn-sm btn-light">Suiv. ‚Üí</button>
                    </div>
                </div>
                <div class="card-body p-0">
                    <div class="mb-2 small text-muted p-3" data-translate="planning.month.info">Vue mensuelle des activit√©s. Double-cliquez pour √©diter l'activit√©.</div>
                    <div id="month-gantt" class="gantt border rounded" style="max-height:60vh; height: 400px; overflow:auto"></div>
                    <small id="month-summary" class="text-muted p-3 d-block"></small>
                </div>
            </div>
        </div>
    </div>


    <!-- R√âCAP HEBDOMADAIRE -->
    <div class="card mb-4" style="padding:16px">
      <div class="card-header d-flex justify-content-between align-items-center">
        <div>
          <i class="bi bi-calendar-week"></i>
          <span data-translate="planning.weekly.summary">R√©cap des activit√©s planifi√©es par semaine</span>
        </div>
        <div class="d-flex gap-2">
          <button id="refresh-weekly-summary" class="btn btn-sm btn-outline-primary">
            <i class="bi bi-arrow-clockwise"></i> <span data-translate="planning.refresh">Actualiser</span>
          </button>
          <button id="download-planning-image" class="btn btn-sm btn-outline-info">
            <i class="bi bi-download"></i> T√©l√©charger en image
          </button>
        </div>
      </div>
      <div class="card-body">
        <div class="mb-2 small text-muted" data-translate="planning.summary.info">R√©sum√© des activit√©s planifi√©es regroup√©es par semaine.</div>
        <div id="weekly-summary" class="border rounded p-3" style="min-height:200px">
          <div class="text-center text-muted">
            <i class="bi bi-calendar-week fs-1"></i>
            <p data-translate="planning.loading">Chargement du r√©cap hebdomadaire...</p>
          </div>
        </div>
      </div>
    </div>

    <div class="alert alert-info" data-translate="planning.alert">
      Les jours planifi√©s sans pr√©sence avant 18:00 seront marqu√©s en rouge.
    </div>
  </div>

  <!-- Footer -->
  <footer style="background: #1f2937; color: white; padding: 20px 0; margin-top: 40px;">
    <div class="container">
      <div style="display: flex; justify-content: space-between; align-items: center;">
        <div>
          <img src="/Media/logo-ccrb.png" alt="CCRB Logo" style="height: 30px; margin-right: 15px; border-radius: 4px;">
          <span>¬© 2025 Presence CCRB</span>
        </div>
        <div>
          <select id="language-selector" class="language-selector" title="Choisir la langue" style="background:rgba(255,255,255,0.1);border:1px solid rgba(255,255,255,0.3);color:white;padding:6px 10px;border-radius:6px;font-size:12px">
            <option value="fr">üá´üá∑ FR</option>
            <option value="en">üá¨üáß EN</option>
          </select>
        </div>
      </div>
    </div>
  </footer>

  <!-- Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
  <script src="https://cdn.dhtmlx.com/gantt/8.3.0/dhtmlxgantt.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <script src="/app.js?v=5"></script>
  <script src="/planning.js"></script>
  <script src="/translations.js"></script>
  
  <script>
    let currentGanttWeekDate = new Date();
    let currentGanttMonthDate = new Date();
    let allPlanningsCache = [];
    let activeGanttView = 'week'; // 'week' or 'month'

    // --- Fonctions Utilitaires ---
    function getWeekStart(date) {
      const d = new Date(date);
      const day = d.getDay() || 7;
      if (day !== 1) d.setHours(-24 * (day - 1));
      d.setHours(0, 0, 0, 0);
      return d;
    }

    function getWeekEnd(date) {
        const startOfWeek = getWeekStart(date);
        const endOfWeek = new Date(startOfWeek);
        endOfWeek.setDate(startOfWeek.getDate() + 6);
        endOfWeek.setHours(23, 59, 59, 999);
        return endOfWeek;
    }

    function getMonthStart(date) {
      const d = new Date(date.getFullYear(), date.getMonth(), 1);
      d.setHours(0, 0, 0, 0);
      return d;
    }
    
    function getMonthEnd(date) {
      const d = new Date(date.getFullYear(), date.getMonth() + 1, 0);
      d.setHours(23, 59, 59, 999);
      return d;
    }
    
    function getEventColor(status) {
      switch (status) {
        case 'completed': return '#198754';
        case 'in_progress': return '#ffc107';
        case 'cancelled': return '#dc3545';
        case 'planned':
        default: return '#0d6efd';
      }
    }
    
    function resetPlanningForm(date = new Date().toISOString().split('T')[0]) {
      const form = document.getElementById('planningForm');
      form.reset();
      form.classList.remove('was-validated');
      document.getElementById('planningId').value = '';
      document.getElementById('planningFormTitle').textContent = 'Ajouter une nouvelle activit√©';
      document.getElementById('planningDate').value = date;
      document.getElementById('planningStatus').value = 'planned';
      document.getElementById('deleteBtn').classList.add('d-none');
      document.getElementById('saveBtn').innerHTML = '<i class="bi bi-save me-1"></i> Enregistrer l\'activit√©';
      document.getElementById('saveBtn').disabled = false;
    }

    // --- Logique de chargement des donn√©es ---
    async function loadAllPlanningData(startDate, endDate) {
      try {
        const startStr = startDate.toISOString().split('T')[0];
        const endStr = endDate.toISOString().split('T')[0];
        const agentId = document.getElementById('agent-select').value;
        const projectId = document.getElementById('project-filter-select').value;
        
        let url = `planifications?from=${startStr}&to=${endStr}`;
        if (agentId) url += `&agent_id=${agentId}`;
        if (projectId) url += `&project_id=${projectId}`;
        
        const data = await apiCall(url);

        if (data && data.items) {
          allPlanningsCache = data.items.map(item => ({
            id: item.id,
            title: item.description_activite || 'Sans titre',
            start: item.date + (item.planned_start_time ? 'T' + item.planned_start_time : 'T00:00:00'),
            end: item.planned_end_time ? (item.date + 'T' + item.planned_end_time) : null,
            allDay: !item.planned_start_time && !item.planned_end_time,
            extendedProps: {
              status: item.status || 'planned',
              project_id: item.project_id,
              description: item.description_activite
            }
          }));
          return allPlanningsCache;
        }
        allPlanningsCache = [];
        return [];
      } catch (error) {
        console.error('Erreur lors du chargement des plannings:', error);
        return [];
      }
    }
    
    // --- Gestion de la Vue Gantt ---
    function setupGantt() {
        gantt.config.xml_date = "%Y-%m-%d %H:%i";
        gantt.i18n.setLocale("fr");

        gantt.attachEvent("onTaskDblClick", function(id, e) {
            const task = gantt.getTask(id);
            editPlanningFromGantt(task);
            return false;
        });

        gantt.templates.task_class = function(start, end, task) {
            return `gantt_task_status_${task.status}`;
        };
    }

    async function updateGanttView() {
        gantt.clearAll();

        let startDate, endDate, summaryElement;
        
        if (activeGanttView === 'month') {
            gantt.config.scale_unit = "month";
            gantt.config.date_scale = "%F, %Y";
            gantt.config.subscales = [{ unit: "day", step: 1, date: "%j" }];
            gantt.config.columns = [
                {name: "text", label: "Activit√©", tree: true, width: 250, resize: true},
                {name: "start_date", label: "D√©but", align: "center", width: 90},
                {name: "duration", label: "Jours", align: "center", width: 60},
            ];
            startDate = getMonthStart(currentGanttMonthDate);
            endDate = getMonthEnd(currentGanttMonthDate);
            summaryElement = document.getElementById('month-summary');
            gantt.init("month-gantt");
        } else {
            gantt.config.scale_unit = "day";
            gantt.config.date_scale = "%D, %j %M";
            gantt.config.subscales = [{ unit: "hour", step: 1, date: "%H:00" }];
            gantt.config.min_column_width = 80;
            gantt.config.columns = [
                {name: "text", label: "Activit√©", tree: true, width: 200, resize: true},
                {name: "start_date", label: "D√©but", align: "center", width: 100},
                {name: "duration", label: "Dur√©e (h)", align: "center", width: 80},
                {name: "status", label: "Statut", align: "center", width: 80, template: task => task.status.charAt(0).toUpperCase() + task.status.slice(1).replace('_', ' ')},
            ];
            startDate = getWeekStart(currentGanttWeekDate);
            endDate = getWeekEnd(currentGanttWeekDate);
            summaryElement = document.getElementById('week-summary');
            gantt.init("week-gantt");
        }
        
        const rawEvents = await loadAllPlanningData(startDate, endDate);
        const tasks = { data: rawEvents.map(item => {
            const start = new Date(item.start);
            let end;
            if (item.end && !isNaN(new Date(item.end))) {
                end = new Date(item.end);
            } else {
                end = new Date(start.getTime() + (activeGanttView === 'month' ? 86400000 : 3600000));
            }

            let duration;
            if (activeGanttView === 'month') {
                duration = Math.ceil((end.getTime() - start.getTime()) / (1000 * 60 * 60 * 24));
                duration = Math.max(1, duration);
            } else {
                duration = (end.getTime() - start.getTime()) / 3600000;
            }

            return {
                id: item.id,
                text: item.title,
                start_date: start,
                duration: duration,
                progress: item.extendedProps.status === 'completed' ? 1 : 0,
                status: item.extendedProps.status,
                color: getEventColor(item.extendedProps.status)
            };
        })};
    
        if (summaryElement) {
            summaryElement.textContent = activeGanttView === 'month'
                ? `Affichage du mois : ${startDate.toLocaleDateString('fr-FR', { month: 'long', year: 'numeric' })}`
                : `Du ${startDate.toLocaleDateString('fr-FR')} au ${endDate.toLocaleDateString('fr-FR')}`;
        }
    
        gantt.parse(tasks);
    }


    // --- Fonctions d'√©dition ---
    function editPlanningFromGantt(task) {
        resetPlanningForm(); 
        document.getElementById('planningFormTitle').textContent = `Modifier l'activit√© (ID: ${task.id})`;
        document.getElementById('planningId').value = task.id;
        document.getElementById('planningTitle').value = task.text;
        document.getElementById('deleteBtn').classList.remove('d-none');
        
        const startDate = task.start_date; // C'est un objet Date
        document.getElementById('planningDate').value = startDate.toISOString().split('T')[0];
        document.getElementById('planningStatus').value = task.status || 'planned';
        
        if (startDate) {
            document.getElementById('startTime').value = startDate.toTimeString().substring(0, 5);
            if (task.duration) {
                const isMonthView = gantt.config.scale_unit === 'month';
                const durationMs = task.duration * (isMonthView ? 86400000 : 3600000);
                const endDate = new Date(startDate.getTime() + durationMs);
                document.getElementById('endTime').value = endDate.toTimeString().substring(0, 5);
            }
        } 
        
        const cachedItem = allPlanningsCache.find(p => p.id == task.id);
        if (cachedItem) {
            document.getElementById('description').value = cachedItem.extendedProps.description || '';
            document.getElementById('projectSelect').value = cachedItem.extendedProps.project_id || '';
        }
    }
    
    // --- Initialisation et √âv√©nements ---
    document.addEventListener('DOMContentLoaded', function() {
        setupGantt();
        loadProjects(); 
        
        // Listeners des onglets
        document.querySelectorAll('#ganttViewTab button[data-bs-toggle="tab"]').forEach(tab => {
            tab.addEventListener('shown.bs.tab', event => {
                activeGanttView = event.target.id === 'week-view-tab' ? 'week' : 'month';
                updateGanttView();
            });
        });

        // Navigation
        document.getElementById('prev-week').addEventListener('click', () => { currentGanttWeekDate.setDate(currentGanttWeekDate.getDate() - 7); updateGanttView(); });
        document.getElementById('next-week').addEventListener('click', () => { currentGanttWeekDate.setDate(currentGanttWeekDate.getDate() + 7); updateGanttView(); });
        document.getElementById('prev-month').addEventListener('click', () => { currentGanttMonthDate.setMonth(currentGanttMonthDate.getMonth() - 1); updateGanttView(); });
        document.getElementById('next-month').addEventListener('click', () => { currentGanttMonthDate.setMonth(currentGanttMonthDate.getMonth() + 1); updateGanttView(); });
        
        // Chargement par date
        document.getElementById('load-week').addEventListener('click', () => {
            const dateInput = document.getElementById('week-start').value;
            if (dateInput) currentGanttWeekDate = new Date(dateInput);
            document.querySelector('#week-view-tab').click();
        });
        document.getElementById('load-month').addEventListener('click', () => {
            const monthInput = document.getElementById('month').value;
            if (monthInput) {
                const [year, month] = monthInput.split('-');
                currentGanttMonthDate = new Date(year, month - 1, 1);
            }
            document.querySelector('#month-view-tab').click();
        });
        
        // Filtres
        document.getElementById('apply-filters-btn').addEventListener('click', () => updateGanttView());
        document.getElementById('reset-filters-btn').addEventListener('click', () => {
            document.getElementById('agent-select').value = '';
            document.getElementById('project-filter-select').value = '';
            document.getElementById('supervisor-select').value = '';
            updateGanttView();
        });
        
        // Formulaire
        document.getElementById('newActivityBtn').addEventListener('click', () => resetPlanningForm());
        document.getElementById('cancelEditBtn').addEventListener('click', () => resetPlanningForm());
        document.getElementById('planningForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            if (!this.checkValidity()) {
                e.stopPropagation();
                this.classList.add('was-validated');
                return;
            }

            const isEdit = !!document.getElementById('planningId').value;
            const submitBtn = document.getElementById('saveBtn');
            const originalBtnText = submitBtn.innerHTML;
            
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Traitement...';
            
            try {
                // [Int√©grer ici votre logique d'appel API POST/PUT]
                await new Promise(resolve => setTimeout(resolve, 800));
                showAlert('success', `Activit√© ${isEdit ? 'mise √† jour' : 'cr√©√©e'} avec succ√®s.`);
                resetPlanningForm();
                updateGanttView();
            } catch (error) {
                showAlert('danger', `Erreur lors de la sauvegarde: ${error.message}`);
            } finally {
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalBtnText;
            }
        });
        
        // Chargement initial
        updateGanttView();
        resetPlanningForm();
    });
    
    // --- Fonctions API et utilitaires simul√©es ---
    async function apiCall(endpoint, options = {}) {
      const dummyData = {
        planifications: { items: [
            { id: 1, date: '2025-10-20', planned_start_time: '09:00', planned_end_time: '11:00', description_activite: 'D√©marrage projet Alpha', status: 'completed', project_id: 101 },
            { id: 2, date: '2025-10-21', planned_start_time: '14:00', planned_end_time: '16:30', description_activite: 'Revue de code Beta', status: 'in_progress', project_id: 102 },
            { id: 3, date: '2025-10-22', planned_start_time: '10:00', planned_end_time: '18:00', description_activite: 'Pr√©paration documentation', status: 'planned', project_id: 101 },
            { id: 4, date: '2025-11-05', planned_start_time: '10:00', planned_end_time: null, description_activite: 'D√©ploiement mensuel', status: 'planned', project_id: 102 },
        ]},
        projects: { items: [{ id: 101, name: 'Projet Alpha' }, { id: 102, name: 'Projet Beta' }] }
      };
      
      const endpointName = endpoint.split('?')[0];
      if (dummyData[endpointName]) {
        return new Promise(resolve => setTimeout(() => resolve(dummyData[endpointName]), 500));
      }
      return { items: [] }; 
    }

    function showAlert(type, message) {
      console.log(`Alerte (${type}): ${message}`);
      // [Ins√©rer ici votre fonction d'affichage d'alerte visuelle]
    }

    async function loadProjects() {
      try {
        const data = await apiCall('projects');
        const select = document.getElementById('projectSelect');
        const filterSelect = document.getElementById('project-filter-select');

        [select, filterSelect].forEach(s => {
          s.innerHTML = s.id === 'project-filter-select' ? '<option value="">Tous les projets</option>' : '<option value="">S√©lectionner un projet</option>';
          if (data && Array.isArray(data.items)) {
            data.items.forEach(project => {
              const option = document.createElement('option');
              option.value = project.id;
              option.textContent = project.name;
              s.appendChild(option);
            });
          }
        });
      } catch (error) {
        console.error('Erreur de chargement des projets:', error);
      }
    }
  </script>
</body>
</html>