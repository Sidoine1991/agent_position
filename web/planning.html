<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title data-translate="planning.title">Planification - Presence CCR-B</title>
  <script src="/auth.js?v=2" defer></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.css">
  <link rel="stylesheet" href="/styles.css">
  <link rel="stylesheet" href="/contrast-fixes.css">
  <style>
    /* Styles existants */
    .circle-actions {
      display: flex !important;
      flex-direction: row !important;
      flex-wrap: wrap !important;
      gap: 16px;
      justify-content: center;
      align-items: center;
      margin: 20px 0;
      padding: 20px;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 16px;
      backdrop-filter: blur(10px);
      width: 100%;
    }
    
    .circle-action {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      width: 80px;
      height: 80px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border-radius: 50%;
      color: white;
      text-decoration: none;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
      position: relative;
      overflow: hidden;
    }
    
    /* Nouveaux styles pour le calendrier */
    .fc-event {
      cursor: pointer;
      font-size: 0.85em;
      padding: 2px 4px;
    }
    
    .fc-day-today {
      background-color: #e8f4fd !important;
    }
    
    .status-badge {
      font-size: 0.8em;
      padding: 0.25em 0.5em;
      border-radius: 0.25rem;
    }
    
    .status-planned {
      background-color: #e2f0fd;
      color: #0d6efd;
    }
    
    .status-completed {
      background-color: #e7f7e7;
      color: #198754;
    }
    
    .status-cancelled {
      background-color: #f8e7e7;
      color: #dc3545;
    }
    
    /* Styles existants restants... */
    /* ... (conservez tous les autres styles existants) ... */
  </style>
</head>
<body>
  <div id="navbar-placeholder"></div>

  <div class="container py-4">
    <div class="row mb-4">
      <div class="col-md-8">
        <h1 class="h4 mb-3" data-translate="planning.title">Planification des activit√©s</h1>
        <div class="user-info-badge">
          <i class="bi bi-person"></i>
          <span id="user-display-name">Chargement...</span>
        </div>
      </div>
    </div>

    <!-- Nouvelle section de navigation rapide -->
    <div class="card mb-4">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h5 class="mb-0">Navigation rapide</h5>
          <div class="btn-group">
            <button class="btn btn-outline-primary btn-sm" id="today-btn">Aujourd'hui</button>
            <button class="btn btn-outline-secondary btn-sm" id="month-view-btn">Mois</button>
            <button class="btn btn-outline-secondary btn-sm" id="week-view-btn">Semaine</button>
            <button class="btn btn-outline-secondary btn-sm" id="day-view-btn">Jour</button>
          </div>
        </div>
        
        <div class="d-flex flex-wrap gap-2 mb-3">
          <div class="d-flex align-items-center me-3">
            <div class="me-2" style="width: 12px; height: 12px; background-color: #0d6efd; border-radius: 2px;"></div>
            <small>Planifi√©</small>
          </div>
          <div class="d-flex align-items-center me-3">
            <div class="me-2" style="width: 12px; height: 12px; background-color: #198754; border-radius: 2px;"></div>
            <small>Termin√©</small>
          </div>
          <div class="d-flex align-items-center">
            <div class="me-2" style="width: 12px; height: 12px; background-color: #dc3545; border-radius: 2px;"></div>
            <small>Annul√©</small>
          </div>
        </div>
      </div>
    </div>

    <!-- Calendrier principal -->
    <div class="card mb-4">
      <div class="card-body">
        <div id="calendar"></div>
      </div>
    </div>

    <!-- Formulaire d'ajout/modification de planning -->
    <div class="modal fade" id="planningModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="modalTitle">Nouveau planning</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fermer"></button>
          </div>
          <form id="planningForm">
            <div class="modal-body">
              <input type="hidden" id="planningId">
              <div class="mb-3">
                <label class="form-label">Titre</label>
                <input type="text" class="form-control" id="planningTitle" required>
              </div>
              <div class="row">
                <div class="col-md-6 mb-3">
                  <label class="form-label">Date</label>
                  <input type="date" class="form-control" id="planningDate" required>
                </div>
                <div class="col-md-6 mb-3">
                  <label class="form-label">Statut</label>
                  <select class="form-select" id="planningStatus">
                    <option value="planned">Planifi√©</option>
                    <option value="in_progress">En cours</option>
                    <option value="completed">Termin√©</option>
                    <option value="cancelled">Annul√©</option>
                  </select>
                </div>
              </div>
              <div class="row">
                <div class="col-md-6 mb-3">
                  <label class="form-label">Heure de d√©but</label>
                  <input type="time" class="form-control" id="startTime">
                </div>
                <div class="col-md-6 mb-3">
                  <label class="form-label">Heure de fin</label>
                  <input type="time" class="form-control" id="endTime">
                </div>
              </div>
              <div class="mb-3">
                <label class="form-label">Description</label>
                <textarea class="form-control" id="description" rows="3"></textarea>
              </div>
              <div class="mb-3">
                <label class="form-label">Projet</label>
                <select class="form-select" id="projectSelect">
                  <option value="">S√©lectionner un projet</option>
                </select>
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
              <button type="submit" class="btn btn-primary">Enregistrer</button>
              <button type="button" id="deleteBtn" class="btn btn-danger me-auto d-none">Supprimer</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Ancienne section de planification (conserv√©e pour compatibilit√©) -->
    <div class="card mb-4" style="display: none;">
      <div class="card-header d-flex justify-content-between align-items-center">
        <div>
          <span data-translate="planning.week">Semaine</span>
          <small id="week-summary" class="text-muted ms-2"></small>
        </div>
        <div class="d-flex gap-2">
          <button id="prev-week" class="btn btn-sm btn-outline-secondary" data-translate="planning.prev.week">‚Üê Pr√©c.</button>
          <button id="next-week" class="btn btn-sm btn-outline-secondary" data-translate="planning.next.week">Suiv. ‚Üí</button>
        </div>
      </div>
      <div class="card-body">
        <div id="week-gantt" class="gantt border rounded" style="overflow:auto; min-height:260px"></div>
      </div>
    </div>

  </div>

  <!-- Footer -->
  <footer style="background: #1f2937; color: white; padding: 20px 0; margin-top: 40px;">
    <div class="container">
      <div style="display: flex; justify-content: space-between; align-items: center;">
        <div>
          <img src="/Media/logo-ccrb.png" alt="CCRB Logo" style="height: 30px; margin-right: 15px; border-radius: 4px;">
          <span>¬© 2025 Presence CCRB</span>
        </div>
        <div>
          <select id="language-selector" class="language-selector" title="Choisir la langue" style="background:rgba(255,255,255,0.1);border:1px solid rgba(255,255,255,0.3);color:white;padding:6px 10px;border-radius:6px;font-size:12px">
            <option value="fr">üá´üá∑ FR</option>
            <option value="en">üá¨üáß EN</option>
          </select>
        </div>
      </div>
    </div>
  </footer>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/locales-all.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <script src="/app.js?v=5"></script>
  <script src="/planning.js"></script>
  <script src="/translations.js"></script>
  
  <script>
    // Initialisation du calendrier
    document.addEventListener('DOMContentLoaded', function() {
      // Initialisation du calendrier FullCalendar
      const calendarEl = document.getElementById('calendar');
      const calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'dayGridMonth',
        locale: 'fr',
        headerToolbar: {
          left: 'prev,next today',
          center: 'title',
          right: 'dayGridMonth,timeGridWeek,timeGridDay'
        },
        buttonText: {
          today: 'Aujourd\'hui',
          month: 'Mois',
          week: 'Semaine',
          day: 'Jour'
        },
        eventClick: function(info) {
          showEditPlanningModal(info.event);
        },
        dateClick: function(info) {
          showNewPlanningModal(info.dateStr);
        },
        events: function(fetchInfo, successCallback, failureCallback) {
          // Charger les √©v√©nements depuis l'API
          loadPlannings(fetchInfo.start, fetchInfo.end)
            .then(events => successCallback(events))
            .catch(error => {
              console.error('Erreur lors du chargement des plannings:', error);
              failureCallback(error);
            });
        }
      });
      
      calendar.render();
      
      // Gestionnaire d'√©v√©nements pour les boutons de navigation
      document.getElementById('today-btn').addEventListener('click', function() {
        calendar.today();
      });
      
      document.getElementById('month-view-btn').addEventListener('click', function() {
        calendar.changeView('dayGridMonth');
      });
      
      document.getElementById('week-view-btn').addEventListener('click', function() {
        calendar.changeView('timeGridWeek');
      });
      
      document.getElementById('day-view-btn').addEventListener('click', function() {
        calendar.changeView('timeGridDay');
      });
      
      // Charger les projets
      loadProjects();
    });
    
    // Charger les plannings depuis l'API
    async function loadPlannings(start, end) {
      try {
        const token = localStorage.getItem('token');
        const response = await axios.get('/api/planifications', {
          headers: { 'Authorization': `Bearer ${token}` },
          params: {
            from: start.toISOString().split('T')[0],
            to: end.toISOString().split('T')[0]
          }
        });
        
        if (response.data && response.data.items) {
          return response.data.items.map(item => ({
            id: item.id,
            title: item.description_activite || 'Sans titre',
            start: item.date + (item.planned_start_time ? 'T' + item.planned_start_time : ''),
            end: item.planned_end_time ? (item.date + 'T' + item.planned_end_time) : null,
            allDay: !item.planned_start_time && !item.planned_end_time,
            backgroundColor: getEventColor(item.status),
            borderColor: getEventColor(item.status),
            extendedProps: {
              project_name: item.project_name,
              status: item.status || 'planned'
            }
          }));
        }
        return [];
      } catch (error) {
        console.error('Erreur lors du chargement des plannings:', error);
        return [];
      }
    }
    
    // Charger la liste des projets
    async function loadProjects() {
      try {
        const token = localStorage.getItem('token');
        const response = await axios.get('/api/projects', {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        
        const select = document.getElementById('projectSelect');
        select.innerHTML = '<option value="">S√©lectionner un projet</option>';
        
        if (response.data && Array.isArray(response.data.items)) {
          response.data.items.forEach(project => {
            const option = document.createElement('option');
            option.value = project.id;
            option.textContent = project.name;
            select.appendChild(option);
          });
        }
      } catch (error) {
        console.error('Erreur lors du chargement des projets:', error);
      }
    }
    
    // Afficher le modal pour un nouveau planning
    function showNewPlanningModal(date) {
      const modal = new bootstrap.Modal(document.getElementById('planningModal'));
      const form = document.getElementById('planningForm');
      form.reset();
      
      document.getElementById('modalTitle').textContent = 'Nouveau planning';
      document.getElementById('planningId').value = '';
      document.getElementById('planningDate').value = date || new Date().toISOString().split('T')[0];
      document.getElementById('planningStatus').value = 'planned';
      document.getElementById('deleteBtn').classList.add('d-none');
      
      modal.show();
    }
    
    // Afficher le modal pour modifier un planning
    function showEditPlanningModal(event) {
      const modal = new bootstrap.Modal(document.getElementById('planningModal'));
      const form = document.getElementById('planningForm');
      form.reset();
      
      document.getElementById('modalTitle').textContent = 'Modifier le planning';
      document.getElementById('planningId').value = event.id;
      document.getElementById('planningTitle').value = event.title;
      document.getElementById('planningDate').value = event.start ? event.start.toISOString().split('T')[0] : '';
      document.getElementById('planningStatus').value = event.extendedProps.status || 'planned';
      document.getElementById('description').value = event.extendedProps.description || '';
      document.getElementById('projectSelect').value = event.extendedProps.project_id || '';
      
      if (event.start) {
        const startTime = event.start.toTimeString().substring(0, 5);
        document.getElementById('startTime').value = startTime;
      }
      
      if (event.end) {
        const endTime = event.end.toTimeString().substring(0, 5);
        document.getElementById('endTime').value = endTime;
      }
      
      document.getElementById('deleteBtn').classList.remove('d-none');
      modal.show();
    }
    
    // G√©rer la soumission du formulaire
    document.getElementById('planningForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      
      const formData = {
        date: document.getElementById('planningDate').value,
        planned_start_time: document.getElementById('startTime').value || null,
        planned_end_time: document.getElementById('endTime').value || null,
        description_activite: document.getElementById('description').value,
        project_id: document.getElementById('projectSelect').value || null,
        status: document.getElementById('planningStatus').value
      };
      
      const planningId = document.getElementById('planningId').value;
      const isEdit = !!planningId;
      
      try {
        const token = localStorage.getItem('token');
        let response;
        
        if (isEdit) {
          response = await axios.put(`/api/planifications/${planningId}`, formData, {
            headers: { 'Authorization': `Bearer ${token}` }
          });
        } else {
          response = await axios.post('/api/planifications', formData, {
            headers: { 'Authorization': `Bearer ${token}` }
          });
        }
        
        if (response.data && response.data.success) {
          showAlert('success', `Planning ${isEdit ? 'mis √† jour' : 'cr√©√©'} avec succ√®s`);
          const calendarEl = document.getElementById('calendar');
          const calendar = FullCalendar.getCalendar(calendarEl);
          calendar.refetchEvents();
          bootstrap.Modal.getInstance(document.getElementById('planningModal')).hide();
        }
      } catch (error) {
        console.error('Erreur lors de la sauvegarde du planning:', error);
        showAlert('danger', 'Erreur lors de la sauvegarde du planning');
      }
    });
    
    // G√©rer la suppression d'un planning
    document.getElementById('deleteBtn').addEventListener('click', async function() {
      if (!confirm('√ätes-vous s√ªr de vouloir supprimer ce planning ?')) {
        return;
      }
      
      const planningId = document.getElementById('planningId').value;
      
      try {
        const token = localStorage.getItem('token');
        const response = await axios.delete(`/api/planifications/${planningId}`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        
        if (response.data && response.data.success) {
          showAlert('success', 'Planning supprim√© avec succ√®s');
          const calendarEl = document.getElementById('calendar');
          const calendar = FullCalendar.getCalendar(calendarEl);
          calendar.refetchEvents();
          bootstrap.Modal.getInstance(document.getElementById('planningModal')).hide();
        }
      } catch (error) {
        console.error('Erreur lors de la suppression du planning:', error);
        showAlert('danger', 'Erreur lors de la suppression du planning');
      }
    });
    
    // Fonction utilitaire pour obtenir la couleur en fonction du statut
    function getEventColor(status) {
      switch (status) {
        case 'completed': return '#198754';
        case 'in_progress': return '#0d6efd';
        case 'cancelled': return '#dc3545';
        case 'planned':
        default: return '#6c757d';
      }
    }
    
    // Fonction utilitaire pour afficher des alertes
    function showAlert(type, message) {
      const alertDiv = document.createElement('div');
      alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed top-0 end-0 m-3`;
      alertDiv.role = 'alert';
      alertDiv.style.zIndex = '1100';
      alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
      `;
      
      document.body.appendChild(alertDiv);
      
      setTimeout(() => {
        alertDiv.remove();
      }, 5000);
    }
  </script>
</body>
</html>