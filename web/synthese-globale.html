<!doctype html>
<html lang="fr">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="manifest" href="/manifest.webmanifest" />
  <meta name="theme-color" content="#0ea5e9" />
  <title>Synth√®se Globale - Presence CCRB</title>
  <script type="module" src="/auth.js?v=2" defer></script>
  <!-- Import du SDK Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <!-- Configuration Supabase -->
  <script src="/js/supabase-config.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" />
  <link rel="stylesheet" href="/styles.css?v=2" />
  <link rel="stylesheet" href="/contrast-fixes.css" />
  <style>
    body {
      background: #f8f9fa;
      padding-top: 20px;
    }

    .page-header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 30px 0;
      margin-bottom: 30px;
      border-radius: 0 0 20px 20px;
    }

    .filter-card {
      background: white;
      border-radius: 15px;
      padding: 25px;
      margin-bottom: 30px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
    }

    .summary-table-container {
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      padding: 1.5rem;
      margin-top: 1.5rem;
    }

    #summary-table-wrapper {
      overflow-x: auto;
      overflow-y: visible;
      max-width: 100%;
      position: relative;
      -webkit-overflow-scrolling: touch;
      border: 1px solid #dee2e6;
      border-radius: 8px;
    }

    .summary-table {
      width: 100%;
      min-width: 1400px;
      border-collapse: collapse;
      font-size: 0.85rem;
      margin: 0;
    }

    .summary-table th {
      background-color: #f8f9fa;
      color: #212529 !important;
      font-weight: 600;
      padding: 0.75rem;
      vertical-align: middle;
      text-align: center;
      border: 1px solid #dee2e6;
    }

    .summary-table thead {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      position: sticky;
      top: 0;
      z-index: 10;
    }

    .summary-table thead th {
      padding: 10px 6px;
      text-align: center;
      font-weight: 600;
      border: 1px solid rgba(255, 255, 255, 0.3);
      white-space: nowrap;
      color: white !important;
      font-size: 0.75rem;
      line-height: 1.3;
    }

    /* Colonnes fixes (Rang, Agent) */
    .summary-table thead th:first-child {
      position: sticky;
      left: 0;
      z-index: 12;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-width: 60px;
    }

    .summary-table thead th:nth-child(2) {
      position: sticky;
      left: 60px;
      z-index: 12;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-width: 180px;
    }

    .summary-table td {
      padding: 8px 6px;
      text-align: center;
      border: 1px solid #dee2e6;
      vertical-align: middle;
      font-size: 0.85rem;
      white-space: nowrap;
    }

    /* Cellules fixes pour le corps du tableau */
    .summary-table tbody td:first-child {
      position: sticky;
      left: 0;
      z-index: 9;
      background: white;
      font-weight: 700;
      font-size: 0.95rem;
      color: #667eea;
      min-width: 60px;
    }

    .summary-table tbody td:nth-child(2) {
      position: sticky;
      left: 60px;
      z-index: 9;
      background: white;
      min-width: 180px;
    }

    .summary-table tbody tr:hover td {
      background-color: #e7f3ff !important;
    }

    .summary-table tbody tr:hover td:first-child,
    .summary-table tbody tr:hover td:nth-child(2) {
      background-color: #e7f3ff !important;
    }

    .summary-table tbody tr:nth-child(even) {
      background-color: #f8f9fa;
    }

    .summary-table tbody tr:nth-child(even) td:first-child,
    .summary-table tbody tr:nth-child(even) td:nth-child(2) {
      background-color: #f8f9fa;
    }

    .summary-table tbody tr:nth-child(even):hover td:first-child,
    .summary-table tbody tr:nth-child(even):hover td:nth-child(2) {
      background-color: #e7f3ff !important;
    }

    .agent-name {
      font-weight: 600;
      color: #2c3e50;
      text-align: left !important;
      padding-left: 12px !important;
    }

    .summary-table td.email-cell {
      font-size: 0.75rem;
      color: #6c757d;
      text-align: left !important;
      padding-left: 12px !important;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .summary-table .metric-cell {
      font-weight: 600;
      min-width: 70px;
    }

    .summary-table .number-cell {
      font-weight: 500;
      min-width: 55px;
    }

    .metric-excellent {
      background-color: #d4edda;
      color: #155724;
      font-weight: 600;
    }

    .metric-good {
      background-color: #d1ecf1;
      color: #0c5460;
      font-weight: 600;
    }

    .metric-average {
      background-color: #fff3cd;
      color: #856404;
      font-weight: 600;
    }

    .metric-poor {
      background-color: #f8d7da;
      color: #721c24;
      font-weight: 600;
    }

    .metric-critical {
      background-color: #f5c6cb;
      color: #721c24;
      font-weight: 700;
    }

    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.7);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      color: white;
      font-size: 1.2rem;
    }

    .loading-spinner {
      border: 4px solid rgba(255, 255, 255, 0.3);
      border-top: 4px solid white;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      animation: spin 1s linear infinite;
      margin-bottom: 20px;
    }

    @keyframes spin {
      0% {
        transform: rotate(0deg);
      }

      100% {
        transform: rotate(360deg);
      }
    }

    .stats-summary {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-bottom: 20px;
    }

    .stat-card {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 20px;
      border-radius: 10px;
      text-align: center;
    }

    .stat-card .value {
      font-size: 2rem;
      font-weight: bold;
      margin-bottom: 5px;
    }

    .stat-card .label {
      font-size: 0.9rem;
      opacity: 0.9;
    }
  </style>
</head>

<body>
  <div class="page-header">
    <div class="container">
      <div class="d-flex justify-content-between align-items-center">
        <div>
          <h1 class="mb-0"><i class="bi bi-table me-2"></i>Synth√®se Globale des Rapports</h1>
          <p class="mb-0 mt-2 opacity-75">Vue d'ensemble de tous les agents d'un projet</p>
        </div>
        <div>
          <a href="/index.html" class="btn btn-light">
            <i class="bi bi-house me-1"></i>Accueil
          </a>
        </div>
      </div>
    </div>
  </div>

  <div class="container">
    <!-- Filtres -->
    <div class="filter-card">
      <h5 class="mb-3"><i class="bi bi-funnel me-2"></i>Filtres</h5>
      <div class="row g-3">
        <div class="col-md-4">
          <label for="project-filter" class="form-label">Projet</label>
          <select id="project-filter" class="form-select">
            <option value="">Chargement...</option>
          </select>
        </div>
        <div class="col-md-4">
          <label for="month-filter" class="form-label">Mois</label>
          <input type="month" id="month-filter" class="form-control" value="">
        </div>
        <div class="col-md-4 d-flex align-items-end">
          <button type="button" class="btn btn-primary w-100" onclick="loadSummary()">
            <i class="bi bi-search me-1"></i>Charger la synth√®se
          </button>
        </div>
      </div>
    </div>

    <!-- Statistiques globales -->
    <div id="stats-summary" class="stats-summary" style="display: none;">
      <!-- Sera rempli dynamiquement -->
    </div>

    <!-- Tableau de synth√®se -->
    <div class="summary-table-container">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <div>
          <h5 class="mb-0"><i class="bi bi-table me-2"></i>Tableau de synth√®se</h5>
          <small class="text-muted d-block mt-1">
            <i class="bi bi-arrows-expand me-1"></i>Faites d√©filer horizontalement pour voir toutes les colonnes
          </small>
        </div>
        <div>
          <button type="button" class="btn btn-success btn-sm" onclick="exportToCSV()">
            <i class="bi bi-file-earmark-spreadsheet me-1"></i>Exporter CSV
          </button>
          <button type="button" class="btn btn-primary btn-sm" onclick="exportToHTML()">
            <i class="bi bi-file-earmark-code me-1"></i>Exporter HTML
          </button>
        </div>
      </div>
      <div id="summary-table-wrapper">
        <div class="text-center py-5 text-muted">
          <i class="bi bi-info-circle me-2"></i>
          S√©lectionnez un projet et un mois, puis cliquez sur "Charger la synth√®se"
        </div>
      </div>
    </div>
  </div>

  <!-- Overlay de chargement -->
  <div id="loading-overlay" class="loading-overlay" style="display: none;">
    <div class="text-center">
      <div class="loading-spinner"></div>
      <div id="loading-text">Chargement des donn√©es...</div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // Variables globales
    let summaryData = [];
    let allAgents = [];
    let jwt = localStorage.getItem('jwt');

    // Fonction pour obtenir le token JWT
    async function getJWT() {
      if (!jwt) {
        try {
          const response = await fetch('/api/profile');
          if (response.ok) {
            jwt = localStorage.getItem('jwt');
          }
        } catch (e) {
          console.error('Erreur r√©cup√©ration JWT:', e);
        }
      }
      return jwt;
    }

    // Fonction API
    async function api(path, opts = {}) {
      const headers = opts.headers || {};
      if (!(opts.body instanceof FormData)) headers['Content-Type'] = 'application/json';
      const token = await getJWT();
      if (token) headers['Authorization'] = 'Bearer ' + token;

      const res = await fetch('/api' + path, {
        method: opts.method || 'GET',
        headers,
        body: opts.body instanceof FormData ? opts.body : (opts.body ? JSON.stringify(opts.body) : undefined),
      });

      if (res.status === 401) {
        window.location.href = '/index.html';
        throw new Error('Non autoris√©');
      }

      if (!res.ok) {
        const errorText = await res.text();
        throw new Error(errorText || res.statusText);
      }

      const ct = res.headers.get('content-type') || '';
      return ct.includes('application/json') ? await res.json() : await res.text();
    }

    // Normaliser un nom de projet (trim + espaces)
    function normalizeProjectName(name) {
      if (!name) return '';
      return String(name)
        .replace(/\s+/g, ' ')
        .trim();
    }

    // Fonction pour charger les projets
    async function loadProjects() {
      try {
        const select = document.getElementById('project-filter');
        select.innerHTML = '<option value="">Chargement...</option>';

        const agents = await api('/agents');
        const projectMap = new Map(); // key: nom normalis√©, value: libell√© √† afficher

        if (agents && Array.isArray(agents)) {
          agents.forEach(agent => {
            const rawProject = agent.project_name || agent.project || 'Non sp√©cifi√©';
            const key = normalizeProjectName(rawProject);
            if (!key) return;
            // Ne garder qu'une entr√©e par projet normalis√©
            if (!projectMap.has(key)) {
              projectMap.set(key, rawProject.trim());
            }
          });
        }

        select.innerHTML = '<option value="">Tous les projets</option>';
        Array.from(projectMap.entries())
          .sort((a, b) => a[1].localeCompare(b[1]))
          .forEach(([key, label]) => {
            const option = document.createElement('option');
            option.value = key;      // valeur normalis√©e
            option.textContent = label; // libell√© affich√©
            select.appendChild(option);
          });

        allAgents = agents || [];
      } catch (error) {
        console.error('Erreur chargement projets:', error);
        document.getElementById('project-filter').innerHTML = '<option value="">Erreur de chargement</option>';
      }
    }

    // Fonction pour formater le temps terrain
    function formatFieldTime(hours) {
      if (!hours || hours === 0) return '0h';
      const h = Math.floor(hours);
      const m = Math.round((hours - h) * 60);
      return m > 0 ? `${h}h${String(m).padStart(2, '0')}` : `${h}h`;
    }

    // Fonction pour obtenir la classe CSS selon la valeur
    function getMetricClass(value, type) {
      if (type === 'presence') {
        if (value >= 90) return 'metric-excellent';
        if (value >= 80) return 'metric-good';
        if (value >= 70) return 'metric-average';
        if (value >= 50) return 'metric-poor';
        return 'metric-critical';
      } else if (type === 'tep') {
        if (value >= 90) return 'metric-excellent';
        if (value >= 80) return 'metric-good';
        if (value >= 70) return 'metric-average';
        if (value >= 50) return 'metric-poor';
        return 'metric-critical';
      } else if (type === 'fieldTime') {
        if (value >= 100) return 'metric-excellent';
        if (value >= 80) return 'metric-good';
        if (value >= 60) return 'metric-average';
        if (value >= 40) return 'metric-poor';
        return 'metric-critical';
      } else if (type === 'composite') {
        if (value >= 90) return 'metric-excellent';
        if (value >= 80) return 'metric-good';
        if (value >= 70) return 'metric-average';
        if (value >= 60) return 'metric-poor';
        return 'metric-critical';
      }
      return '';
    }

    // Fonction pour charger la synth√®se
    async function loadSummary() {
      const projectFilter = document.getElementById('project-filter').value;
      const monthValue = document.getElementById('month-filter').value;

      if (!monthValue) {
        alert('Veuillez s√©lectionner un mois');
        return;
      }

      const loadingOverlay = document.getElementById('loading-overlay');
      const loadingText = document.getElementById('loading-text');
      loadingOverlay.style.display = 'flex';

      try {
        // Filtrer les agents par projet
        let agentsToProcess = allAgents;
        if (projectFilter) {
          agentsToProcess = allAgents.filter(agent => {
            const rawProject = agent.project_name || agent.project || '';
            return normalizeProjectName(rawProject) === projectFilter;
          });
        }

        if (agentsToProcess.length === 0) {
          alert('Aucun agent trouv√© pour ce projet');
          loadingOverlay.style.display = 'none';
          return;
        }

        loadingText.textContent = `Chargement des rapports (0/${agentsToProcess.length})...`;
        summaryData = [];

        // Charger le rapport de chaque agent
        for (let i = 0; i < agentsToProcess.length; i++) {
          const agent = agentsToProcess[i];
          loadingText.textContent = `Chargement des rapports (${i + 1}/${agentsToProcess.length})... ${agent.name || agent.email}`;

          try {
            // Call the monthly report endpoint with GET and query parameters
            const params = new URLSearchParams({
              agentId: agent.id || agent.user_id,
              month: monthValue,
              ai: '0' // Disable AI for faster processing
            });

            console.log(`Chargement du rapport pour l'agent ${agent.id || agent.user_id}...`);
            const report = await api(`/agents/monthly-report?${params.toString()}`);
            console.log('R√©ponse brute de l\'API:', JSON.stringify(report, null, 2));

            // V√©rifier la structure de la r√©ponse
            if (report && report.success !== false) {
              // Le rapport mensuel retourne directement report.presence et report.activities
              // Pas besoin de report.data
              const presence = report.presence || report.meta?.presence || {};
              const activities = report.activities || report.meta?.activities || {};

              console.log('üîç Structure compl√®te du rapport re√ßu:', {
                hasPresence: !!presence,
                hasActivities: !!activities,
                presenceKeys: Object.keys(presence || {}),
                activitiesKeys: Object.keys(activities || {}),
                presenceObject: presence,
                activitiesObject: activities,
                reportKeys: Object.keys(report || {})
              });

              // V√©rifier si les donn√©es viennent bien de l'API
              if (!presence || Object.keys(presence).length === 0) {
                console.error('‚ùå ERREUR: Aucune donn√©e de pr√©sence trouv√©e dans le rapport!');
                console.error('Rapport complet:', JSON.stringify(report, null, 2));
              }

              if (!activities || Object.keys(activities).length === 0) {
                console.warn('‚ö†Ô∏è Aucune donn√©e d\'activit√©s trouv√©e dans le rapport');
              }

              // Extraire les valeurs de pr√©sence avec plusieurs fallbacks
              // Le rapport mensuel retourne directement presence.workedDays, presence.workingDays, etc.
              // Ces valeurs sont calcul√©es depuis les checkins et missions dans summarizePresence()
              const workedDays = Number(presence.workedDays || presence.daysWithPresence || 0);
              const workingDays = Number(presence.workingDays || presence.totalWorkingDays || 22);
              const permissionDays = Number(presence.permissionDays || 0);

              // Calculer le taux de pr√©sence si non fourni
              let presenceRate = Number(presence.presenceRate || 0);
              if (presenceRate === 0 && workingDays > 0 && workedDays > 0) {
                // Calculer le taux de pr√©sence: (jours travaill√©s / jours ouvrables) * 100
                presenceRate = Math.round((workedDays / workingDays) * 1000) / 10;
              }

              // Extraire les activit√©s - v√©rifier plusieurs emplacements
              const tepRate = Number(activities.performance?.executionRate || activities.tep || 0);
              const plannedTotal = Number(activities.total || 0);
              const realizedTotal = Number(activities.performance?.realized || 0);
              const notRealizedTotal = Number(activities.performance?.notRealized || 0);

              // Extraire le temps terrain et les missions
              // fieldTimeHours est calcul√© depuis les missions (date_start -> date_end) dans summarizePresence()
              // missionsCount est le nombre total de missions pour le mois
              const fieldTimeHours = Number(presence.fieldTimeHours || presence.fieldTime || 0);
              const missionsCount = Number(presence.missionsCount || 0);

              console.log('üìä Donn√©es extraites d√©taill√©es pour agent', agent.id || agent.user_id, ':', {
                presenceRaw: presence,
                workedDays,
                workingDays,
                permissionDays,
                presenceRate,
                fieldTimeHours,
                missionsCount,
                totalCheckins: presence.totalCheckins || 0,
                activitiesRaw: activities,
                plannedTotal,
                realizedTotal,
                notRealizedTotal,
                tepRate
              });

              // V√©rification: si workedDays est 1 pour tous, il y a un probl√®me
              if (workedDays === 1 && presence.totalCheckins > 1) {
                console.warn('‚ö†Ô∏è ATTENTION: workedDays = 1 mais totalCheckins > 1. Donn√©es de pr√©sence suspectes:', {
                  agentId: agent.id || agent.user_id,
                  workedDays,
                  totalCheckins: presence.totalCheckins,
                  presenceObject: presence
                });
              }

              // Calculer les heures moyennes par mission par jour
              // Si missionsCount > 0 et workedDays > 0, alors heures par mission par jour = fieldTimeHours / (missionsCount * workedDays)
              // Sinon, si missionsCount > 0, heures par mission = fieldTimeHours / missionsCount
              let avgHoursPerMissionPerDay = 0;
              if (false) { // Disabled to use correct logic in else if
                avgHoursPerMissionPerDay = fieldTimeHours / (missionsCount * workedDays);
              } else if (missionsCount > 0) {
                avgHoursPerMissionPerDay = fieldTimeHours / missionsCount;
              }

              // Normaliser le temps terrain pour le score (max 160h/mois = 100%)
              const fieldTimeScore = Math.min(100, (fieldTimeHours / 160) * 100);
              const compositeScore = (presenceRate * 0.7) + (tepRate * 0.15) + (fieldTimeScore * 0.15);

              console.log('üìä Donn√©es calcul√©es pour synth√®se:', {
                agentId: agent.id || agent.user_id,
                presenceRate,
                workedDays,
                workingDays,
                permissionDays,
                fieldTimeHours,
                missionsCount,
                avgHoursPerMissionPerDay,
                tepRate
              });

              summaryData.push({
                agentId: agent.id || agent.user_id,
                agentName: agent.name || `${agent.first_name || ''} ${agent.last_name || ''}`.trim() || agent.email,
                email: agent.email,
                project: agent.project_name || agent.project,
                presenceRate: presenceRate,
                workedDays: workedDays,
                totalDays: workingDays,
                permissionDays: permissionDays,
                fieldTimeHours: fieldTimeHours,
                missionsCount: missionsCount,
                avgHoursPerMissionPerDay: avgHoursPerMissionPerDay,
                plannedTotal: plannedTotal,
                realizedTotal: realizedTotal,
                notRealizedTotal: notRealizedTotal,
                tepRate: tepRate,
                compositeScore: compositeScore,
                rank: null // Sera rempli si disponible
              });
            }
          } catch (error) {
            console.error(`Erreur lors du chargement du rapport pour ${agent.name || agent.email}:`, error);
            // Ajouter quand m√™me l'agent avec des valeurs vides
            summaryData.push({
              agentId: agent.id || agent.user_id,
              agentName: agent.name || `${agent.first_name || ''} ${agent.last_name || ''}`.trim() || agent.email,
              email: agent.email,
              project: agent.project_name || agent.project,
              presenceRate: 0,
              workedDays: 0,
              totalDays: 22,
              permissionDays: 0,
              fieldTimeHours: 0,
              missionsCount: 0,
              avgHoursPerMissionPerDay: 0,
              plannedTotal: 0,
              realizedTotal: 0,
              notRealizedTotal: 0,
              tepRate: 0,
              compositeScore: 0,
              rank: null,
              error: true
            });
          }

          // Petit d√©lai pour ne pas surcharger le serveur
          await new Promise(resolve => setTimeout(resolve, 100));
        }

        // Trier par score composite d√©croissant
        summaryData.sort((a, b) => b.compositeScore - a.compositeScore);

        // Ajouter les rangs
        summaryData.forEach((data, index) => {
          data.rank = index + 1;
        });

        // Afficher le tableau
        renderSummaryTable();
        renderStatsSummary();

      } catch (error) {
        console.error('Erreur chargement synth√®se:', error);
        alert('Erreur lors du chargement de la synth√®se: ' + error.message);
      } finally {
        loadingOverlay.style.display = 'none';
      }
    }

    // Fonction pour afficher les statistiques globales
    function renderStatsSummary() {
      const statsContainer = document.getElementById('stats-summary');
      if (summaryData.length === 0) {
        statsContainer.style.display = 'none';
        return;
      }

      const totalAgents = summaryData.length;
      const avgPresence = summaryData.reduce((sum, d) => sum + d.presenceRate, 0) / totalAgents;
      const avgTEP = summaryData.reduce((sum, d) => sum + d.tepRate, 0) / totalAgents;
      const avgFieldTime = summaryData.reduce((sum, d) => sum + d.fieldTimeHours, 0) / totalAgents;
      const avgComposite = summaryData.reduce((sum, d) => sum + d.compositeScore, 0) / totalAgents;
      const totalFieldTime = summaryData.reduce((sum, d) => sum + d.fieldTimeHours, 0);
      const totalWorkedDays = summaryData.reduce((sum, d) => sum + d.workedDays, 0);
      const totalPermissionDays = summaryData.reduce((sum, d) => sum + (d.permissionDays || 0), 0);

      statsContainer.innerHTML = `
        <div class="stat-card">
          <div class="value">${totalAgents}</div>
          <div class="label">Agents</div>
        </div>
        <div class="stat-card">
          <div class="value">${avgPresence.toFixed(1)}%</div>
          <div class="label">Pr√©sence moyenne</div>
        </div>
        <div class="stat-card">
          <div class="value">${avgTEP.toFixed(1)}%</div>
          <div class="label">TEP moyen</div>
        </div>
        <div class="stat-card">
          <div class="value">${formatFieldTime(avgFieldTime)}</div>
          <div class="label">Temps terrain moyen</div>
        </div>
        <div class="stat-card">
          <div class="value">${avgComposite.toFixed(1)}</div>
          <div class="label">Score composite moyen</div>
        </div>
        <div class="stat-card">
          <div class="value">${formatFieldTime(totalFieldTime)}</div>
          <div class="label">Temps terrain total</div>
        </div>
        <div class="stat-card">
          <div class="value">${totalWorkedDays}</div>
          <div class="label">Jours pr√©sents total</div>
        </div>
        <div class="stat-card">
          <div class="value">${totalPermissionDays}</div>
          <div class="label">Jours permissionnaires total</div>
        </div>
      `;
      statsContainer.style.display = 'grid';
    }

    // Fonction pour afficher le tableau
    function renderSummaryTable() {
      const wrapper = document.getElementById('summary-table-wrapper');

      if (summaryData.length === 0) {
        wrapper.innerHTML = '<div class="text-center py-5 text-muted">Aucune donn√©e disponible</div>';
        return;
      }

      let tableHTML = `
        <table class="summary-table">
          <thead>
            <tr>
              <th rowspan="2">Rang</th>
              <th rowspan="2">Agent</th>
              <th colspan="4">Pr√©sence</th>
              <th colspan="1">Temps Terrain</th>
              <th colspan="3">Activit√©s</th>
              <th rowspan="2">TEP</th>
              <th rowspan="2">Score<br>Composite</th>
            </tr>
            <tr>
              <th>Taux</th>
              <th>Jours<br>Pr√©sents</th>
              <th>Jours<br>Permissionnaires</th>
              <th>Jours<br>attendus par mois</th>
              <th>Total</th>


              <th>Planifi√©es</th>
              <th>R√©alis√©es</th>
              <th>Non<br>r√©alis√©es</th>
            </tr>
          </thead>
          <tbody>
      `;

      summaryData.forEach((data, index) => {
        const presenceClass = getMetricClass(data.presenceRate, 'presence');
        const tepClass = getMetricClass(data.tepRate, 'tep');
        const fieldTimeClass = getMetricClass(data.fieldTimeHours, 'fieldTime');
        const compositeClass = getMetricClass(data.compositeScore, 'composite');
        const errorRow = data.error ? ' style="opacity: 0.6;"' : '';

        const avgHoursPerMissionPerDay = data.avgHoursPerMissionPerDay || 0;
        const formattedAvgHours = avgHoursPerMissionPerDay > 0
          ? `${avgHoursPerMissionPerDay.toFixed(2)}h`
          : '0h';

        tableHTML += `
          <tr${errorRow}>
            <td class="rank-cell">${data.rank}</td>
            <td class="agent-name">${escapeHtml(data.agentName)}</td>
            <td class="${presenceClass} metric-cell">${data.presenceRate.toFixed(1)}%</td>
            <td class="number-cell">${data.workedDays}</td>
            <td class="number-cell">${data.permissionDays || 0}</td>
            <td class="number-cell">${data.totalDays}</td>
            <td class="${fieldTimeClass} metric-cell">${formatFieldTime(data.fieldTimeHours)}</td>


            <td class="number-cell">${data.plannedTotal}</td>
            <td class="text-success fw-semibold number-cell">${data.realizedTotal}</td>
            <td class="text-danger fw-semibold number-cell">${data.notRealizedTotal}</td>
            <td class="${tepClass} metric-cell">${data.tepRate.toFixed(1)}%</td>
            <td class="${compositeClass} metric-cell">${data.compositeScore.toFixed(1)}</td>
          </tr>
        `;
      });

      tableHTML += `
          </tbody>
        </table>
      `;

      wrapper.innerHTML = tableHTML;
    }

    // Fonction d'√©chappement HTML
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // Fonction pour exporter en CSV
    function exportToCSV() {
      if (summaryData.length === 0) {
        alert('Aucune donn√©e √† exporter');
        return;
      }

      const monthValue = document.getElementById('month-filter').value;
      const projectFilter = document.getElementById('project-filter').value;
      const projectName = projectFilter || 'Tous_projets';
      const monthLabel = monthValue.replace('-', '_');
      const filename = `Synthese_${projectName}_${monthLabel}.csv`;

      // En-t√™tes CSV
      const headers = [
        'Rang', 'Agent', 'Projet',
        'Taux Pr√©sence (%)', 'Jours Pr√©sents', 'Jours Permissionnaires', 'Jours Ouvr√©s',
        'Temps Terrain Total (h)', 'Nombre Missions', 'Heures par Mission par Jour',
        'Activit√©s Planifi√©es', 'Activit√©s R√©alis√©es', 'Activit√©s Non r√©alis√©es',
        'TEP (%)', 'Score Composite'
      ];

      // Lignes de donn√©es
      const rows = summaryData.map(data => [
        data.rank,
        data.agentName,
        data.project || '',
        data.presenceRate.toFixed(1),
        data.workedDays,
        data.permissionDays || 0,
        data.totalDays,
        data.fieldTimeHours.toFixed(1),
        data.missionsCount || 0,
        (data.avgHoursPerMissionPerDay || 0).toFixed(2),
        data.plannedTotal,
        data.realizedTotal,
        data.notRealizedTotal,
        data.tepRate.toFixed(1),
        data.compositeScore.toFixed(1)
      ]);

      // Cr√©er le contenu CSV
      const csvContent = [
        headers.join(','),
        ...rows.map(row => row.map(cell => `"${String(cell).replace(/"/g, '""')}"`).join(','))
      ].join('\n');

      // T√©l√©charger
      const blob = new Blob(['\ufeff' + csvContent], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    // Fonction pour exporter en HTML
    function exportToHTML() {
      if (summaryData.length === 0) {
        alert('Aucune donn√©e √† exporter');
        return;
      }

      const monthValue = document.getElementById('month-filter').value;
      const projectFilter = document.getElementById('project-filter').value;
      const projectName = projectFilter || 'Tous_projets';
      const monthLabel = monthValue.replace('-', '_');
      const filename = `Synthese_${projectName}_${monthLabel}.html`;

      const tableHTML = document.querySelector('.summary-table').outerHTML;
      const statsHTML = document.getElementById('stats-summary').innerHTML;

      const htmlContent = `<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Synth√®se Globale - ${escapeHtml(projectName)} - ${escapeHtml(monthValue)}</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
  <style>
    body { padding: 20px; background: #f8f9fa; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
    .summary-table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
    .summary-table thead { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
    .summary-table th { padding: 12px 8px; text-align: center; font-weight: 600; border: 1px solid rgba(255, 255, 255, 0.2); }
    .summary-table td { padding: 10px 8px; text-align: center; border: 1px solid #dee2e6; }
    .summary-table tbody tr:nth-child(even) { background-color: #f8f9fa; }
    .agent-name { font-weight: 600; color: #2c3e50; text-align: left !important; padding-left: 15px !important; }
    .metric-excellent { background-color: #d4edda; color: #155724; font-weight: 600; }
    .metric-good { background-color: #d1ecf1; color: #0c5460; font-weight: 600; }
    .metric-average { background-color: #fff3cd; color: #856404; font-weight: 600; }
    .metric-poor { background-color: #f8d7da; color: #721c24; font-weight: 600; }
    .metric-critical { background-color: #f5c6cb; color: #721c24; font-weight: 700; }
    .stats-summary { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px; }
    .stat-card { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 10px; text-align: center; }
    .stat-card .value { font-size: 2rem; font-weight: bold; margin-bottom: 5px; }
    .stat-card .label { font-size: 0.9rem; opacity: 0.9; }
    @media print { body { padding: 0; } }
  </style>
</head>
<body>
  <div class="container">
    <h1 class="mb-4">Synth√®se Globale - ${escapeHtml(projectName)}</h1>
    <p class="text-muted">P√©riode : ${escapeHtml(monthValue)} | G√©n√©r√© le ${new Date().toLocaleString('fr-FR')}</p>
    <div class="stats-summary">${statsHTML}</div>
    ${tableHTML}
  </div>
</body>
</html>`;

      const blob = new Blob([htmlContent], { type: 'text/html;charset=utf-8' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    // Initialisation
    document.addEventListener('DOMContentLoaded', async () => {
      // D√©finir le mois actuel par d√©faut
      const now = new Date();
      const currentMonth = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
      document.getElementById('month-filter').value = currentMonth;

      // Charger les projets
      await loadProjects();
    });
  </script>
</body>

</html>