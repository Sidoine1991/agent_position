<!doctype html>
<html lang="fr">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="manifest" href="/manifest.webmanifest" />
    <meta name="theme-color" content="#0ea5e9" />
    <title>Messages - Presence CCRB</title>
    <script src="/auth.js?v=2" defer></script>
    <script src="/components/circular-nav.js" type="module"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <link rel="stylesheet" href="/styles.css?v=2" />
    <link rel="stylesheet" href="/styles-shared.css" />
    <link rel="stylesheet" href="/contrast-fixes.css" />
    <style>
      /* Styles pour l'indicateur de chargement */
      .loading-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(255, 255, 255, 0.8);
        z-index: 1000;
        display: flex;
        justify-content: center;
        align-items: center;
        flex-direction: column;
      }
      
      .loading-spinner {
        width: 3rem;
        height: 3rem;
        border: 5px solid #f3f3f3;
        border-top: 5px solid #0d6efd;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin-bottom: 1rem;
      }
      
      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }
      
      .loading-text {
        color: #0d6efd;
        font-weight: 500;
      }
      
      /* Styles pour la section des param√®tres de notification */
      .notification-settings-panel {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 90%;
        max-width: 500px;
        max-height: 80vh;
        background: white;
        border-radius: 12px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        z-index: 1050;
        overflow: hidden;
        border: 1px solid #dee2e6;
      }
      
      .notification-settings-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 1rem 1.5rem;
        background: linear-gradient(135deg, #0d6efd, #0b5ed7);
        color: white;
        border-bottom: 1px solid #dee2e6;
      }
      
      .notification-settings-title {
        margin: 0;
        font-size: 1.25rem;
        font-weight: 600;
      }
      
      .notification-settings-body {
        padding: 1.5rem;
        max-height: 60vh;
        overflow-y: auto;
      }
      
      .notification-settings-footer {
        display: flex;
        justify-content: flex-end;
        gap: 0.5rem;
        padding: 1rem 1.5rem;
        background: #f8f9fa;
        border-top: 1px solid #dee2e6;
      }
      
      .notification-settings-backdrop {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 1040;
      }
      
      /* Animation pour l'ouverture/fermeture */
      .notification-settings-panel.show {
        animation: slideInDown 0.3s ease-out;
      }
      
      .notification-settings-panel.hide {
        animation: slideOutUp 0.3s ease-in;
      }
      
      @keyframes slideInDown {
        from {
          opacity: 0;
          transform: translate(-50%, -60%);
        }
        to {
          opacity: 1;
          transform: translate(-50%, -50%);
        }
      }
      
      @keyframes slideOutUp {
        from {
          opacity: 1;
          transform: translate(-50%, -50%);
        }
        to {
          opacity: 0;
          transform: translate(-50%, -60%);
        }
      }
      
      /* Interface moderne de messagerie */
      .messaging-container {
        height: calc(100vh - 120px);
        display: flex;
        background: #f8f9fa;
        border-radius: 15px;
        overflow: hidden;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
      }
      
      /* Sidebar gauche - Contacts et Forums */
      .sidebar {
        width: 350px;
        background: white;
        border-right: 1px solid #e9ecef;
        display: flex;
        flex-direction: column;
      }
      
      .sidebar-header {
        padding: 20px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-bottom: 1px solid #e9ecef;
      }
      
      .search-box {
        position: relative;
        margin-bottom: 15px;
      }
      
      .search-box input {
        width: 100%;
        padding: 10px 15px 10px 40px;
        border: none;
        border-radius: 25px;
        background: rgba(255, 255, 255, 0.2);
        color: white;
        backdrop-filter: blur(10px);
      }
      
      .search-box input::placeholder {
        color: rgba(255, 255, 255, 0.7);
      }
      
      .search-box i {
        position: absolute;
        left: 15px;
        top: 50%;
        transform: translateY(-50%);
        color: rgba(255, 255, 255, 0.7);
      }
      
      .tabs {
        display: flex;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 10px;
        padding: 5px;
        margin-bottom: 15px;
      }
      
      .tab {
        flex: 1;
        padding: 8px 12px;
        text-align: center;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.3s ease;
        font-size: 14px;
        font-weight: 500;
      }
      
      .tab.active {
        background: white;
        color: #667eea;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }
      
      .tab:not(.active) {
        color: rgba(255, 255, 255, 0.7);
      }
      
      /* Liste des contacts */
      .contacts-list {
        flex: 1;
        overflow-y: auto;
        padding: 10px;
      }
      
      .contact-item {
        display: flex;
        align-items: center;
        padding: 15px;
        margin-bottom: 8px;
        border-radius: 12px;
        cursor: pointer;
        transition: all 0.3s ease;
        position: relative;
      }
      
      .contact-item:hover {
        background: #f8f9fa;
        transform: translateX(5px);
      }
      
      .contact-item.active {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
      }
      
      .contact-avatar {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        font-size: 18px;
        margin-right: 15px;
        position: relative;
      }
      
      .contact-item:not(.active) .contact-avatar {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
      }
      
      .contact-item.active .contact-avatar {
        background: rgba(255, 255, 255, 0.2);
        color: white;
      }
      
      .online-indicator {
        position: absolute;
        bottom: 2px;
        right: 2px;
        width: 12px;
        height: 12px;
        border-radius: 50%;
        border: 2px solid white;
      }
      
      .online-indicator.online {
        background: #28a745;
      }
      
      .online-indicator.offline {
        background: #6c757d;
      }
      
      .contact-info {
        flex: 1;
        min-width: 0;
      }
      
      .contact-name {
        font-weight: 600;
        font-size: 16px;
        margin-bottom: 4px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }
      
      .contact-role {
        font-size: 12px;
        opacity: 0.7;
        margin-bottom: 4px;
      }
      
      .last-message {
        font-size: 14px;
        opacity: 0.8;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }
      
      .message-meta {
        display: flex;
        flex-direction: column;
        align-items: flex-end;
        gap: 5px;
      }
      
      .message-time {
        font-size: 11px;
        opacity: 0.6;
      }
      
      .unread-badge {
        background: #ff4757;
        color: white;
        border-radius: 50%;
        width: 20px;
        height: 20px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 11px;
        font-weight: bold;
      }
      
      /* Zone de chat principale */
      .chat-area {
        flex: 1;
        display: flex;
        flex-direction: column;
        background: white;
      }
      
      .chat-header {
        padding: 20px;
        background: white;
        border-bottom: 1px solid #e9ecef;
        display: flex;
        align-items: center;
        justify-content: space-between;
      }
      
      .chat-user-info {
        display: flex;
        align-items: center;
      }
      
      .chat-user-avatar {
        width: 45px;
        height: 45px;
        border-radius: 50%;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        margin-right: 15px;
        position: relative;
      }
      
      .chat-user-details h6 {
        margin: 0;
        font-weight: 600;
        color: #333;
      }
      
      .chat-user-status {
        font-size: 12px;
        color: #28a745;
        display: flex;
        align-items: center;
        gap: 5px;
      }
      
      .chat-actions {
        display: flex;
        gap: 10px;
      }
      
      .chat-action-btn {
        width: 40px;
        height: 40px;
        border: none;
        border-radius: 50%;
        background: #f8f9fa;
        color: #6c757d;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.3s ease;
      }
      
      .chat-action-btn:hover {
        background: #e9ecef;
        color: #495057;
      }
      
      /* Messages */
      .messages-container {
        flex: 1;
        overflow-y: auto;
        padding: 20px;
        background: #f8f9fa;
        background-image: 
          radial-gradient(circle at 20% 80%, rgba(120, 119, 198, 0.1) 0%, transparent 50%),
          radial-gradient(circle at 80% 20%, rgba(255, 119, 198, 0.1) 0%, transparent 50%);
      }
      
      .message {
        margin-bottom: 20px;
        display: flex;
        align-items: flex-end;
        animation: messageSlide 0.3s ease-out;
      }
      
      @keyframes messageSlide {
        from {
          opacity: 0;
          transform: translateY(20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      
      .message.sent {
        justify-content: flex-end;
      }
      
      .message.received {
        justify-content: flex-start;
      }
      
      .message-content {
        max-width: 70%;
        display: flex;
        flex-direction: column;
        gap: 5px;
      }
      
      .message-bubble {
        padding: 12px 18px;
        border-radius: 20px;
        position: relative;
        word-wrap: break-word;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }
      
      .message.sent .message-bubble {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-bottom-right-radius: 8px;
      }
      
      .message.received .message-bubble {
        background: white;
        color: #333;
        border: 1px solid #e9ecef;
        border-bottom-left-radius: 8px;
      }
      
      .message-time {
        font-size: 11px;
        opacity: 0.6;
        text-align: right;
      }
      
      .message.received .message-time {
        text-align: left;
      }
      
      .message-status {
        font-size: 10px;
        margin-top: 2px;
        text-align: right;
      }
      
      .typing-indicator {
        display: flex;
        align-items: center;
        gap: 5px;
        font-style: italic;
        color: #6c757d;
        font-size: 14px;
        padding: 10px 15px;
        background: white;
        border-radius: 20px;
        margin-bottom: 10px;
        max-width: 200px;
      }
      
      .typing-dots {
        display: flex;
        gap: 3px;
      }
      
      .typing-dot {
        width: 6px;
        height: 6px;
        border-radius: 50%;
        background: #6c757d;
        animation: typingDot 1.4s infinite ease-in-out;
      }
      
      .typing-dot:nth-child(2) {
        animation-delay: 0.2s;
      }
      
      .typing-dot:nth-child(3) {
        animation-delay: 0.4s;
      }
      
      @keyframes typingDot {
        0%, 60%, 100% {
          transform: scale(1);
          opacity: 0.5;
        }
        30% {
          transform: scale(1.2);
          opacity: 1;
        }
      }
      
      /* Zone de saisie */
      .message-input-area {
        padding: 20px;
        background: white;
        border-top: 1px solid #e9ecef;
      }
      
      .input-container {
        display: flex;
        align-items: flex-end;
        gap: 10px;
        background: #f8f9fa;
        border-radius: 25px;
        padding: 10px 15px;
        border: 1px solid #e9ecef;
        transition: all 0.3s ease;
      }
      
      .input-container:focus-within {
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
      }
      
      .message-input {
        flex: 1;
        border: none;
        background: transparent;
        outline: none;
        resize: none;
        max-height: 120px;
        font-size: 14px;
        line-height: 1.4;
      }
      
      .message-input::placeholder {
        color: #6c757d;
      }
      
      .input-actions {
        display: flex;
        gap: 5px;
        align-items: center;
      }
      
      .input-btn {
        width: 35px;
        height: 35px;
        border: none;
        border-radius: 50%;
        background: transparent;
        color: #6c757d;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.3s ease;
      }
      
      .input-btn:hover {
        background: #e9ecef;
        color: #495057;
      }
      
      .input-btn.primary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
      }
      
      .input-btn.primary:hover {
        transform: scale(1.05);
        box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
      }
      
      /* Statut de connexion */
      .connection-status {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 1000;
        padding: 8px 15px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 8px;
        backdrop-filter: blur(10px);
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
      }
      
      .connection-status.online {
        background: rgba(40, 167, 69, 0.9);
        color: white;
      }
      
      .connection-status.offline {
        background: rgba(220, 53, 69, 0.9);
        color: white;
      }
      
      /* Forum de discussion */
      .forum-section {
        display: none;
      }
      
      .forum-section.active {
        display: block;
      }
      
      .forum-categories {
        padding: 15px;
      }
      
      .forum-category {
        background: white;
        border-radius: 12px;
        padding: 15px;
        margin-bottom: 10px;
        cursor: pointer;
        transition: all 0.3s ease;
        border: 1px solid #e9ecef;
      }
      
      .forum-category:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
      }
      
      .forum-category-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 8px;
      }
      
      .forum-category-title {
        font-weight: 600;
        color: #333;
        margin: 0;
      }
      
      .forum-category-count {
        background: #667eea;
        color: white;
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 11px;
        font-weight: 600;
      }
      
      .forum-category-description {
        font-size: 12px;
        color: #6c757d;
        margin: 0;
      }
      
      /* Responsive */
      @media (max-width: 768px) {
        .sidebar {
          width: 100%;
        }
        
        .chat-area {
          display: none;
        }
        
        .chat-area.active {
          display: flex;
        }
        
        .messaging-container {
          height: calc(100vh - 80px);
        }
      }
      
      /* Animations */
      .fade-in {
        animation: fadeIn 0.5s ease-in;
      }
      
      @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
      }
      
      .slide-in-right {
        animation: slideInRight 0.3s ease-out;
      }
      
      @keyframes slideInRight {
        from {
          transform: translateX(100%);
          opacity: 0;
        }
        to {
          transform: translateX(0);
          opacity: 1;
        }
      }
      
      .notification-settings-btn {
        position: absolute;
        top: 20px;
        right: 20px;
        z-index: 1000;
      }
      
      .notification-settings-btn .btn {
        border-radius: 20px;
        padding: 8px 16px;
        font-size: 14px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        transition: all 0.3s ease;
      }
      
      .notification-settings-btn .btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      }
    </style>
  </head>
  <body>
    <!-- Barre de navigation circulaire -->
    <script src="/js/circular-nav-component.js"></script>
    <circular-nav></circular-nav>

    <!-- Main Content -->
    <main class="main-content">
      <div class="page-header">
        <h2>üí¨ Messages & Forum</h2>
        <p>Communiquez avec votre √©quipe et participez aux discussions</p>
      </div>

      <!-- Statut de connexion -->
      <div id="connection-status" class="connection-status offline">
        <i class="bi bi-wifi-off"></i>
        <span>Connexion...</span>
      </div>

      <!-- Bouton des param√®tres de notification -->
      <div class="notification-settings-btn">
        <button class="btn btn-outline-primary btn-sm" onclick="toggleNotificationSettings()" title="Param√®tres de notification">
          <i class="bi bi-gear"></i> Notifications
        </button>
      </div>

      <!-- Interface de messagerie moderne -->
      <div class="messaging-container">
        <!-- Sidebar gauche -->
        <div class="sidebar">
          <!-- En-t√™te avec recherche et onglets -->
          <div class="sidebar-header">
            <div class="search-box">
              <i class="bi bi-search"></i>
              <input type="text" id="search-contacts" placeholder="Rechercher un contact...">
            </div>
            
            <!-- Onglets Contacts/Forum -->
            <div class="tabs">
              <div class="tab active" data-tab="contacts" id="tab-contacts">
                <i class="bi bi-people"></i> Contacts
              </div>
              <div class="tab" data-tab="forum" id="tab-forum">
                <i class="bi bi-chat-square-dots"></i> Forum
              </div>
            </div>
          </div>

          <!-- Liste des contacts -->
          <div class="contacts-list" id="contacts-list">
            <!-- Les contacts seront charg√©s ici -->
          </div>

          <!-- Forum de discussion -->
          <div class="forum-section" id="forum-section">
            <!-- En-t√™te avec bouton de rafra√Æchissement -->
            <div class="d-flex justify-content-between align-items-center mb-3">
              <h5 class="mb-0">Forums de discussion</h5>
              <button id="refresh-forums-btn" class="btn btn-sm btn-outline-secondary" title="Rafra√Æchir">
                <i class="bi bi-arrow-clockwise"></i>
              </button>
            </div>
            
            <!-- Indicateur de chargement -->
            <div id="forum-loading" class="loading-overlay" style="display: none;">
              <div class="loading-spinner"></div>
              <div class="loading-text">Chargement des forums...</div>
            </div>
            
            <!-- Conteneur des cat√©gories -->
            <div class="forum-categories" id="forum-categories">
              <div class="text-center py-4">
                <div class="spinner-border text-primary" role="status">
                  <span class="visually-hidden">Chargement des forums...</span>
                </div>
                <p class="mt-2 text-muted">Chargement des forums en cours...</p>
              </div>
            </div>
            <div id="forum-thread" style="display:none">
              <div class="d-flex justify-content-between align-items-center mb-2">
                <button class="btn btn-sm btn-outline-secondary" id="forum-back-btn"><i class="bi bi-arrow-left"></i> Retour</button>
                <button class="btn btn-sm btn-outline-secondary" id="forum-refresh-btn" title="Rafra√Æchir"><i class="bi bi-arrow-clockwise"></i></button>
              </div>
              <div class="messages-container" id="forum-messages"></div>
              <div class="message-input-area">
                <div class="input-container">
                  <textarea class="message-input" id="forum-input" placeholder="√âcrire un message au forum..." rows="1"></textarea>
                  <div class="input-actions">
                    <button class="input-btn primary" id="forum-send-btn" title="Envoyer"><i class="bi bi-send"></i></button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Zone de chat principale -->
        <div class="chat-area" id="chat-area">
          <!-- En-t√™te du chat -->
          <div class="chat-header" id="chat-header">
            <div class="chat-user-info">
              <div class="chat-user-avatar" id="chat-user-avatar">
                <i class="bi bi-person"></i>
              </div>
              <div class="chat-user-details">
                <h6 id="chat-user-name">S√©lectionnez un contact</h6>
                <div class="chat-user-status" id="chat-user-status">
                  <i class="bi bi-circle-fill"></i>
                  <span>Hors ligne</span>
                </div>
              </div>
            </div>
            <div class="chat-actions">
              <button class="chat-action-btn" id="video-call-btn" title="Appel vid√©o">
                <i class="bi bi-camera-video"></i>
              </button>
              <button class="chat-action-btn" id="voice-call-btn" title="Appel vocal">
                <i class="bi bi-telephone"></i>
              </button>
              <button class="chat-action-btn" id="refresh-chat-btn" title="Rafra√Æchir la discussion">
                <i class="bi bi-arrow-clockwise"></i>
              </button>
              <button class="chat-action-btn" id="more-options-btn" title="Plus d'options">
                <i class="bi bi-three-dots-vertical"></i>
              </button>
            </div>
          </div>

          <!-- Messages -->
          <div class="messages-container" id="messages-container">
            <div class="text-center text-muted" id="no-conversation">
              <i class="bi bi-chat-dots" style="font-size: 3rem; opacity: 0.3;"></i>
              <p style="margin-top: 15px;">S√©lectionnez un contact ou une cat√©gorie de forum pour commencer</p>
            </div>
          </div>

          <!-- Zone de saisie -->
          <div class="message-input-area" id="message-input-area" style="display: none;">
            <div class="input-container">
              <textarea 
                class="message-input" 
                id="message-input" 
                placeholder="Tapez votre message..."
                rows="1"
              ></textarea>
              <div class="input-actions">
                <button class="input-btn" id="emoji-btn" title="Emoji">
                  <i class="bi bi-emoji-smile"></i>
                </button>
                <button class="input-btn" id="attachment-btn" title="Fichier">
                  <i class="bi bi-paperclip"></i>
                </button>
                <button class="input-btn" id="voice-btn" title="Message vocal">
                  <i class="bi bi-mic"></i>
                </button>
                <button class="input-btn" id="photo-btn" title="Photo">
                  <i class="bi bi-camera"></i>
                </button>
                <button class="input-btn primary" id="send-btn" title="Envoyer">
                  <i class="bi bi-send"></i>
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
    <script>
      // Variables de cache pour les forums
      let forumCategoriesCache = null;
      let lastFetchTime = 0;
      const CACHE_DURATION = 5 * 60 * 1000; // 5 minutes

      // Fonction pour obtenir les en-t√™tes d'authentification
      function authHeaders() {
        const token = localStorage.getItem('jwt');
        return token ? { 'Authorization': `Bearer ${token}` } : {};
      }
      
      // V√©rification de l'authentification
      async function checkAuth() {
        const token = localStorage.getItem('jwt');
        if (!token) {
          window.location.href = '/login.html';
          return false;
        }
        return true;
      }

      // Mise √† jour du statut en ligne
      async function updateOnlineStatus() {
        try {
          const response = await fetch('/api/users/online', {
            method: 'POST',
            headers: {
              ...authHeaders(),
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({ is_online: true })
          });
          if (!response.ok) throw new Error('Erreur de mise √† jour du statut');
        } catch (error) {
          console.error('Erreur mise √† jour statut en ligne:', error);
        }
      }
      
      // Fonction pour afficher une alerte
      function showAlert(message, type = 'info') {
        const alertDiv = document.createElement('div');
        alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
        alertDiv.role = 'alert';
        alertDiv.innerHTML = `
          ${message}
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        `;
        
        const container = document.querySelector('.main-content') || document.body;
        container.prepend(alertDiv);
        
        // Supprimer l'alerte apr√®s 5 secondes
        setTimeout(() => {
          alertDiv.remove();
        }, 5000);
      }

      // Mettre √† jour l'√©tat en ligne toutes les 30 secondes
      setInterval(updateOnlineStatus, 30000);

      // Appeler une premi√®re fois au chargement
      document.addEventListener('DOMContentLoaded', () => {
        updateOnlineStatus();
        
        // Initialiser les tooltips Bootstrap
        const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
        tooltipTriggerList.map(function (tooltipTriggerEl) {
          return new bootstrap.Tooltip(tooltipTriggerEl);
        });
      });
    </script>
    <!-- <script src="/app.js"></script> -->
    <script src="/advanced-messaging.js"></script>
    
    <!-- Composants de notification -->
    <script src="/components/notification-bubble.js"></script>
    <script src="/components/realtime-messaging.js"></script>
    <script src="/components/notification-sounds.js"></script>
    <script src="/components/notification-manager.js"></script>
    <script src="/debug-messaging.js"></script>
    
    <!-- Section des param√®tres de notification -->
    <div id="notification-settings-section" class="notification-settings-panel" style="display: none;">
      <div class="notification-settings-header">
        <h5 class="notification-settings-title">
          <i class="bi bi-bell"></i> Param√®tres de notification
        </h5>
        <button type="button" class="btn-close" onclick="toggleNotificationSettings()" aria-label="Fermer"></button>
      </div>
      
      <div class="notification-settings-body">
        <form id="notificationSettingsForm">
          <!-- Notifications desktop -->
          <div class="mb-3">
            <div class="form-check form-switch">
              <input class="form-check-input" type="checkbox" id="enableDesktopNotifications" checked>
              <label class="form-check-label" for="enableDesktopNotifications">
                <i class="bi bi-desktop"></i> Notifications desktop
              </label>
            </div>
            <small class="text-muted">Afficher les notifications m√™me quand l'application est en arri√®re-plan</small>
          </div>

          <!-- Bulles de notification -->
          <div class="mb-3">
            <div class="form-check form-switch">
              <input class="form-check-input" type="checkbox" id="enableBubbleNotifications" checked>
              <label class="form-check-label" for="enableBubbleNotifications">
                <i class="bi bi-chat-bubble"></i> Bulles de notification
              </label>
            </div>
            <small class="text-muted">Afficher des bulles flottantes pour les nouveaux messages</small>
          </div>

          <!-- Sons de notification -->
          <div class="mb-3">
            <div class="form-check form-switch">
              <input class="form-check-input" type="checkbox" id="enableNotificationSounds" checked>
              <label class="form-check-label" for="enableNotificationSounds">
                <i class="bi bi-volume-up"></i> Sons de notification
              </label>
            </div>
            <small class="text-muted">Jouer un son pour les nouveaux messages</small>
          </div>

          <!-- Vibration -->
          <div class="mb-3">
            <div class="form-check form-switch">
              <input class="form-check-input" type="checkbox" id="enableVibration" checked>
              <label class="form-check-label" for="enableVibration">
                <i class="bi bi-phone-vibrate"></i> Vibration
              </label>
            </div>
            <small class="text-muted">Vibrer le t√©l√©phone pour les nouveaux messages</small>
          </div>

          <!-- Dur√©e des bulles -->
          <div class="mb-3">
            <label for="bubbleDuration" class="form-label">
              <i class="bi bi-clock"></i> Dur√©e d'affichage des bulles
            </label>
            <select class="form-select" id="bubbleDuration">
              <option value="3000">3 secondes</option>
              <option value="5000" selected>5 secondes</option>
              <option value="10000">10 secondes</option>
              <option value="0">Ne jamais fermer automatiquement</option>
            </select>
          </div>

          <!-- Volume des sons -->
          <div class="mb-3">
            <label for="soundVolume" class="form-label">
              <i class="bi bi-volume-up"></i> Volume des sons
            </label>
            <input type="range" class="form-range" id="soundVolume" min="0" max="1" step="0.1" value="0.3">
            <div class="d-flex justify-content-between">
              <small class="text-muted">Silencieux</small>
              <small class="text-muted">Fort</small>
            </div>
          </div>

          <!-- Test des notifications -->
          <div class="mb-3">
            <label class="form-label">Tester les notifications</label>
            <div class="d-grid gap-2 d-md-flex">
              <button type="button" class="btn btn-outline-primary btn-sm" onclick="testNotification('message')">
                <i class="bi bi-chat"></i> Test message
              </button>
              <button type="button" class="btn btn-outline-warning btn-sm" onclick="testNotification('urgent')">
                <i class="bi bi-exclamation-triangle"></i> Test urgent
              </button>
              <button type="button" class="btn btn-outline-info btn-sm" onclick="testNotification('system')">
                <i class="bi bi-bell"></i> Test syst√®me
              </button>
            </div>
          </div>

          <!-- Statut des permissions -->
          <div class="mb-3">
            <label class="form-label">Statut des permissions</label>
            <div id="permissionsStatus">
              <div class="d-flex align-items-center mb-2">
                <i class="bi bi-desktop me-2"></i>
                <span>Notifications desktop: </span>
                <span id="desktopPermissionStatus" class="badge bg-secondary ms-2">V√©rification...</span>
              </div>
              <div class="d-flex align-items-center mb-2">
                <i class="bi bi-volume-up me-2"></i>
                <span>Audio: </span>
                <span id="audioPermissionStatus" class="badge bg-secondary ms-2">V√©rification...</span>
              </div>
              <div class="d-flex align-items-center">
                <i class="bi bi-phone-vibrate me-2"></i>
                <span>Vibration: </span>
                <span id="vibrationPermissionStatus" class="badge bg-secondary ms-2">V√©rification...</span>
              </div>
            </div>
          </div>
        </form>
      </div>
      
      <div class="notification-settings-footer">
        <button type="button" class="btn btn-secondary" onclick="toggleNotificationSettings()">Annuler</button>
        <button type="button" class="btn btn-primary" onclick="saveNotificationSettings()">
          <i class="bi bi-check"></i> Enregistrer
        </button>
      </div>
    </div>
    <script>
      // Fonctions pour les param√®tres de notification (section au lieu de modal)
      let notificationSettingsVisible = false;
      let backdrop = null;
      
      window.toggleNotificationSettings = function() {
        const panel = document.getElementById('notification-settings-section');
        
        if (notificationSettingsVisible) {
          // Fermer la section
          closeNotificationSettings();
        } else {
          // Ouvrir la section
          openNotificationSettings();
        }
      };
      
      window.openNotificationSettings = function() {
        const panel = document.getElementById('notification-settings-section');
        
        if (!panel) {
          console.error('‚ùå Section des param√®tres non trouv√©e');
          return;
        }
        
        // Cr√©er le backdrop
        backdrop = document.createElement('div');
        backdrop.className = 'notification-settings-backdrop';
        backdrop.onclick = closeNotificationSettings;
        document.body.appendChild(backdrop);
        
        // Afficher la section
        panel.style.display = 'block';
        panel.classList.add('show');
        notificationSettingsVisible = true;
        
        // Charger les param√®tres et permissions
        loadNotificationSettings();
        updatePermissionsStatus();
        
        console.log('‚úÖ Section des param√®tres ouverte');
      };
      
      window.closeNotificationSettings = function() {
        const panel = document.getElementById('notification-settings-section');
        
        if (!panel) {
          console.error('‚ùå Section des param√®tres non trouv√©e');
          return;
        }
        
        // Animation de fermeture
        panel.classList.remove('show');
        panel.classList.add('hide');
        
        // Supprimer le backdrop
        if (backdrop) {
          backdrop.remove();
          backdrop = null;
        }
        
        // Masquer apr√®s l'animation
        setTimeout(() => {
          panel.style.display = 'none';
          panel.classList.remove('hide');
          notificationSettingsVisible = false;
          console.log('‚úÖ Section des param√®tres ferm√©e');
        }, 300);
      };
      
      window.saveNotificationSettings = function() {
        if (window.notificationManager) {
          const settings = {
            enableDesktop: document.getElementById('enableDesktopNotifications')?.checked || false,
            enableBubbles: document.getElementById('enableBubbleNotifications')?.checked || false,
            enableSounds: document.getElementById('enableNotificationSounds')?.checked || false,
            enableVibration: document.getElementById('enableVibration')?.checked || false,
            bubbleDuration: parseInt(document.getElementById('bubbleDuration')?.value) || 5000,
            soundVolume: parseFloat(document.getElementById('soundVolume')?.value) || 0.3
          };
          
          // Appliquer les param√®tres
          Object.keys(settings).forEach(key => {
            window.notificationManager.setSetting(key, settings[key]);
          });
          
          // Afficher une confirmation
          showToast('Param√®tres sauvegard√©s', 'success');
          
          // Fermer la section apr√®s un court d√©lai
          setTimeout(() => {
            closeNotificationSettings();
          }, 500);
        }
      };
      
      window.testNotification = function(type) {
        if (window.notificationManager) {
          window.notificationManager.testNotification(type);
        }
      };
      
      function loadNotificationSettings() {
        if (window.notificationManager) {
          const settings = window.notificationManager.getSettings();
          
          const enableDesktop = document.getElementById('enableDesktopNotifications');
          const enableBubbles = document.getElementById('enableBubbleNotifications');
          const enableSounds = document.getElementById('enableNotificationSounds');
          const enableVibration = document.getElementById('enableVibration');
          const bubbleDuration = document.getElementById('bubbleDuration');
          const soundVolume = document.getElementById('soundVolume');
          
          if (enableDesktop) enableDesktop.checked = settings.enableDesktop;
          if (enableBubbles) enableBubbles.checked = settings.enableBubbles;
          if (enableSounds) enableSounds.checked = settings.enableSounds;
          if (enableVibration) enableVibration.checked = settings.enableVibration;
          if (bubbleDuration) bubbleDuration.value = settings.bubbleDuration;
          if (soundVolume) soundVolume.value = settings.soundVolume;
        }
      }
      
      function updatePermissionsStatus() {
        if (window.notificationManager) {
          const permissions = window.notificationManager.getPermissions();
          
          // Notifications desktop
          const desktopStatus = document.getElementById('desktopPermissionStatus');
          if (desktopStatus) {
            if (permissions.notification === 'granted') {
              desktopStatus.textContent = 'Autoris√©';
              desktopStatus.className = 'badge bg-success ms-2';
            } else if (permissions.notification === 'denied') {
              desktopStatus.textContent = 'Refus√©';
              desktopStatus.className = 'badge bg-danger ms-2';
            } else {
              desktopStatus.textContent = 'Non demand√©';
              desktopStatus.className = 'badge bg-warning ms-2';
            }
          }
          
          // Audio
          const audioStatus = document.getElementById('audioPermissionStatus');
          if (audioStatus) {
            if (permissions.sound) {
              audioStatus.textContent = 'Support√©';
              audioStatus.className = 'badge bg-success ms-2';
            } else {
              audioStatus.textContent = 'Non support√©';
              audioStatus.className = 'badge bg-danger ms-2';
            }
          }
          
          // Vibration
          const vibrationStatus = document.getElementById('vibrationPermissionStatus');
          if (vibrationStatus) {
            if (permissions.vibration) {
              vibrationStatus.textContent = 'Support√©';
              vibrationStatus.className = 'badge bg-success ms-2';
            } else {
              vibrationStatus.textContent = 'Non support√©';
              vibrationStatus.className = 'badge bg-danger ms-2';
            }
          }
        }
      }
      
      function showToast(message, type = 'info') {
        // Cr√©er un toast de notification
        let toastContainer = document.getElementById('toast-container');
        if (!toastContainer) {
          toastContainer = document.createElement('div');
          toastContainer.id = 'toast-container';
          toastContainer.className = 'toast-container position-fixed top-0 end-0 p-3';
          toastContainer.style.zIndex = '1055';
          document.body.appendChild(toastContainer);
        }
        
        const toast = document.createElement('div');
        toast.className = `toast align-items-center text-white bg-${type} border-0`;
        toast.setAttribute('role', 'alert');
        toast.innerHTML = `
          <div class="d-flex">
            <div class="toast-body">${message}</div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
          </div>
        `;
        
        toastContainer.appendChild(toast);
        
        const bsToast = new bootstrap.Toast(toast);
        bsToast.show();
        
        // Supprimer le toast apr√®s fermeture
        toast.addEventListener('hidden.bs.toast', () => {
          toast.remove();
        });
      }

      // Gestion de la touche √âchap pour fermer la section
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && notificationSettingsVisible) {
          closeNotificationSettings();
        }
      });
      
      console.log('‚úÖ Section des param√®tres de notification pr√™te');
    </script>
    
    <script>
      // Initialiser la page de messagerie moderne
      document.addEventListener('DOMContentLoaded', () => {
        initializeModernMessaging();
      });

      function initializeModernMessaging() {
        // Attendre que le syst√®me de messagerie avanc√© soit initialis√©
        if (!window.advancedMessaging) {
          setTimeout(initializeModernMessaging, 100);
          return;
        }

        console.log('üí¨ Syst√®me de messagerie moderne initialis√©');
        
        // Ajouter des fonctionnalit√©s suppl√©mentaires
        setupAdditionalFeatures();
      }

      function setupAdditionalFeatures() {
        // Auto-resize du textarea
        const messageInput = document.getElementById('message-input');
        if (messageInput) {
          messageInput.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = Math.min(this.scrollHeight, 120) + 'px';
          });
        }

        // Raccourcis clavier
        document.addEventListener('keydown', (e) => {
          // Ctrl + Enter pour envoyer
          if (e.ctrlKey && e.key === 'Enter') {
            const sendBtn = document.getElementById('send-btn');
            if (sendBtn) {
              sendBtn.click();
            }
          }
        });

        // Bouton rafra√Æchir la discussion
        const refreshChatBtn = document.getElementById('refresh-chat-btn');
        if (refreshChatBtn) {
          refreshChatBtn.addEventListener('click', async () => {
            try {
              const icon = refreshChatBtn.querySelector('i');
              if (icon) icon.classList.add('spin');
              await loadMessages();
            } finally {
              setTimeout(() => {
                const icon = refreshChatBtn.querySelector('i');
                if (icon) icon.classList.remove('spin');
              }, 400);
            }
          });
        }

        // Gestion des notifications
        if ('Notification' in window && Notification.permission === 'default') {
          Notification.requestPermission();
        }
        
        // Initialiser le syst√®me de notifications en temps r√©el
        setupRealtimeNotifications();
      }
      
      function setupRealtimeNotifications() {
        // √âcouter les √©v√©nements de notification
        document.addEventListener('showBubbleNotification', (event) => {
          if (window.notificationBubble) {
            window.notificationBubble.showNotification(event.detail);
          }
        });
        
        document.addEventListener('playNotificationSound', (event) => {
          if (window.notificationSounds) {
            window.notificationSounds.play(event.detail.type);
          }
        });
        
        // √âcouter les changements de connexion
        document.addEventListener('messagingConnectionChange', (event) => {
          updateConnectionStatus(event.detail.isConnected);
        });
        
        // √âcouter les nouveaux messages
        document.addEventListener('newMessage', (event) => {
          handleRealtimeMessage(event.detail.message);
        });

        // √âcouter les accus√©s de lecture et mettre √† jour l'UI
        document.addEventListener('messageRead', (event) => {
          const { conversation_id, last_read_message_id } = event.detail || {};
          if (!conversation_id || !last_read_message_id) return;
          try {
            // Mettre √† jour le statut pour tous les messages envoy√©s jusqu'√† last_read_message_id
            const sentMessages = document.querySelectorAll('.message.sent');
            sentMessages.forEach(el => {
              const mid = el.getAttribute('data-message-id');
              if (!mid) return;
              // Si l'ID est num√©rique, comparer num√©riquement; sinon, fallback
              const a = Number(mid);
              const b = Number(last_read_message_id);
              const reached = Number.isFinite(a) && Number.isFinite(b) ? a <= b : true;
              if (reached) {
                const status = el.querySelector('.message-status');
                if (status) status.textContent = '‚úì‚úì';
              }
            });
          } catch (e) {
            console.warn('Update read UI failed:', e);
          }
        });

        // Tabs Contacts/Forum
        const tabContacts = document.getElementById('tab-contacts');
        const tabForum = document.getElementById('tab-forum');
        const forumSection = document.getElementById('forum-section');
        const contactsList = document.getElementById('contacts-list');
        function activateTab(tab) {
          if (tab === 'forum') {
            tabContacts?.classList.remove('active');
            tabForum?.classList.add('active');
            forumSection.style.display = 'block';
            contactsList.style.display = 'none';
            loadForumCategories();
          } else {
            tabForum?.classList.remove('active');
            tabContacts?.classList.add('active');
            forumSection.style.display = 'none';
            contactsList.style.display = 'block';
          }
        }
        tabContacts?.addEventListener('click', ()=>activateTab('contacts'));
        tabForum?.addEventListener('click', ()=>activateTab('forum'));

        // Forum UI events
        const forumThread = document.getElementById('forum-thread');
        const forumCategoriesEl = document.getElementById('forum-categories');
        const forumBackBtn = document.getElementById('forum-back-btn');
        const forumRefreshBtn = document.getElementById('forum-refresh-btn');
        const forumMessages = document.getElementById('forum-messages');
        const forumInput = document.getElementById('forum-input');
        const forumSendBtn = document.getElementById('forum-send-btn');
        let currentForumCategoryId = null;

        window.openForumCategory = async function(categoryId) {
          currentForumCategoryId = categoryId;
          forumCategoriesEl.style.display = 'none';
          forumThread.style.display = 'block';
          await loadForumMessages();
        };

        forumBackBtn?.addEventListener('click', ()=>{
          forumThread.style.display = 'none';
          forumCategoriesEl.style.display = 'block';
          currentForumCategoryId = null;
        });
        forumRefreshBtn?.addEventListener('click', ()=> loadForumMessages(true));
        forumSendBtn?.addEventListener('click', async ()=>{
          const text = (forumInput?.value || '').trim();
          if (!text || !currentForumCategoryId) return;
          try {
            const resp = await fetch('/api/forum/messages', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json', ...authHeaders() },
              body: JSON.stringify({ category_id: currentForumCategoryId, content: text })
            });
            if (resp.ok) {
              forumInput.value = '';
              await loadForumMessages(true);
            }
          } catch(e) { console.warn('send forum msg failed', e); }
        });

        async function loadForumMessages(force=false) {
          if (!currentForumCategoryId) return;
          try {
            const resp = await fetch(`/api/forum/messages?category_id=${encodeURIComponent(currentForumCategoryId)}`, { headers: authHeaders(), cache: force ? 'reload' : 'default' });
            const data = await resp.json();
            const msgs = data?.messages || [];
            forumMessages.innerHTML = '';
            msgs.forEach(m => {
              const div = document.createElement('div');
              const mine = m.sender_user_id === getCurrentUserId();
              div.className = 'message ' + (mine ? 'sent' : 'received');
              div.innerHTML = `<div class="message-content"><div class="message-text">${(m.content||'')}</div><div class="message-time">${new Date(m.created_at).toLocaleString()}</div></div>`;
              forumMessages.appendChild(div);
            });
            forumMessages.scrollTop = forumMessages.scrollHeight;
          } catch (e) {
            console.warn('loadForumMessages failed', e);
          }
        }
      }
      
      function handleRealtimeMessage(message) {
        // Mettre √† jour l'interface utilisateur
        if (message && message.content) {
          // Ajouter le message √† la conversation active
          const messagesContainer = document.getElementById('messages-container');
          if (messagesContainer) {
            // V√©rifier si c'est la conversation active
            const currentChat = document.querySelector('.chat-area.active');
            if (currentChat && currentChat.dataset.chatId === message.chat_id) {
              displayMessages([message]);
            }
          }
          
          // Mettre √† jour le compteur de messages non lus
          updateUnreadCount(message.chat_id);
        }
      }
      
      function updateUnreadCount(chatId) {
        // Mettre √† jour le badge de notification pour le chat sp√©cifique
        const chatElement = document.querySelector(`[data-chat-id="${chatId}"]`);
        if (chatElement) {
          const badge = chatElement.querySelector('.unread-badge');
          if (badge) {
            const currentCount = parseInt(badge.textContent) || 0;
            badge.textContent = currentCount + 1;
            badge.style.display = 'block';
          }
        }
      }
      
      function updateConnectionStatus(isConnected) {
        const statusElement = document.getElementById('connection-status');
        if (statusElement) {
          if (isConnected) {
            statusElement.className = 'connection-status online';
            statusElement.innerHTML = '<i class="bi bi-wifi"></i><span>Connect√©</span>';
          } else {
            statusElement.className = 'connection-status offline';
            statusElement.innerHTML = '<i class="bi bi-wifi-off"></i><span>D√©connect√©</span>';
          }
        }
      }

      // Fonction pour charger les messages depuis l'API
      async function loadMessages() {
        try {
          const response = await fetch('/api/messages', {
            headers: {
              'Authorization': `Bearer ${localStorage.getItem('jwt')}`
            }
          });
          
          if (!response.ok) {
            throw new Error('Erreur lors du chargement des messages');
          }
          
          const data = await response.json();
          if (data.success) {
            displayMessages(data.messages);
          }
        } catch (error) {
          console.error('Erreur chargement messages:', error);
          showNotification('Erreur', 'Impossible de charger les messages');
        }
      }

      // Fonction pour envoyer un message
      async function sendMessage(content, recipientId) {
        try {
          const response = await fetch('/api/messages', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${localStorage.getItem('jwt')}`
            },
            body: JSON.stringify({
              recipient_id: recipientId,
              content: content,
              message_type: 'text'
            })
          });
          
          if (!response.ok) {
            throw new Error('Erreur lors de l\'envoi du message');
          }
          
          const data = await response.json();
          if (data.success) {
            // Recharger les messages apr√®s envoi
            await loadMessages();
            return data.message;
          }
        } catch (error) {
          console.error('Erreur envoi message:', error);
          showNotification('Erreur', 'Impossible d\'envoyer le message');
        }
      }

      // Fonction pour afficher les messages
      function displayMessages(messages) {
        const messagesContainer = document.getElementById('messages-container');
        if (!messagesContainer || !Array.isArray(messages)) return;
        
        messagesContainer.innerHTML = '';
        
        messages.forEach(message => {
          try {
            const messageElement = document.createElement('div');
            const isCurrentUser = message.sender_id === getCurrentUserId();
            messageElement.className = 'message ' + (isCurrentUser ? 'sent' : 'received');
            
            const messageTime = message.created_at 
              ? new Date(message.created_at).toLocaleTimeString() 
              : 'Maintenant';
              
            messageElement.innerHTML = [
              '<div class="message-content">',
              '  <div class="message-text">' + (message.content || '') + '</div>',
              '  <div class="message-time">' + messageTime + '</div>',
              '</div>'
            ].join('');
            
            messagesContainer.appendChild(messageElement);
          } catch (error) {
            console.error('Erreur affichage message:', error, message);
          }
        });
        
        // Scroll vers le bas
        if (messagesContainer.scrollHeight > 0) {
          messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }
      }

      // Fonction pour obtenir l'ID de l'utilisateur actuel
      function getCurrentUserId() {
        const token = localStorage.getItem('jwt');
        if (!token) return null;
        
        try {
          const payload = JSON.parse(atob(token.split('.')[1]));
          return payload.id;
        } catch (error) {
          console.error('Erreur d√©codage token:', error);
          return null;
        }
      }

      // Fonction pour afficher les notifications
      function showNotification(title, body, icon = '/Media/logo-ccrb.png') {
        if ('Notification' in window && Notification.permission === 'granted') {
          new Notification(title, {
            body: body,
            icon: icon,
            tag: 'ccrb-messaging'
          });
        }
      }

      // Fonction pour g√©rer les nouveaux messages
      function handleNewMessage(event) {
        const message = event.detail;
        if (!message) return;
        
        // V√©rifier si le message est pour la conversation actuelle
        const currentChatId = document.querySelector('.chat-area.active')?.dataset.chatId;
        if (currentChatId && message.chat_id === currentChatId) {
          // Ajouter le message √† la conversation
          const messagesContainer = document.getElementById('messages-container');
          if (messagesContainer) {
            displayMessages([message]);
          }
        }
        
        // Mettre √† jour le badge de notification
        updateUnreadCount();
      }
      
      // Fonction pour charger les cat√©gories de forum depuis Supabase avec cache
      async function loadForumCategories(forceRefresh = false) {
        const now = Date.now();
        const isCacheValid = forumCategoriesCache && (now - lastFetchTime < CACHE_DURATION);
        
        // Utiliser le cache si disponible et pas de for√ßage du rafra√Æchissement
        if (isCacheValid && !forceRefresh) {
          displayForumCategories(forumCategoriesCache);
          return;
        }

        // Afficher l'indicateur de chargement
        const loadingIndicator = document.getElementById('forum-loading');
        const forumContainer = document.getElementById('forum-categories');
        
        if (loadingIndicator) loadingIndicator.style.display = 'block';
        if (forumContainer) forumContainer.style.opacity = '0.6';

        try {
          const response = await fetch('/api/forum/categories', {
            headers: authHeaders(),
            cache: forceRefresh ? 'reload' : 'default'
          });
          
          if (!response.ok) {
            throw new Error('Erreur lors du chargement des cat√©gories');
          }
          
          const data = await response.json();
          if (data.success && Array.isArray(data.categories)) {
            // Mettre √† jour le cache
            forumCategoriesCache = data.categories;
            lastFetchTime = now;
            
            // Afficher les cat√©gories
            displayForumCategories(data.categories);
          } else {
            throw new Error('Format de r√©ponse invalide');
          }
        } catch (error) {
          console.error('Erreur lors du chargement des cat√©gories de forum:', error);
          
          // Afficher un message d'erreur dans l'interface
          if (forumContainer) {
            forumContainer.innerHTML = `
              <div class="alert alert-warning">
                <i class="bi bi-exclamation-triangle"></i>
                Impossible de charger les cat√©gories de forum. 
                <button class="btn btn-sm btn-outline-warning ms-2" onclick="loadForumCategories(true)">
                  <i class="bi bi-arrow-clockwise"></i> R√©essayer
                </button>
              </div>
            `;
          }
          
          // Si on a des donn√©es en cache, on les affiche malgr√© l'erreur
          if (forumCategoriesCache) {
            displayForumCategories(forumCategoriesCache);
          }
        } finally {
          // Masquer l'indicateur de chargement
          if (loadingIndicator) loadingIndicator.style.display = 'none';
          if (forumContainer) forumContainer.style.opacity = '1';
        }
      }
      
      // Fonction pour afficher les cat√©gories de forum
      function displayForumCategories(categories) {
        const forumContainer = document.getElementById('forum-categories');
        if (!forumContainer) return;
        
        if (!categories || categories.length === 0) {
          forumContainer.innerHTML = `
            <div class="alert alert-info">
              <i class="bi bi-info-circle"></i>
              Aucune cat√©gorie de forum disponible pour le moment.
            </div>
          `;
          return;
        }
        
        // Cr√©er les √©l√©ments HTML pour chaque cat√©gorie
        const categoriesHtml = categories.map(category => `
          <div class="forum-category" data-category="${category.id}" onclick="openForumCategory('${category.id}')">
            <div class="forum-category-header">
              <h6 class="forum-category-title">${category.icon || 'üí¨'} ${category.name}</h6>
              <span class="forum-category-count">${category.thread_count || 0}</span>
            </div>
            <p class="forum-category-description">${category.description || ''}</p>
          </div>
        `).join('');
        
        forumContainer.innerHTML = categoriesHtml;
      }
      
      // Fonction pour ouvrir une cat√©gorie de forum
      function openForumCategory(categoryId) {
        // Impl√©mentez la logique pour afficher les discussions de la cat√©gorie s√©lectionn√©e
        console.log('Ouverture de la cat√©gorie:', categoryId);
        // Vous pouvez ajouter ici le code pour charger les discussions de cette cat√©gorie
      }

      // Fonction pour charger les messages depuis l'API
      async function loadMessages() {
        try {
          const response = await fetch('/api/messages', {
            headers: {
              'Authorization': `Bearer ${localStorage.getItem('jwt')}`
            }
          });
          
          if (!response.ok) {
            throw new Error('Erreur lors du chargement des messages');
          }
          
          const data = await response.json();
          if (data.success) {
            displayMessages(data.messages);
          }
        } catch (error) {
          console.error('Erreur chargement messages:', error);
          showNotification('Erreur', 'Impossible de charger les messages');
        }
      }

      // Fonction pour envoyer un message
      async function sendMessage(content, recipientId) {
        try {
          const response = await fetch('/api/messages', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${localStorage.getItem('jwt')}`
            },
            body: JSON.stringify({
              recipient_id: recipientId,
              content: content,
              message_type: 'text'
            })
          });
          
          if (!response.ok) {
            throw new Error('Erreur lors de l\'envoi du message');
          }
          
          const data = await response.json();
          if (data.success) {
            // Recharger les messages apr√®s envoi
            await loadMessages();
            return data.message;
          }
        } catch (error) {
          console.error('Erreur envoi message:', error);
          showNotification('Erreur', 'Impossible d\'envoyer le message');
        }
      }

      // Fonction pour afficher les messages
      function displayMessages(messages) {
        const messagesContainer = document.getElementById('messages-container');
        if (!messagesContainer || !Array.isArray(messages)) return;
        
        messagesContainer.innerHTML = '';
        
        messages.forEach(message => {
          try {
            const messageElement = document.createElement('div');
            const isCurrentUser = message.sender_id === getCurrentUserId();
            messageElement.className = 'message ' + (isCurrentUser ? 'sent' : 'received');
            
            const messageTime = message.created_at 
              ? new Date(message.created_at).toLocaleTimeString() 
              : 'Maintenant';
              
            messageElement.innerHTML = [
              '<div class="message-content">',
              '  <div class="message-text">' + (message.content || '') + '</div>',
              '  <div class="message-time">' + messageTime + '</div>',
              '</div>'
            ].join('');
            
            messagesContainer.appendChild(messageElement);
          } catch (error) {
            console.error('Erreur affichage message:', error, message);
          }
        });
        
        // Scroll vers le bas
        if (messagesContainer.scrollHeight > 0) {
          messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }
      }

      // Fonction pour obtenir l'ID de l'utilisateur actuel
      function getCurrentUserId() {
        const token = localStorage.getItem('jwt');
        if (!token) return null;
        
        try {
          const payload = JSON.parse(atob(token.split('.')[1]));
          return payload.id;
        } catch (error) {
          console.error('Erreur d√©codage token:', error);
          return null;
        }
      }

      // Fonction pour afficher les notifications
      function showNotification(title, body, icon = '/Media/logo-ccrb.png') {
        if ('Notification' in window && Notification.permission === 'granted') {
          new Notification(title, {
            body: body,
            icon: icon,
            tag: 'ccrb-messaging'
          });
        }
      }

      // Fonction pour g√©rer les nouveaux messages
      function handleNewMessage(event) {
        try {
          const message = event.detail && event.detail.message;
          if (!message) return;
          
          // Afficher une notification si l'utilisateur n'est pas sur la page
          if (document.hidden) {
            const senderName = message.senderName || 'Exp√©diteur inconnu';
            const content = message.content || '';
            const preview = content.length > 50 ? content.substring(0, 50) + '...' : content;
            showNotification('Nouveau message', 'De ' + senderName + ': ' + preview);
          }
        } catch (error) {
          console.error('Erreur gestion nouveau message:', error);
        }
      }

      // Configuration du rechargement automatique
      let forumRefreshInterval = null;
      const FORUM_REFRESH_INTERVAL = 5 * 60 * 1000; // 5 minutes
      
      // Gestionnaire d'√©v√©nements pour le bouton de rafra√Æchissement
      function setupRefreshButton() {
        const refreshBtn = document.getElementById('refresh-forums-btn');
        if (refreshBtn) {
          refreshBtn.addEventListener('click', () => {
            // Ajouter une animation de rotation au bouton
            refreshBtn.querySelector('i').classList.add('fa-spin');
            
            // Forcer le rechargement des forums
            loadForumCategories(true).finally(() => {
              // Arr√™ter l'animation apr√®s un court d√©lai
              setTimeout(() => {
                refreshBtn.querySelector('i').classList.remove('fa-spin');
              }, 500);
            });
          });
        }
      }
      
      // D√©marrer le rechargement automatique
      function startAutoRefresh() {
        // Arr√™ter tout intervalle existant
        stopAutoRefresh();
        
        // D√©marrer un nouvel intervalle
        forumRefreshInterval = setInterval(() => {
          if (!document.hidden) {
            loadForumCategories();
          }
        }, FORUM_REFRESH_INTERVAL);
      }
      
      // Arr√™ter le rechargement automatique
      function stopAutoRefresh() {
        if (forumRefreshInterval) {
          clearInterval(forumRefreshInterval);
          forumRefreshInterval = null;
        }
      }
      
      // Initialisation de la page
      function initializePage() {
        // V√©rifier l'√©tat de connexion
        checkAuth();
        
        // Mettre √† jour l'√©tat en ligne
        updateOnlineStatus();
        
        // Configurer les gestionnaires d'√©v√©nements
        setupRefreshButton();
        
        // D√©marrer le rechargement automatique
        startAutoRefresh();
        
        // Charger les donn√©es initiales
        loadMessages();
        loadForumCategories();
        
        // Initialiser la messagerie moderne
        initializeModernMessaging();
        
        // Initialiser les tooltips Bootstrap
        const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
        tooltipTriggerList.forEach(function (tooltipTriggerEl) {
          return new bootstrap.Tooltip(tooltipTriggerEl);
        });
        
        console.log('Page de messagerie initialis√©e');
      }

      // Gestion de la visibilit√© de la page
      function handleVisibilityChange() {
        if (document.hidden) {
          console.log('üì± Page cach√©e - mode √©conomie');
          // Arr√™ter le rechargement automatique pour √©conomiser les ressources
          stopAutoRefresh();
        } else {
          console.log('üì± Page visible - reprise normale');
          // Mettre √† jour le statut en ligne
          updateOnlineStatus();
          
          // Recharger les donn√©es si n√©cessaire
          const now = Date.now();
          if (!lastFetchTime || (now - lastFetchTime) > (FORUM_REFRESH_INTERVAL / 2)) {
            loadForumCategories(true); // Forcer le rechargement si les donn√©es ont plus de 2,5 minutes
          } else {
            // Sinon, simplement red√©marrer le rechargement automatique
            startAutoRefresh();
          }
        }
      }

      // Gestionnaire pour le d√©chargement de la page
      function handleBeforeUnload() {
        // Nettoyer les ressources
        stopAutoRefresh();
      }

      // Ajouter les √©couteurs d'√©v√©nements
      document.addEventListener('DOMContentLoaded', initializePage);
      document.addEventListener('visibilitychange', handleVisibilityChange);
      document.addEventListener('newMessage', handleNewMessage);
      window.addEventListener('beforeunload', handleBeforeUnload);
    </script>
  </body>
</html>
