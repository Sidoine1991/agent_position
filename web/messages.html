<!doctype html>
<html lang="fr">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="manifest" href="/manifest.webmanifest" />
    <meta name="theme-color" content="#0ea5e9" />
    <title>Messages - Presence CCRB</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link rel="stylesheet" href="/styles.css?v=2" />
    <link rel="stylesheet" href="/contrast-fixes.css" />
    <style>
      .chat-container {
        height: calc(100vh - 200px);
        display: flex;
        flex-direction: column;
      }
      
      .chat-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 15px;
        border-radius: 10px 10px 0 0;
      }
      
      .chat-messages {
        flex: 1;
        overflow-y: auto;
        padding: 15px;
        background: #f8f9fa;
        border-left: 1px solid #dee2e6;
        border-right: 1px solid #dee2e6;
      }
      
      .message {
        margin-bottom: 15px;
        display: flex;
        align-items: flex-end;
      }
      
      .message.sent {
        justify-content: flex-end;
      }
      
      .message.received {
        justify-content: flex-start;
      }
      
      .message-bubble {
        max-width: 70%;
        padding: 10px 15px;
        border-radius: 18px;
        position: relative;
      }
      
      .message.sent .message-bubble {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-bottom-right-radius: 5px;
      }
      
      .message.received .message-bubble {
        background: white;
        color: #333;
        border: 1px solid #dee2e6;
        border-bottom-left-radius: 5px;
      }
      
      .message-time {
        font-size: 11px;
        opacity: 0.7;
        margin-top: 5px;
      }
      
      .message-status {
        font-size: 10px;
        margin-top: 2px;
      }
      
      .chat-input {
        padding: 15px;
        background: white;
        border-top: 1px solid #dee2e6;
        border-radius: 0 0 10px 10px;
      }
      
      .contact-list {
        height: calc(100vh - 200px);
        overflow-y: auto;
      }
      
      .contact-item {
        padding: 15px;
        border-bottom: 1px solid #dee2e6;
        cursor: pointer;
        transition: background-color 0.2s;
      }
      
      .contact-item:hover {
        background-color: #f8f9fa;
      }
      
      .contact-item.active {
        background-color: #e3f2fd;
        border-left: 4px solid #2196f3;
      }
      
      .contact-avatar {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        font-size: 18px;
      }
      
      .unread-badge {
        background: #ff4757;
        color: white;
        border-radius: 50%;
        width: 20px;
        height: 20px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 12px;
        font-weight: bold;
      }
      
      .typing-indicator {
        font-style: italic;
        color: #666;
        font-size: 12px;
        padding: 5px 15px;
      }
      
      .connection-status {
        position: fixed;
        top: 10px;
        right: 10px;
        z-index: 1000;
        padding: 5px 10px;
        border-radius: 15px;
        font-size: 12px;
        font-weight: bold;
      }
      
      .connection-status.online {
        background: #d4edda;
        color: #155724;
      }
      
      .connection-status.offline {
        background: #f8d7da;
        color: #721c24;
      }
    </style>
  </head>
  <body>
    <!-- Navigation Bar -->
    <nav class="navbar">
      <div class="navbar-brand">
        <a href="/index.html?stay=true" class="navbar-brand-link" style="display:flex;align-items:center;text-decoration:none;color:inherit">
          <img src="/Media/logo-ccrb.png" alt="CCRB Logo" class="navbar-logo">
          <div class="navbar-title">
            <h1>Presence CCRB</h1>
            <span class="navbar-subtitle">Messages</span>
          </div>
        </a>
      </div>
      
      <div class="navbar-menu">
        <div class="navbar-user" id="navbar-user">
          <span class="navbar-user-info" id="user-info">Chargement...</span>
          <button onclick="logout()" class="navbar-logout">
            <span class="navbar-icon">🚪</span>
            <span>Déconnexion</span>
          </button>
        </div>
      </div>
    </nav>

    <!-- Main Content -->
    <main class="main-content">
      <div class="page-header">
        <h2>💬 Messages</h2>
        <p>Communiquez avec votre équipe en temps réel</p>
      </div>

      <!-- Statut de connexion -->
      <div id="connection-status" class="connection-status offline">
        🟡 Connexion...
      </div>

      <div class="container-fluid">
        <div class="row">
          <!-- Liste des contacts -->
          <div class="col-md-4">
            <div class="card">
              <div class="card-header">
                <h5>Contacts</h5>
              </div>
              <div class="contact-list" id="contact-list">
                <!-- Les contacts seront chargés ici -->
              </div>
            </div>
          </div>

          <!-- Zone de chat -->
          <div class="col-md-8">
            <div class="card">
              <div id="chat-container" class="chat-container">
                <!-- En-tête du chat -->
                <div class="chat-header" id="chat-header">
                  <h5>Sélectionnez un contact pour commencer</h5>
                </div>

                <!-- Messages -->
                <div class="chat-messages" id="chat-messages">
                  <div class="text-center text-muted">
                    <i class="bi bi-chat-dots fs-1"></i>
                    <p>Aucune conversation sélectionnée</p>
                  </div>
                </div>

                <!-- Zone de saisie -->
                <div class="chat-input" id="chat-input" style="display: none;">
                  <div class="input-group">
                        <input type="text" class="form-control" id="message-input" placeholder="Tapez votre message...">
                        <button class="btn btn-outline-secondary" type="button" id="voice-btn" title="Message vocal">
                          <i class="bi bi-mic"></i>
                        </button>
                        <button class="btn btn-outline-secondary" type="button" id="photo-btn" title="Photo">
                          <i class="bi bi-camera"></i>
                        </button>
                        <button class="btn btn-primary" type="button" id="send-btn">
                          <i class="bi bi-send"></i>
                        </button>
                      </div>
                      <div class="typing-indicator" id="typing-indicator" style="display: none;">
                        <span id="typing-text"></span>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
    <script src="/app.js"></script>
    <script src="/messaging-system.js"></script>
    <script>
      let currentContact = null;
      let isTyping = false;
      let typingTimer = null;

      // Initialiser la page de messagerie
      document.addEventListener('DOMContentLoaded', () => {
        initializeMessagingPage();
      });

      async function initializeMessagingPage() {
        // Attendre que le système de messagerie soit initialisé
        if (!window.messagingSystem) {
          setTimeout(initializeMessagingPage, 100);
          return;
        }

        await loadContacts();
        setupEventListeners();
        updateConnectionStatus();
      }

      async function loadContacts() {
        const contactList = document.getElementById('contact-list');
        const contacts = window.messagingSystem.contacts;

        contactList.innerHTML = '';

        for (const contact of contacts) {
          const contactElement = createContactElement(contact);
          contactList.appendChild(contactElement);
        }
      }

      function createContactElement(contact) {
        const div = document.createElement('div');
        div.className = 'contact-item';
        div.dataset.contactId = contact.id;

        const unreadCount = getUnreadCount(contact.id);
        const lastMessage = getLastMessage(contact.id);

        div.innerHTML = `
          <div class="d-flex align-items-center">
            <div class="contact-avatar me-3">
              ${contact.name.charAt(0).toUpperCase()}
            </div>
            <div class="flex-grow-1">
              <div class="d-flex justify-content-between align-items-center">
                <h6 class="mb-0">${contact.name}</h6>
                ${unreadCount > 0 ? `<span class="unread-badge">${unreadCount}</span>` : ''}
              </div>
              <small class="text-muted">${lastMessage ? lastMessage.content.substring(0, 30) + '...' : 'Aucun message'}</small>
            </div>
          </div>
        `;

        div.addEventListener('click', () => selectContact(contact));
        return div;
      }

      function selectContact(contact) {
        currentContact = contact;
        
        // Mettre à jour l'interface
        updateChatHeader(contact);
        loadMessages(contact.id);
        showChatInput();
        
        // Marquer comme lu
        window.messagingSystem.markChatAsRead(contact.id);
        
        // Mettre à jour la liste des contacts
        updateContactList();
      }

      function updateChatHeader(contact) {
        const header = document.getElementById('chat-header');
        header.innerHTML = `
          <div class="d-flex align-items-center">
            <div class="contact-avatar me-3">
              ${contact.name.charAt(0).toUpperCase()}
            </div>
            <div>
              <h5 class="mb-0">${contact.name}</h5>
              <small>${contact.role || 'Contact'}</small>
            </div>
          </div>
        `;
      }

      function loadMessages(contactId) {
        const messagesContainer = document.getElementById('chat-messages');
        const messages = window.messagingSystem.getMessagesWithContact(contactId);
        
        messagesContainer.innerHTML = '';

        for (const message of messages) {
          const messageElement = createMessageElement(message);
          messagesContainer.appendChild(messageElement);
        }

        // Faire défiler vers le bas
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
      }

      function createMessageElement(message) {
        const div = document.createElement('div');
        const isSent = message.senderId === window.messagingSystem.getCurrentUserId();
        div.className = `message ${isSent ? 'sent' : 'received'}`;

        const time = new Date(message.timestamp).toLocaleTimeString('fr-FR', {
          hour: '2-digit',
          minute: '2-digit'
        });

        let content = message.content;
        if (message.type === 'voice') {
          content = `<audio controls><source src="${message.content}" type="audio/wav"></audio>`;
        } else if (message.type === 'photo') {
          content = `<img src="${message.content}" class="img-fluid" style="max-width: 200px; border-radius: 10px;">`;
          if (message.caption) {
            content += `<div class="mt-2">${message.caption}</div>`;
          }
        }

        div.innerHTML = `
          <div class="message-bubble">
            <div>${content}</div>
            <div class="message-time">${time}</div>
            ${isSent ? `<div class="message-status">${getMessageStatus(message.status)}</div>` : ''}
          </div>
        `;

        return div;
      }

      function getMessageStatus(status) {
        switch (status) {
          case 'sending': return '⏳';
          case 'sent': return '✓';
          case 'delivered': return '✓✓';
          case 'read': return '✓✓';
          case 'failed': return '❌';
          default: return '';
        }
      }

      function showChatInput() {
        document.getElementById('chat-input').style.display = 'block';
      }

      function hideChatInput() {
        document.getElementById('chat-input').style.display = 'none';
      }

      function setupEventListeners() {
        // Envoyer un message
        document.getElementById('send-btn').addEventListener('click', sendMessage);
        document.getElementById('message-input').addEventListener('keypress', (e) => {
          if (e.key === 'Enter') {
            sendMessage();
          }
        });

        // Indicateur de frappe
        document.getElementById('message-input').addEventListener('input', handleTyping);

        // Message vocal
        document.getElementById('voice-btn').addEventListener('click', startVoiceRecording);

        // Photo
        document.getElementById('photo-btn').addEventListener('click', () => {
          document.getElementById('photo-input').click();
        });

        // Événements du système de messagerie
        document.addEventListener('newMessage', (event) => {
          const message = event.detail.message;
          if (currentContact && (message.senderId === currentContact.id || message.recipientId === currentContact.id)) {
            addMessageToChat(message);
          }
          updateContactList();
        });

        document.addEventListener('messagingConnectionChange', (event) => {
          updateConnectionStatus(event.detail.isConnected);
        });
      }

      function sendMessage() {
        const input = document.getElementById('message-input');
        const content = input.value.trim();
        
        if (content && currentContact) {
          window.messagingSystem.sendMessage(currentContact.id, content);
          input.value = '';
          stopTyping();
        }
      }

      function handleTyping() {
        if (!isTyping && currentContact) {
          isTyping = true;
          window.messagingSystem.sendTypingIndicator(currentContact.id, true);
        }

        clearTimeout(typingTimer);
        typingTimer = setTimeout(() => {
          stopTyping();
        }, 1000);
      }

      function stopTyping() {
        if (isTyping && currentContact) {
          isTyping = false;
          window.messagingSystem.sendTypingIndicator(currentContact.id, false);
        }
      }

      function addMessageToChat(message) {
        const messagesContainer = document.getElementById('chat-messages');
        const messageElement = createMessageElement(message);
        messagesContainer.appendChild(messageElement);
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
      }

      function updateContactList() {
        loadContacts();
      }

      function updateConnectionStatus(isConnected) {
        const statusElement = document.getElementById('connection-status');
        if (isConnected) {
          statusElement.textContent = '🟢 En ligne';
          statusElement.className = 'connection-status online';
        } else {
          statusElement.textContent = '🟡 Hors-ligne';
          statusElement.className = 'connection-status offline';
        }
      }

      function getUnreadCount(contactId) {
        const messages = window.messagingSystem.getMessagesWithContact(contactId);
        return messages.filter(m => 
          m.recipientId === window.messagingSystem.getCurrentUserId() && !m.read
        ).length;
      }

      function getLastMessage(contactId) {
        const messages = window.messagingSystem.getMessagesWithContact(contactId);
        return messages.length > 0 ? messages[messages.length - 1] : null;
      }

      async function startVoiceRecording() {
        try {
          const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
          const mediaRecorder = new MediaRecorder(stream);
          const chunks = [];

          mediaRecorder.ondataavailable = (event) => {
            chunks.push(event.data);
          };

          mediaRecorder.onstop = () => {
            const blob = new Blob(chunks, { type: 'audio/wav' });
            if (currentContact) {
              window.messagingSystem.sendVoiceMessage(currentContact.id, blob);
            }
            stream.getTracks().forEach(track => track.stop());
          };

          mediaRecorder.start();
          
          // Arrêter après 30 secondes max
          setTimeout(() => {
            if (mediaRecorder.state === 'recording') {
              mediaRecorder.stop();
            }
          }, 30000);

        } catch (error) {
          console.error('Erreur enregistrement vocal:', error);
          alert('Impossible d\'accéder au microphone');
        }
      }
    </script>
  </body>
</html>
