<!doctype html>
<html lang="fr">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="manifest" href="/manifest.webmanifest" />
    <meta name="theme-color" content="#0ea5e9" />
    <title>Messages - Presence CCRB</title>
    <script src="/auth.js?v=2" defer></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <link rel="stylesheet" href="/styles.css?v=2" />
    <link rel="stylesheet" href="/contrast-fixes.css" />
    <style>
      /* Interface moderne de messagerie */
      .messaging-container {
        height: calc(100vh - 120px);
        display: flex;
        background: #f8f9fa;
        border-radius: 15px;
        overflow: hidden;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
      }
      
      /* Sidebar gauche - Contacts et Forums */
      .sidebar {
        width: 350px;
        background: white;
        border-right: 1px solid #e9ecef;
        display: flex;
        flex-direction: column;
      }
      
      .sidebar-header {
        padding: 20px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-bottom: 1px solid #e9ecef;
      }
      
      .search-box {
        position: relative;
        margin-bottom: 15px;
      }
      
      .search-box input {
        width: 100%;
        padding: 10px 15px 10px 40px;
        border: none;
        border-radius: 25px;
        background: rgba(255, 255, 255, 0.2);
        color: white;
        backdrop-filter: blur(10px);
      }
      
      .search-box input::placeholder {
        color: rgba(255, 255, 255, 0.7);
      }
      
      .search-box i {
        position: absolute;
        left: 15px;
        top: 50%;
        transform: translateY(-50%);
        color: rgba(255, 255, 255, 0.7);
      }
      
      .tabs {
        display: flex;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 10px;
        padding: 5px;
        margin-bottom: 15px;
      }
      
      .tab {
        flex: 1;
        padding: 8px 12px;
        text-align: center;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.3s ease;
        font-size: 14px;
        font-weight: 500;
      }
      
      .tab.active {
        background: white;
        color: #667eea;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }
      
      .tab:not(.active) {
        color: rgba(255, 255, 255, 0.7);
      }
      
      /* Liste des contacts */
      .contacts-list {
        flex: 1;
        overflow-y: auto;
        padding: 10px;
      }
      
      .contact-item {
        display: flex;
        align-items: center;
        padding: 15px;
        margin-bottom: 8px;
        border-radius: 12px;
        cursor: pointer;
        transition: all 0.3s ease;
        position: relative;
      }
      
      .contact-item:hover {
        background: #f8f9fa;
        transform: translateX(5px);
      }
      
      .contact-item.active {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
      }
      
      .contact-avatar {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        font-size: 18px;
        margin-right: 15px;
        position: relative;
      }
      
      .contact-item:not(.active) .contact-avatar {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
      }
      
      .contact-item.active .contact-avatar {
        background: rgba(255, 255, 255, 0.2);
        color: white;
      }
      
      .online-indicator {
        position: absolute;
        bottom: 2px;
        right: 2px;
        width: 12px;
        height: 12px;
        border-radius: 50%;
        border: 2px solid white;
      }
      
      .online-indicator.online {
        background: #28a745;
      }
      
      .online-indicator.offline {
        background: #6c757d;
      }
      
      .contact-info {
        flex: 1;
        min-width: 0;
      }
      
      .contact-name {
        font-weight: 600;
        font-size: 16px;
        margin-bottom: 4px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }
      
      .contact-role {
        font-size: 12px;
        opacity: 0.7;
        margin-bottom: 4px;
      }
      
      .last-message {
        font-size: 14px;
        opacity: 0.8;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }
      
      .message-meta {
        display: flex;
        flex-direction: column;
        align-items: flex-end;
        gap: 5px;
      }
      
      .message-time {
        font-size: 11px;
        opacity: 0.6;
      }
      
      .unread-badge {
        background: #ff4757;
        color: white;
        border-radius: 50%;
        width: 20px;
        height: 20px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 11px;
        font-weight: bold;
      }
      
      /* Zone de chat principale */
      .chat-area {
        flex: 1;
        display: flex;
        flex-direction: column;
        background: white;
      }
      
      .chat-header {
        padding: 20px;
        background: white;
        border-bottom: 1px solid #e9ecef;
        display: flex;
        align-items: center;
        justify-content: space-between;
      }
      
      .chat-user-info {
        display: flex;
        align-items: center;
      }
      
      .chat-user-avatar {
        width: 45px;
        height: 45px;
        border-radius: 50%;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        margin-right: 15px;
        position: relative;
      }
      
      .chat-user-details h6 {
        margin: 0;
        font-weight: 600;
        color: #333;
      }
      
      .chat-user-status {
        font-size: 12px;
        color: #28a745;
        display: flex;
        align-items: center;
        gap: 5px;
      }
      
      .chat-actions {
        display: flex;
        gap: 10px;
      }
      
      .chat-action-btn {
        width: 40px;
        height: 40px;
        border: none;
        border-radius: 50%;
        background: #f8f9fa;
        color: #6c757d;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.3s ease;
      }
      
      .chat-action-btn:hover {
        background: #e9ecef;
        color: #495057;
      }
      
      /* Messages */
      .messages-container {
        flex: 1;
        overflow-y: auto;
        padding: 20px;
        background: #f8f9fa;
        background-image: 
          radial-gradient(circle at 20% 80%, rgba(120, 119, 198, 0.1) 0%, transparent 50%),
          radial-gradient(circle at 80% 20%, rgba(255, 119, 198, 0.1) 0%, transparent 50%);
      }
      
      .message {
        margin-bottom: 20px;
        display: flex;
        align-items: flex-end;
        animation: messageSlide 0.3s ease-out;
      }
      
      @keyframes messageSlide {
        from {
          opacity: 0;
          transform: translateY(20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      
      .message.sent {
        justify-content: flex-end;
      }
      
      .message.received {
        justify-content: flex-start;
      }
      
      .message-content {
        max-width: 70%;
        display: flex;
        flex-direction: column;
        gap: 5px;
      }
      
      .message-bubble {
        padding: 12px 18px;
        border-radius: 20px;
        position: relative;
        word-wrap: break-word;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }
      
      .message.sent .message-bubble {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-bottom-right-radius: 8px;
      }
      
      .message.received .message-bubble {
        background: white;
        color: #333;
        border: 1px solid #e9ecef;
        border-bottom-left-radius: 8px;
      }
      
      .message-time {
        font-size: 11px;
        opacity: 0.6;
        text-align: right;
      }
      
      .message.received .message-time {
        text-align: left;
      }
      
      .message-status {
        font-size: 10px;
        margin-top: 2px;
        text-align: right;
      }
      
      .typing-indicator {
        display: flex;
        align-items: center;
        gap: 5px;
        font-style: italic;
        color: #6c757d;
        font-size: 14px;
        padding: 10px 15px;
        background: white;
        border-radius: 20px;
        margin-bottom: 10px;
        max-width: 200px;
      }
      
      .typing-dots {
        display: flex;
        gap: 3px;
      }
      
      .typing-dot {
        width: 6px;
        height: 6px;
        border-radius: 50%;
        background: #6c757d;
        animation: typingDot 1.4s infinite ease-in-out;
      }
      
      .typing-dot:nth-child(2) {
        animation-delay: 0.2s;
      }
      
      .typing-dot:nth-child(3) {
        animation-delay: 0.4s;
      }
      
      @keyframes typingDot {
        0%, 60%, 100% {
          transform: scale(1);
          opacity: 0.5;
        }
        30% {
          transform: scale(1.2);
          opacity: 1;
        }
      }
      
      /* Zone de saisie */
      .message-input-area {
        padding: 20px;
        background: white;
        border-top: 1px solid #e9ecef;
      }
      
      .input-container {
        display: flex;
        align-items: flex-end;
        gap: 10px;
        background: #f8f9fa;
        border-radius: 25px;
        padding: 10px 15px;
        border: 1px solid #e9ecef;
        transition: all 0.3s ease;
      }
      
      .input-container:focus-within {
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
      }
      
      .message-input {
        flex: 1;
        border: none;
        background: transparent;
        outline: none;
        resize: none;
        max-height: 120px;
        font-size: 14px;
        line-height: 1.4;
      }
      
      .message-input::placeholder {
        color: #6c757d;
      }
      
      .input-actions {
        display: flex;
        gap: 5px;
        align-items: center;
      }
      
      .input-btn {
        width: 35px;
        height: 35px;
        border: none;
        border-radius: 50%;
        background: transparent;
        color: #6c757d;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.3s ease;
      }
      
      .input-btn:hover {
        background: #e9ecef;
        color: #495057;
      }
      
      .input-btn.primary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
      }
      
      .input-btn.primary:hover {
        transform: scale(1.05);
        box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
      }
      
      /* Statut de connexion */
      .connection-status {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 1000;
        padding: 8px 15px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 8px;
        backdrop-filter: blur(10px);
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
      }
      
      .connection-status.online {
        background: rgba(40, 167, 69, 0.9);
        color: white;
      }
      
      .connection-status.offline {
        background: rgba(220, 53, 69, 0.9);
        color: white;
      }
      
      /* Forum de discussion */
      .forum-section {
        display: none;
      }
      
      .forum-section.active {
        display: block;
      }
      
      .forum-categories {
        padding: 15px;
      }
      
      .forum-category {
        background: white;
        border-radius: 12px;
        padding: 15px;
        margin-bottom: 10px;
        cursor: pointer;
        transition: all 0.3s ease;
        border: 1px solid #e9ecef;
      }
      
      .forum-category:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
      }
      
      .forum-category-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 8px;
      }
      
      .forum-category-title {
        font-weight: 600;
        color: #333;
        margin: 0;
      }
      
      .forum-category-count {
        background: #667eea;
        color: white;
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 11px;
        font-weight: 600;
      }
      
      .forum-category-description {
        font-size: 12px;
        color: #6c757d;
        margin: 0;
      }
      
      /* Responsive */
      @media (max-width: 768px) {
        .sidebar {
          width: 100%;
        }
        
        .chat-area {
          display: none;
        }
        
        .chat-area.active {
          display: flex;
        }
        
        .messaging-container {
          height: calc(100vh - 80px);
        }
      }
      
      /* Animations */
      .fade-in {
        animation: fadeIn 0.5s ease-in;
      }
      
      @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
      }
      
      .slide-in-right {
        animation: slideInRight 0.3s ease-out;
      }
      
      @keyframes slideInRight {
        from {
          transform: translateX(100%);
          opacity: 0;
        }
        to {
          transform: translateX(0);
          opacity: 1;
        }
      }
    </style>
  </head>
  <body>
    <!-- Navigation Bar -->
    <div id="navbar-placeholder"></div>

    <!-- Main Content -->
    <main class="main-content">
      <div class="page-header">
        <h2>üí¨ Messages & Forum</h2>
        <p>Communiquez avec votre √©quipe et participez aux discussions</p>
      </div>

      <!-- Statut de connexion -->
      <div id="connection-status" class="connection-status offline">
        <i class="bi bi-wifi-off"></i>
        <span>Connexion...</span>
      </div>

      <!-- Interface de messagerie moderne -->
      <div class="messaging-container">
        <!-- Sidebar gauche -->
        <div class="sidebar">
          <!-- En-t√™te avec recherche et onglets -->
          <div class="sidebar-header">
            <div class="search-box">
              <i class="bi bi-search"></i>
              <input type="text" id="search-contacts" placeholder="Rechercher un contact...">
            </div>
            
            <!-- Onglets Contacts/Forum -->
            <div class="tabs">
              <div class="tab active" data-tab="contacts">
                <i class="bi bi-people"></i> Contacts
              </div>
              <div class="tab" data-tab="forum">
                <i class="bi bi-chat-square-dots"></i> Forum
              </div>
            </div>
          </div>

          <!-- Liste des contacts -->
          <div class="contacts-list" id="contacts-list">
            <!-- Les contacts seront charg√©s ici -->
          </div>

          <!-- Forum de discussion -->
          <div class="forum-section" id="forum-section">
            <div class="forum-categories">
              <div class="forum-category" data-category="general">
                <div class="forum-category-header">
                  <h6 class="forum-category-title">üí¨ Discussion G√©n√©rale</h6>
                  <span class="forum-category-count">12</span>
                </div>
                <p class="forum-category-description">Discussions g√©n√©rales entre agents</p>
              </div>
              
              <div class="forum-category" data-category="technical">
                <div class="forum-category-header">
                  <h6 class="forum-category-title">üîß Support Technique</h6>
                  <span class="forum-category-count">8</span>
                </div>
                <p class="forum-category-description">Aide technique et r√©solution de probl√®mes</p>
              </div>
              
              <div class="forum-category" data-category="field">
                <div class="forum-category-header">
                  <h6 class="forum-category-title">üåç Exp√©riences Terrain</h6>
                  <span class="forum-category-count">15</span>
                </div>
                <p class="forum-category-description">Partage d'exp√©riences sur le terrain</p>
              </div>
              
              <div class="forum-category" data-category="emergency">
                <div class="forum-category-header">
                  <h6 class="forum-category-title">üö® Urgences</h6>
                  <span class="forum-category-count">3</span>
                </div>
                <p class="forum-category-description">Signalements d'urgences et alertes</p>
              </div>
            </div>
          </div>
        </div>

        <!-- Zone de chat principale -->
        <div class="chat-area" id="chat-area">
          <!-- En-t√™te du chat -->
          <div class="chat-header" id="chat-header">
            <div class="chat-user-info">
              <div class="chat-user-avatar" id="chat-user-avatar">
                <i class="bi bi-person"></i>
              </div>
              <div class="chat-user-details">
                <h6 id="chat-user-name">S√©lectionnez un contact</h6>
                <div class="chat-user-status" id="chat-user-status">
                  <i class="bi bi-circle-fill"></i>
                  <span>Hors ligne</span>
                </div>
              </div>
            </div>
            <div class="chat-actions">
              <button class="chat-action-btn" id="video-call-btn" title="Appel vid√©o">
                <i class="bi bi-camera-video"></i>
              </button>
              <button class="chat-action-btn" id="voice-call-btn" title="Appel vocal">
                <i class="bi bi-telephone"></i>
              </button>
              <button class="chat-action-btn" id="more-options-btn" title="Plus d'options">
                <i class="bi bi-three-dots-vertical"></i>
              </button>
            </div>
          </div>

          <!-- Messages -->
          <div class="messages-container" id="messages-container">
            <div class="text-center text-muted" id="no-conversation">
              <i class="bi bi-chat-dots" style="font-size: 3rem; opacity: 0.3;"></i>
              <p style="margin-top: 15px;">S√©lectionnez un contact ou une cat√©gorie de forum pour commencer</p>
            </div>
          </div>

          <!-- Zone de saisie -->
          <div class="message-input-area" id="message-input-area" style="display: none;">
            <div class="input-container">
              <textarea 
                class="message-input" 
                id="message-input" 
                placeholder="Tapez votre message..."
                rows="1"
              ></textarea>
              <div class="input-actions">
                <button class="input-btn" id="emoji-btn" title="Emoji">
                  <i class="bi bi-emoji-smile"></i>
                </button>
                <button class="input-btn" id="attachment-btn" title="Fichier">
                  <i class="bi bi-paperclip"></i>
                </button>
                <button class="input-btn" id="voice-btn" title="Message vocal">
                  <i class="bi bi-mic"></i>
                </button>
                <button class="input-btn" id="photo-btn" title="Photo">
                  <i class="bi bi-camera"></i>
                </button>
                <button class="input-btn primary" id="send-btn" title="Envoyer">
                  <i class="bi bi-send"></i>
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
    <script>
      // Fonction pour obtenir les en-t√™tes d'authentification
      async function authHeaders() {
        const token = localStorage.getItem('jwt');
        return token ? { 'Authorization': `Bearer ${token}` } : {};
      }

      // Mettre √† jour l'√©tat en ligne des utilisateurs
      async function updateOnlineStatus() {
        try {
          const response = await fetch('/api/users/online', {
            headers: await authHeaders()
          });
          
          if (response.ok) {
            const onlineUsers = await response.json();
            
            // Mettre √† jour les indicateurs de pr√©sence
            document.querySelectorAll('.contact-item').forEach(contact => {
              const userId = contact.dataset.userId;
              const onlineIndicator = contact.querySelector('.online-indicator');
              
              if (onlineIndicator) {
                const isOnline = onlineUsers.includes(userId);
                onlineIndicator.className = `online-indicator ${isOnline ? 'online' : 'offline'}`;
                onlineIndicator.title = isOnline ? 'En ligne' : 'Hors ligne';
              }
            });
          }
        } catch (error) {
          console.error('Erreur lors de la mise √† jour du statut en ligne:', error);
        }
      }

      // Fonction pour afficher des alertes
      function showAlert(message, type = 'info') {
        const alertDiv = document.createElement('div');
        alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
        alertDiv.role = 'alert';
        alertDiv.innerHTML = `
          ${message}
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        `;
        
        const container = document.querySelector('.main-content') || document.body;
        container.prepend(alertDiv);
        
        // Supprimer l'alerte apr√®s 5 secondes
        setTimeout(() => {
          alertDiv.remove();
        }, 5000);
      }

      // Mettre √† jour l'√©tat en ligne toutes les 30 secondes
      setInterval(updateOnlineStatus, 30000);

      // Appeler une premi√®re fois au chargement
      document.addEventListener('DOMContentLoaded', () => {
        updateOnlineStatus();
        
        // Initialiser les tooltips Bootstrap
        const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
        tooltipTriggerList.map(function (tooltipTriggerEl) {
          return new bootstrap.Tooltip(tooltipTriggerEl);
        });
      });
    </script>
    <!-- <script src="/app.js"></script> -->
    <script src="/advanced-messaging.js"></script>
    <script>
      // Initialiser la page de messagerie moderne
      document.addEventListener('DOMContentLoaded', () => {
        initializeModernMessaging();
      });

      function initializeModernMessaging() {
        // Attendre que le syst√®me de messagerie avanc√© soit initialis√©
        if (!window.advancedMessaging) {
          setTimeout(initializeModernMessaging, 100);
          return;
        }

        console.log('üí¨ Syst√®me de messagerie moderne initialis√©');
        
        // Ajouter des fonctionnalit√©s suppl√©mentaires
        setupAdditionalFeatures();
      }

      function setupAdditionalFeatures() {
        // Auto-resize du textarea
        const messageInput = document.getElementById('message-input');
        if (messageInput) {
          messageInput.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = Math.min(this.scrollHeight, 120) + 'px';
          });
        }

        // Raccourcis clavier
        document.addEventListener('keydown', (e) => {
          // Ctrl + Enter pour envoyer
          if (e.ctrlKey && e.key === 'Enter') {
            const sendBtn = document.getElementById('send-btn');
            if (sendBtn) {
              sendBtn.click();
            }
          }
        });

        // Gestion des notifications
        if ('Notification' in window && Notification.permission === 'default') {
          Notification.requestPermission();
        }
      }

      // Fonction pour charger les messages depuis l'API
      async function loadMessages() {
        try {
          const response = await fetch('/api/messages', {
            headers: {
              'Authorization': `Bearer ${localStorage.getItem('jwt')}`
            }
          });
          
          if (!response.ok) {
            throw new Error('Erreur lors du chargement des messages');
          }
          
          const data = await response.json();
          if (data.success) {
            displayMessages(data.messages);
          }
        } catch (error) {
          console.error('Erreur chargement messages:', error);
          showNotification('Erreur', 'Impossible de charger les messages');
        }
      }

      // Fonction pour envoyer un message
      async function sendMessage(content, recipientId) {
        try {
          const response = await fetch('/api/messages', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${localStorage.getItem('jwt')}`
            },
            body: JSON.stringify({
              recipient_id: recipientId,
              content: content,
              message_type: 'text'
            })
          });
          
          if (!response.ok) {
            throw new Error('Erreur lors de l\'envoi du message');
          }
          
          const data = await response.json();
          if (data.success) {
            // Recharger les messages apr√®s envoi
            await loadMessages();
            return data.message;
          }
        } catch (error) {
          console.error('Erreur envoi message:', error);
          showNotification('Erreur', 'Impossible d\'envoyer le message');
        }
      }

      // Fonction pour afficher les messages
      function displayMessages(messages) {
        const messagesContainer = document.getElementById('messages-container');
        if (!messagesContainer) return;
        
        messagesContainer.innerHTML = '';
        
        messages.forEach(message => {
          const messageElement = document.createElement('div');
          messageElement.className = `message ${message.sender_id === getCurrentUserId() ? 'sent' : 'received'}`;
          
          messageElement.innerHTML = `
            <div class="message-content">
              <div class="message-text">${message.content}</div>
              <div class="message-time">${new Date(message.created_at).toLocaleTimeString()}</div>
            </div>
          `;
          
          messagesContainer.appendChild(messageElement);
        });
        
        // Scroll vers le bas
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
      }

      // Fonction pour obtenir l'ID de l'utilisateur actuel
      function getCurrentUserId() {
        const token = localStorage.getItem('jwt');
        if (!token) return null;
        
        try {
          const payload = JSON.parse(atob(token.split('.')[1]));
          return payload.id;
        } catch (error) {
          console.error('Erreur d√©codage token:', error);
          return null;
        }
      }

      // Fonction pour afficher les notifications
      function showNotification(title, body, icon = '/Media/logo-ccrb.png') {
        if ('Notification' in window && Notification.permission === 'granted') {
          new Notification(title, {
            body: body,
            icon: icon,
            tag: 'ccrb-messaging'
          });
        }
      }

      // √âcouter les nouveaux messages
      document.addEventListener('newMessage', (event) => {
        const message = event.detail.message;
        
        // Afficher une notification si l'utilisateur n'est pas sur la page
        if (document.hidden) {
          showNotification('Nouveau message', `De ${message.senderName}: ${message.content.substring(0, 50)}...`);
        }
      });

      // Charger les messages au chargement de la page
      document.addEventListener('DOMContentLoaded', () => {
        loadMessages();
      });

      // Gestion de la visibilit√© de la page
      document.addEventListener('visibilitychange', () => {
        if (document.hidden) {
          // Page cach√©e - r√©duire la fr√©quence des mises √† jour
          console.log('üì± Page cach√©e - mode √©conomie');
        } else {
          // Page visible - reprendre les mises √† jour normales
          console.log('üì± Page visible - reprise normale');
        }
      });
    </script>
  </body>
</html>
