<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Unit√©s Administratives</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .form-group { margin: 10px 0; }
        select { padding: 8px; width: 300px; }
        .log { background: #f0f0f0; padding: 10px; margin: 10px 0; border-radius: 4px; }
    </style>
</head>
<body>
    <h1>Test des Unit√©s Administratives</h1>
    
    <div class="form-group">
        <label for="af_departement">D√©partement *</label>
        <select id="af_departement" required>
            <option value="">S√©lectionner un d√©partement...</option>
        </select>
    </div>
    
    <div class="form-group">
        <label for="af_commune">Commune</label>
        <select id="af_commune" disabled>
            <option value="">S√©lectionner une commune...</option>
        </select>
    </div>
    
    <div class="form-group">
        <label for="af_arrondissement">Arrondissement</label>
        <select id="af_arrondissement" disabled>
            <option value="">S√©lectionner un arrondissement...</option>
        </select>
    </div>
    
    <div class="form-group">
        <label for="af_village">Village</label>
        <select id="af_village" disabled>
            <option value="">S√©lectionner un village...</option>
        </select>
    </div>
    
    <div class="log" id="log"></div>
    
    <button onclick="testLoadDepartements()">Tester Chargement</button>
    <button onclick="testApi()">Tester API</button>
    
    <script>
        const apiBase = window.location.hostname === 'localhost' ? 'https://presenceccrb-ozgc9p3zc-yebadokpo-sidoines-projects.vercel.app/api' : '/api';
        let jwt = localStorage.getItem('jwt') || '';
        
        function $(id) { return document.getElementById(id); }
        
        function log(message) {
            const logDiv = $('log');
            logDiv.innerHTML += '<div>' + new Date().toLocaleTimeString() + ': ' + message + '</div>';
        }
        
        async function api(path, opts={}) {
            const headers = opts.headers || {};
            headers['Content-Type'] = 'application/json';
            if (jwt) headers['Authorization'] = 'Bearer ' + jwt;
            const res = await fetch(apiBase + path, {
                method: opts.method || 'GET',
                headers,
                body: opts.body ? JSON.stringify(opts.body) : undefined,
            });
            if (!res.ok) {
                const text = await res.text();
                throw new Error(`HTTP ${res.status}: ${text}`);
            }
            return res.json();
        }
        
        async function loadAfDepartements(villagePath){
            log('üåç Chargement des d√©partements...');
            log('üîç Recherche de l\'√©l√©ment af_departement...');
            
            const depSel = $('af_departement'); 
            if (!depSel) {
                log('‚ùå √âl√©ment af_departement non trouv√©');
                log('üîç √âl√©ments disponibles avec "af_": ' + document.querySelectorAll('[id^="af_"]').length);
                return;
            }
            
            log('‚úÖ √âl√©ment af_departement trouv√©: ' + depSel.tagName);
            depSel.innerHTML='';
            
            try {
                log('üåê Appel API /geo/departements...');
                const deps = await api('/geo/departements');
                log('‚úÖ D√©partements charg√©s: ' + deps.length + ' d√©partements');
                
                depSel.append(new Option('S√©lectionner un d√©partement...', ''));
                for(const d of deps) {
                    const option = new Option(d.name, d.id);
                    depSel.append(option);
                    log('‚ûï Option ajout√©e: ' + d.name + ' (ID: ' + d.id + ')');
                }
                
                log('‚úÖ Total options dans le select: ' + depSel.options.length);
                
                // Activer le select
                depSel.disabled = false;
                
            } catch (error) {
                log('‚ùå Erreur lors du chargement des d√©partements: ' + error.message);
            }
            
            // Reset other selects
            $('af_commune').innerHTML = '<option value="">S√©lectionner une commune...</option>';
            $('af_arrondissement').innerHTML = '<option value="">S√©lectionner un arrondissement...</option>';
            $('af_village').innerHTML = '<option value="">S√©lectionner un village...</option>';
            $('af_commune').disabled = true; 
            $('af_arrondissement').disabled = true; 
            $('af_village').disabled = true;
        }
        
        async function testLoadDepartements() {
            log('üß™ Test manuel du chargement des d√©partements...');
            await loadAfDepartements();
        }
        
        async function testApi() {
            log('üß™ Test de l\'API...');
            try {
                const result = await api('/geo/departements');
                log('‚úÖ API fonctionne: ' + result.length + ' d√©partements re√ßus');
                log('üìã Premiers d√©partements: ' + result.slice(0, 3).map(d => d.name).join(', '));
            } catch (error) {
                log('‚ùå Erreur API: ' + error.message);
            }
        }
        
        // Chargement automatique au d√©marrage
        window.onload = function() {
            log('üöÄ Page charg√©e, test automatique...');
            setTimeout(() => {
                loadAfDepartements();
            }, 500);
        };
    </script>
</body>
</html>
