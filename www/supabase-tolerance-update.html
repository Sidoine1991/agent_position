<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mise √† jour Supabase - Rayons de Tol√©rance</title>
    <link href="/bootstrap-5.3.8-dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/styles.css?v=5" />
    <link rel="stylesheet" href="/modern-ui.css?v=2" />
    <link rel="stylesheet" href="/styles-theme.css?v=1">
    <style>
        .update-card {
            border-left: 4px solid #0ea5e9;
            margin-bottom: 1rem;
        }
        .update-card.success {
            border-left-color: #10b981;
        }
        .update-card.error {
            border-left-color: #ef4444;
        }
        .update-card.warning {
            border-left-color: #f59e0b;
        }
        .log-container {
            background: #1e293b;
            color: #e2e8f0;
            font-family: 'Courier New', monospace;
            font-size: 0.875rem;
            max-height: 400px;
            overflow-y: auto;
            padding: 1rem;
            border-radius: 8px;
        }
        .log-entry {
            margin-bottom: 0.5rem;
        }
        .log-success { color: #10b981; }
        .log-error { color: #ef4444; }
        .log-warning { color: #f59e0b; }
        .log-info { color: #0ea5e9; }
    </style>
</head>
<body>
    <!-- Navigation Bar -->
    <nav class="navbar">
        <div class="navbar-brand">
            <img src="/Media/logo-ccrb.png" alt="CCRB Logo" class="navbar-logo">
            <div class="navbar-title">
                <h1>Presence CCRB</h1>
                <span class="navbar-subtitle">Mise √† jour Supabase - Rayons de Tol√©rance</span>
            </div>
        </div>
        
        <div class="navbar-menu">
            <a href="/" class="navbar-link">
                <span class="navbar-icon">üè†</span>
                <span>Accueil</span>
            </a>
            <a href="/agent-tolerance-admin.html" class="navbar-link">
                <span class="navbar-icon">‚öôÔ∏è</span>
                <span>Admin Tol√©rance</span>
            </a>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="main-content">
        <div class="page-header">
            <h2>Mise √† jour des Rayons de Tol√©rance dans Supabase</h2>
            <p>Ex√©cution des mises √† jour SQL pour appliquer les rayons personnalis√©s</p>
        </div>

        <!-- Avertissement -->
        <div class="card mb-4">
            <div class="alert alert-warning">
                <h4>‚ö†Ô∏è Attention</h4>
                <p>Cette op√©ration va modifier directement la base de donn√©es Supabase. Assurez-vous d'avoir une sauvegarde avant de proc√©der.</p>
                <p><strong>IMPORTANT:</strong> Si vous obtenez une erreur "column does not exist", ex√©cutez d'abord le script <code>add_tolerance_columns.sql</code> pour ajouter les colonnes manquantes.</p>
            </div>
        </div>

        <!-- Instructions d'ex√©cution -->
        <div class="card mb-4">
            <h3>üìã Instructions d'ex√©cution</h3>
            <div class="alert alert-info">
                <h5>√âtape 1: V√©rifier la structure de la table</h5>
                <p>Ex√©cutez d'abord: <code>database/check_users_structure.sql</code></p>
                
                <h5>√âtape 2: Ajouter les colonnes manquantes (si n√©cessaire)</h5>
                <p>Si les colonnes <code>tolerance_radius_meters</code>, <code>custom_tolerance_applied</code>, <code>tolerance_source</code>, <code>tolerance_commune</code> n'existent pas, ex√©cutez: <code>database/add_tolerance_columns.sql</code></p>
                
                <h5>√âtape 3: Corriger les contraintes (NOUVEAU)</h5>
                <p>Si vous obtenez l'erreur "check constraint violation", ex√©cutez: <code>database/fix_tolerance_constraint.sql</code></p>
                
                <h5>√âtape 4: Mettre √† jour les rayons</h5>
                <p>Ex√©cutez: <code>database/update_agent_tolerance_radius_final.sql</code></p>
            </div>
        </div>

        <!-- Erreurs courantes -->
        <div class="card mb-4">
            <h3>üö® Erreurs courantes et solutions</h3>
            <div class="alert alert-warning">
                <h5>Erreur: "column does not exist"</h5>
                <p><strong>Solution:</strong> Ex√©cutez <code>database/add_tolerance_columns.sql</code></p>
                
                <h5>Erreur: "check constraint violation"</h5>
                <p><strong>Solution:</strong> Ex√©cutez <code>database/fix_tolerance_constraint.sql</code></p>
                
                <h5>Erreur: "permission denied"</h5>
                <p><strong>Solution:</strong> V√©rifiez vos permissions dans Supabase ou utilisez un service role</p>
            </div>
        </div>

        <!-- Contr√¥les d'ex√©cution -->
        <div class="card mb-4">
            <h3>üöÄ Ex√©cution des Mises √† jour</h3>
            <div class="row">
                <div class="col-md-4">
                    <button class="btn btn-primary w-100 mb-2" onclick="executeCustomUpdates()">
                        Mettre √† jour les agents personnalis√©s
                    </button>
                    <small class="text-muted">15 agents avec rayons calcul√©s</small>
                </div>
                <div class="col-md-4">
                    <button class="btn btn-secondary w-100 mb-2" onclick="executeDefaultUpdates()">
                        Mettre √† jour les agents par d√©faut
                    </button>
                    <small class="text-muted">Rayon 6km pour les autres</small>
                </div>
                <div class="col-md-4">
                    <button class="btn btn-success w-100 mb-2" onclick="executeAllUpdates()">
                        Ex√©cuter toutes les mises √† jour
                    </button>
                    <small class="text-muted">Op√©ration compl√®te</small>
                </div>
            </div>
        </div>

        <!-- Script SQL -->
        <div class="card mb-4">
            <h3>üìÑ Script SQL √† ex√©cuter</h3>
            <div class="mb-3">
                <button class="btn btn-outline-primary" onclick="copySQLScript()">Copier le script SQL</button>
                <button class="btn btn-outline-secondary" onclick="downloadSQLScript()">T√©l√©charger le fichier SQL</button>
            </div>
            <div class="bg-light p-3 rounded">
                <pre id="sql-script" style="max-height: 300px; overflow-y: auto; font-size: 0.8rem;"></pre>
            </div>
        </div>

        <!-- Logs d'ex√©cution -->
        <div class="card mb-4">
            <h3>üìã Logs d'ex√©cution</h3>
            <div class="d-flex justify-content-between align-items-center mb-3">
                <span>Journal des op√©rations</span>
                <button class="btn btn-sm btn-outline-secondary" onclick="clearLogs()">Effacer les logs</button>
            </div>
            <div id="execution-logs" class="log-container">
                <div class="log-entry log-info">Pr√™t √† ex√©cuter les mises √† jour...</div>
            </div>
        </div>

        <!-- R√©sultats -->
        <div class="card">
            <h3>üìä R√©sultats des Mises √† jour</h3>
            <div id="update-results">
                <div class="text-muted">Aucune mise √† jour ex√©cut√©e pour le moment.</div>
            </div>
        </div>
    </main>

    <script src="/update-tolerance-supabase.js"></script>
    <script>
        // Variables globales
        let executionLogs = [];
        let updateResults = null;

        // Initialisation
        document.addEventListener('DOMContentLoaded', function() {
            loadSQLScript();
        });

        // Charger le script SQL
        function loadSQLScript() {
            const sqlScript = `
-- Script SQL pour mettre √† jour les rayons de tol√©rance personnalis√©s
-- Zone PDA4 (Nord) - 11 Agents
UPDATE users SET tolerance_radius_meters = 20000, custom_tolerance_applied = true, tolerance_source = 'PDA4', tolerance_commune = 'DJOUGOU' WHERE LOWER(TRIM(CONCAT(first_name, ' ', last_name))) LIKE '%djibril%abdel%hafiz%';
UPDATE users SET tolerance_radius_meters = 17600, custom_tolerance_applied = true, tolerance_source = 'PDA4', tolerance_commune = 'DASSA-ZOUM√â' WHERE LOWER(TRIM(CONCAT(first_name, ' ', last_name))) LIKE '%goukalode%calixte%';
UPDATE users SET tolerance_radius_meters = 16000, custom_tolerance_applied = true, tolerance_source = 'PDA4', tolerance_commune = 'BASSILA' WHERE LOWER(TRIM(CONCAT(first_name, ' ', last_name))) LIKE '%ekpa%chabi%';
UPDATE users SET tolerance_radius_meters = 20000, custom_tolerance_applied = true, tolerance_source = 'PDA4', tolerance_commune = 'OUAK√â' WHERE LOWER(TRIM(CONCAT(first_name, ' ', last_name))) LIKE '%kaloa%moukimiou%';
UPDATE users SET tolerance_radius_meters = 24000, custom_tolerance_applied = true, tolerance_source = 'PDA4', tolerance_commune = 'SAVALOU' WHERE LOWER(TRIM(CONCAT(first_name, ' ', last_name))) LIKE '%cherif%fabade%';
UPDATE users SET tolerance_radius_meters = 12000, custom_tolerance_applied = true, tolerance_source = 'PDA4', tolerance_commune = 'BANT√à' WHERE LOWER(TRIM(CONCAT(first_name, ' ', last_name))) LIKE '%fado%kami%';
UPDATE users SET tolerance_radius_meters = 8000, custom_tolerance_applied = true, tolerance_source = 'PDA4', tolerance_commune = 'GLAZOUE' WHERE LOWER(TRIM(CONCAT(first_name, ' ', last_name))) LIKE '%tchetan%prudence%';
UPDATE users SET tolerance_radius_meters = 16800, custom_tolerance_applied = true, tolerance_source = 'PDA4', tolerance_commune = 'DASSA ZOUM√à' WHERE LOWER(TRIM(CONCAT(first_name, ' ', last_name))) LIKE '%akpo%anos%';
UPDATE users SET tolerance_radius_meters = 20000, custom_tolerance_applied = true, tolerance_source = 'PDA4', tolerance_commune = 'Glazou√©' WHERE LOWER(TRIM(CONCAT(first_name, ' ', last_name))) LIKE '%dagan%bruno%';
UPDATE users SET tolerance_radius_meters = 44000, custom_tolerance_applied = true, tolerance_source = 'PDA4', tolerance_commune = 'SAVALOU' WHERE LOWER(TRIM(CONCAT(first_name, ' ', last_name))) LIKE '%adoho%thiburce%';
UPDATE users SET tolerance_radius_meters = 17600, custom_tolerance_applied = true, tolerance_source = 'PDA4', tolerance_commune = 'BANT√â' WHERE LOWER(TRIM(CONCAT(first_name, ' ', last_name))) LIKE '%seriki%fatai%';

-- Zone SUD - 4 Agents
UPDATE users SET tolerance_radius_meters = 28000, custom_tolerance_applied = true, tolerance_source = 'SUD', tolerance_commune = 'Zogbodomey' WHERE LOWER(TRIM(CONCAT(first_name, ' ', last_name))) LIKE '%dagnito%mariano%';
UPDATE users SET tolerance_radius_meters = 28000, custom_tolerance_applied = true, tolerance_source = 'SUD', tolerance_commune = 'Zogbodomey' WHERE LOWER(TRIM(CONCAT(first_name, ' ', last_name))) LIKE '%gogan%ida%';
UPDATE users SET tolerance_radius_meters = 28000, custom_tolerance_applied = true, tolerance_source = 'SUD', tolerance_commune = 'Zogbodomey' WHERE LOWER(TRIM(CONCAT(first_name, ' ', last_name))) LIKE '%adjovi%sabeck%';
UPDATE users SET tolerance_radius_meters = 28000, custom_tolerance_applied = true, tolerance_source = 'SUD', tolerance_commune = 'Zogbodomey' WHERE LOWER(TRIM(CONCAT(first_name, ' ', last_name))) LIKE '%tognon%tchegnonsi%';

-- Agents sans d√©claration - Rayon par d√©faut (6km)
UPDATE users SET tolerance_radius_meters = 6000, custom_tolerance_applied = false, tolerance_source = 'default' WHERE custom_tolerance_applied IS NULL OR custom_tolerance_applied = false OR tolerance_radius_meters IS NULL;
            `;
            
            document.getElementById('sql-script').textContent = sqlScript.trim();
        }

        // Ajouter un log
        function addLog(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = {
                timestamp,
                message,
                type
            };
            
            executionLogs.push(logEntry);
            updateLogDisplay();
        }

        // Mettre √† jour l'affichage des logs
        function updateLogDisplay() {
            const container = document.getElementById('execution-logs');
            container.innerHTML = executionLogs.map(log => 
                `<div class="log-entry log-${log.type}">[${log.timestamp}] ${log.message}</div>`
            ).join('');
            
            // Scroll vers le bas
            container.scrollTop = container.scrollHeight;
        }

        // Effacer les logs
        function clearLogs() {
            executionLogs = [];
            updateLogDisplay();
        }

        // Ex√©cuter les mises √† jour personnalis√©es
        async function executeCustomUpdates() {
            addLog('üöÄ D√©but des mises √† jour personnalis√©es...', 'info');
            
            try {
                const results = await updateAllAgentTolerances();
                
                addLog(`‚úÖ Mises √† jour personnalis√©es termin√©es: ${results.success} succ√®s, ${results.failed} √©checs, ${results.notFound} non trouv√©s`, 'success');
                
                updateResults = results;
                displayResults();
            } catch (error) {
                addLog(`‚ùå Erreur lors des mises √† jour personnalis√©es: ${error.message}`, 'error');
            }
        }

        // Ex√©cuter les mises √† jour par d√©faut
        async function executeDefaultUpdates() {
            addLog('üîÑ D√©but des mises √† jour par d√©faut...', 'info');
            
            try {
                const results = await updateDefaultTolerance();
                
                if (results.success) {
                    addLog('‚úÖ Mises √† jour par d√©faut termin√©es avec succ√®s', 'success');
                } else {
                    addLog(`‚ùå Erreur lors des mises √† jour par d√©faut: ${results.error}`, 'error');
                }
            } catch (error) {
                addLog(`‚ùå Erreur lors des mises √† jour par d√©faut: ${error.message}`, 'error');
            }
        }

        // Ex√©cuter toutes les mises √† jour
        async function executeAllUpdates() {
            addLog('üöÄ D√©but de l\'ex√©cution compl√®te...', 'info');
            
            try {
                const results = await executeAllToleranceUpdates();
                
                addLog('üéâ Ex√©cution compl√®te termin√©e!', 'success');
                
                updateResults = results;
                displayResults();
            } catch (error) {
                addLog(`‚ùå Erreur lors de l'ex√©cution compl√®te: ${error.message}`, 'error');
            }
        }

        // Afficher les r√©sultats
        function displayResults() {
            if (!updateResults) return;
            
            const container = document.getElementById('update-results');
            
            let html = '<div class="row">';
            
            if (updateResults.customUpdates) {
                const custom = updateResults.customUpdates;
                html += `
                    <div class="col-md-6">
                        <div class="card update-card ${custom.failed > 0 ? 'error' : 'success'}">
                            <h5>Mises √† jour personnalis√©es</h5>
                            <p><strong>Succ√®s:</strong> ${custom.success}</p>
                            <p><strong>√âchecs:</strong> ${custom.failed}</p>
                            <p><strong>Non trouv√©s:</strong> ${custom.notFound}</p>
                        </div>
                    </div>
                `;
            }
            
            if (updateResults.defaultUpdates) {
                const default_ = updateResults.defaultUpdates;
                html += `
                    <div class="col-md-6">
                        <div class="card update-card ${default_.success ? 'success' : 'error'}">
                            <h5>Mises √† jour par d√©faut</h5>
                            <p><strong>Status:</strong> ${default_.success ? 'Succ√®s' : '√âchec'}</p>
                            ${default_.error ? `<p><strong>Erreur:</strong> ${default_.error}</p>` : ''}
                        </div>
                    </div>
                `;
            }
            
            html += '</div>';
            
            if (updateResults.customUpdates && updateResults.customUpdates.details) {
                html += '<div class="mt-4"><h5>D√©tails des mises √† jour:</h5>';
                html += '<div class="table-responsive"><table class="table table-sm">';
                html += '<thead><tr><th>Agent</th><th>Status</th><th>D√©tails</th></tr></thead><tbody>';
                
                updateResults.customUpdates.details.forEach(detail => {
                    const statusClass = detail.status === 'success' ? 'success' : 
                                      detail.status === 'failed' ? 'danger' : 'warning';
                    html += `<tr><td>${detail.agent}</td><td><span class="badge bg-${statusClass}">${detail.status}</span></td><td>${detail.message || detail.error || 'OK'}</td></tr>`;
                });
                
                html += '</tbody></table></div></div>';
            }
            
            container.innerHTML = html;
        }

        // Copier le script SQL
        function copySQLScript() {
            const sqlText = document.getElementById('sql-script').textContent;
            navigator.clipboard.writeText(sqlText).then(() => {
                addLog('üìã Script SQL copi√© dans le presse-papiers', 'success');
            }).catch(err => {
                addLog(`‚ùå Erreur lors de la copie: ${err.message}`, 'error');
            });
        }

        // T√©l√©charger le script SQL
        function downloadSQLScript() {
            const sqlText = document.getElementById('sql-script').textContent;
            const blob = new Blob([sqlText], { type: 'text/sql' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'update_agent_tolerance_radius.sql';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            addLog('üíæ Script SQL t√©l√©charg√©', 'success');
        }
    </script>
</body>
</html>
